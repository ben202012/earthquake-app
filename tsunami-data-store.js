/**
 * æ´¥æ³¢ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ»å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * å®Ÿç”¨æ©Ÿèƒ½å‘ä¸Šã®ãŸã‚ã®å®Ÿè£…
 */

class TsunamiDataStore {
    constructor() {
        this.config = {
            storagePrefix: 'tsunami_monitor_',
            maxHistoryEntries: 1000,
            maxStorageSize: 5 * 1024 * 1024, // 5MBï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã‚’è€ƒæ…®ã—ãŸé©æ­£å€¤ï¼‰
            compressionEnabled: true,
            autoCleanup: true,
            backupInterval: 3600000 // 1æ™‚é–“æ¯ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        };
        
        this.storage = {
            current: null,
            history: [],
            alerts: [],
            statistics: {},
            preferences: {}
        };
        
        this.initializeStorage();
    }
    
    /**
     * ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–
     */
    initializeStorage() {
        console.log('ğŸ’¾ æ´¥æ³¢ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–');
        
        try {
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            this.loadFromLocalStorage();
            
            // å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹
            this.startPeriodicBackup();
            
            console.log('âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
            
        } catch (error) {
            console.error('âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–å¤±æ•—:', error);
            this.initializeEmptyStorage();
        }
    }
    
    /**
     * ç©ºã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆæœŸåŒ–
     */
    initializeEmptyStorage() {
        this.storage = {
            current: null,
            history: [],
            alerts: [],
            statistics: {
                totalAlerts: 0,
                totalUpdates: 0,
                lastActivity: new Date().toISOString(),
                systemStartTime: new Date().toISOString()
            },
            preferences: {
                soundEnabled: true,
                notificationEnabled: true,
                autoArchive: true,
                alertThreshold: 'advisory'
            }
        };
        
        this.saveToLocalStorage();
    }
    
    /**
     * ç¾åœ¨ã®æ´¥æ³¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
     */
    saveCurrentTsunamiData(tsunamiData) {
        const timestamp = new Date().toISOString();
        
        const dataEntry = {
            id: this.generateId(),
            timestamp,
            data: tsunamiData,
            metadata: {
                source: tsunamiData.metadata?.source || 'unknown',
                activeRegions: tsunamiData.features?.length || 0,
                highestLevel: this.getHighestTsunamiLevel(tsunamiData),
                isEmergency: this.isEmergencyLevel(tsunamiData)
            }
        };
        
        // ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        this.storage.current = dataEntry;
        
        // å±¥æ­´ã«è¿½åŠ ï¼ˆé‡è¦ãªå¤‰åŒ–ã®ã¿ï¼‰
        if (this.shouldAddToHistory(dataEntry)) {
            this.addToHistory(dataEntry);
        }
        
        // çµ±è¨ˆæ›´æ–°
        this.updateStatistics(dataEntry);
        
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        this.saveToLocalStorage();
        
        console.log(`ğŸ’¾ æ´¥æ³¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: ${dataEntry.metadata.activeRegions}åœ°åŸŸ`);
        
        return dataEntry.id;
    }
    
    /**
     * å±¥æ­´è¿½åŠ åˆ¤å®š
     */
    shouldAddToHistory(newEntry) {
        if (!this.storage.current) return true;
        
        const current = this.storage.current;
        const newData = newEntry.data;
        const currentData = current.data;
        
        // çŠ¶æ…‹å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿å±¥æ­´ã«è¿½åŠ 
        return (
            newEntry.metadata.activeRegions !== current.metadata.activeRegions ||
            newEntry.metadata.highestLevel !== current.metadata.highestLevel ||
            newEntry.metadata.isEmergency !== current.metadata.isEmergency
        );
    }
    
    /**
     * å±¥æ­´ã«è¿½åŠ 
     */
    addToHistory(dataEntry) {
        this.storage.history.unshift(dataEntry);
        
        // æœ€å¤§å±¥æ­´æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        if (this.storage.history.length > this.config.maxHistoryEntries) {
            const removed = this.storage.history.splice(this.config.maxHistoryEntries);
            console.log(`ğŸ—‘ï¸ å¤ã„å±¥æ­´ ${removed.length} ä»¶ã‚’å‰Šé™¤`);
        }
    }
    
    /**
     * ã‚¢ãƒ©ãƒ¼ãƒˆè¨˜éŒ²
     */
    recordAlert(alertData) {
        const alertEntry = {
            id: this.generateId(),
            timestamp: new Date().toISOString(),
            type: alertData.type, // 'warning', 'advisory', 'cleared'
            level: alertData.level,
            regions: alertData.regions || [],
            message: alertData.message,
            acknowledged: false,
            autoGenerated: true
        };
        
        this.storage.alerts.unshift(alertEntry);
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆçµ±è¨ˆæ›´æ–°
        this.storage.statistics.totalAlerts++;
        
        // æœ€å¤§1000ä»¶ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä¿æŒ
        if (this.storage.alerts.length > 1000) {
            this.storage.alerts.splice(1000);
        }
        
        this.saveToLocalStorage();
        
        console.log(`ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆè¨˜éŒ²: ${alertEntry.type} - ${alertEntry.message}`);
        
        return alertEntry.id;
    }
    
    /**
     * å±¥æ­´å–å¾—
     */
    getHistory(options = {}) {
        const {
            limit = 50,
            startDate = null,
            endDate = null,
            levelFilter = null,
            emergencyOnly = false
        } = options;
        
        let filtered = [...this.storage.history];
        
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (startDate) {
            filtered = filtered.filter(entry => new Date(entry.timestamp) >= new Date(startDate));
        }
        
        if (endDate) {
            filtered = filtered.filter(entry => new Date(entry.timestamp) <= new Date(endDate));
        }
        
        // ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (levelFilter) {
            filtered = filtered.filter(entry => entry.metadata.highestLevel === levelFilter);
        }
        
        // ç·Šæ€¥æ™‚ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (emergencyOnly) {
            filtered = filtered.filter(entry => entry.metadata.isEmergency);
        }
        
        return filtered.slice(0, limit);
    }
    
    /**
     * ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´å–å¾—
     */
    getAlerts(options = {}) {
        const {
            limit = 100,
            unacknowledgedOnly = false,
            type = null
        } = options;
        
        let filtered = [...this.storage.alerts];
        
        if (unacknowledgedOnly) {
            filtered = filtered.filter(alert => !alert.acknowledged);
        }
        
        if (type) {
            filtered = filtered.filter(alert => alert.type === type);
        }
        
        return filtered.slice(0, limit);
    }
    
    /**
     * ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèªæ¸ˆã¿ãƒãƒ¼ã‚¯
     */
    acknowledgeAlert(alertId) {
        const alert = this.storage.alerts.find(a => a.id === alertId);
        if (alert) {
            alert.acknowledged = true;
            alert.acknowledgedAt = new Date().toISOString();
            this.saveToLocalStorage();
            
            console.log(`âœ… ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª: ${alertId}`);
            return true;
        }
        return false;
    }
    
    /**
     * çµ±è¨ˆæƒ…å ±æ›´æ–°
     */
    updateStatistics(dataEntry) {
        this.storage.statistics.totalUpdates++;
        this.storage.statistics.lastActivity = dataEntry.timestamp;
        
        // æ™‚é–“åˆ¥çµ±è¨ˆ
        const hour = new Date(dataEntry.timestamp).getHours();
        if (!this.storage.statistics.hourlyActivity) {
            this.storage.statistics.hourlyActivity = {};
        }
        this.storage.statistics.hourlyActivity[hour] = (this.storage.statistics.hourlyActivity[hour] || 0) + 1;
        
        // ãƒ¬ãƒ™ãƒ«åˆ¥çµ±è¨ˆ
        if (!this.storage.statistics.levelCounts) {
            this.storage.statistics.levelCounts = {};
        }
        const level = dataEntry.metadata.highestLevel;
        if (level) {
            this.storage.statistics.levelCounts[level] = (this.storage.statistics.levelCounts[level] || 0) + 1;
        }
    }
    
    /**
     * æœ€é«˜æ´¥æ³¢ãƒ¬ãƒ™ãƒ«å–å¾—
     */
    getHighestTsunamiLevel(tsunamiData) {
        if (!tsunamiData.features || tsunamiData.features.length === 0) {
            return 'none';
        }
        
        const levelPriority = {
            'major_warning': 4,
            'warning': 3,
            'advisory': 2,
            'forecast': 1,
            'cleared': 0,
            'none': 0
        };
        
        let highestLevel = 'none';
        let highestPriority = -1;
        
        tsunamiData.features.forEach(feature => {
            const level = feature.properties.STATUS;
            const priority = levelPriority[level] || 0;
            
            if (priority > highestPriority) {
                highestLevel = level;
                highestPriority = priority;
            }
        });
        
        return highestLevel;
    }
    
    /**
     * ç·Šæ€¥ãƒ¬ãƒ™ãƒ«åˆ¤å®š
     */
    isEmergencyLevel(tsunamiData) {
        const highestLevel = this.getHighestTsunamiLevel(tsunamiData);
        return ['major_warning', 'warning'].includes(highestLevel);
    }
    
    /**
     * LocalStorageã«ä¿å­˜
     */
    saveToLocalStorage() {
        try {
            const serialized = JSON.stringify(this.storage);
            
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (serialized.length > this.config.maxStorageSize) {
                console.warn('âš ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºä¸Šé™ã«åˆ°é” - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ');
                this.performCleanup();
                return this.saveToLocalStorage(); // å†è©¦è¡Œ
            }
            
            localStorage.setItem(this.config.storagePrefix + 'data', serialized);
            localStorage.setItem(this.config.storagePrefix + 'lastSave', new Date().toISOString());
            
        } catch (error) {
            console.error('âŒ LocalStorageä¿å­˜å¤±æ•—:', error);
            
            if (error.name === 'QuotaExceededError') {
                console.log('ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ä¸è¶³ - ç·Šæ€¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ');
                this.emergencyCleanup();
            }
        }
    }
    
    /**
     * LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
     */
    loadFromLocalStorage() {
        try {
            const data = localStorage.getItem(this.config.storagePrefix + 'data');
            
            if (data) {
                this.storage = JSON.parse(data);
                console.log(`ğŸ“– ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ ${this.storage.history.length} ä»¶ã®å±¥æ­´ã‚’èª­ã¿è¾¼ã¿`);
            } else {
                this.initializeEmptyStorage();
            }
            
        } catch (error) {
            console.error('âŒ LocalStorageèª­ã¿è¾¼ã¿å¤±æ•—:', error);
            this.initializeEmptyStorage();
        }
    }
    
    /**
     * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
     */
    performCleanup() {
        // å¤ã„å±¥æ­´ã‚’å‰Šé™¤
        const oldHistoryCount = this.storage.history.length;
        this.storage.history = this.storage.history.slice(0, Math.floor(this.config.maxHistoryEntries * 0.7));
        
        // å¤ã„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
        const oldAlertCount = this.storage.alerts.length;
        this.storage.alerts = this.storage.alerts.slice(0, 500);
        
        console.log(`ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: å±¥æ­´ ${oldHistoryCount - this.storage.history.length} ä»¶ã€ã‚¢ãƒ©ãƒ¼ãƒˆ ${oldAlertCount - this.storage.alerts.length} ä»¶ã‚’å‰Šé™¤`);
    }
    
    /**
     * ç·Šæ€¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
     */
    emergencyCleanup() {
        // å±¥æ­´ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å¤§å¹…å‰Šæ¸›
        this.storage.history = this.storage.history.slice(0, 100);
        this.storage.alerts = this.storage.alerts.slice(0, 50);
        
        // æ™‚é–“åˆ¥çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
        delete this.storage.statistics.hourlyActivity;
        
        console.log('ğŸš¨ ç·Šæ€¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
    }
    
    /**
     * å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹
     */
    startPeriodicBackup() {
        setInterval(() => {
            this.createBackup();
        }, this.config.backupInterval);
    }
    
    /**
     * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
     */
    createBackup() {
        try {
            const backup = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: this.storage
            };
            
            const compressed = JSON.stringify(backup);
            localStorage.setItem(this.config.storagePrefix + 'backup', compressed);
            
            console.log('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†');
            
        } catch (error) {
            console.error('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå¤±æ•—:', error);
        }
    }
    
    /**
     * çµ±è¨ˆæƒ…å ±å–å¾—
     */
    getStatistics() {
        return {
            ...this.storage.statistics,
            historyCount: this.storage.history.length,
            alertCount: this.storage.alerts.length,
            unacknowledgedAlerts: this.storage.alerts.filter(a => !a.acknowledged).length,
            storageSize: JSON.stringify(this.storage).length
        };
    }
    
    /**
     * è¨­å®šæ›´æ–°
     */
    updatePreferences(newPreferences) {
        this.storage.preferences = { ...this.storage.preferences, ...newPreferences };
        this.saveToLocalStorage();
        
        console.log('âš™ï¸ è¨­å®šæ›´æ–°å®Œäº†');
    }
    
    /**
     * è¨­å®šå–å¾—
     */
    getPreferences() {
        return { ...this.storage.preferences };
    }
    
    /**
     * ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
     */
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    /**
     * ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
     */
    exportData(format = 'json') {
        const exportData = {
            exportTime: new Date().toISOString(),
            version: '1.0',
            format,
            data: this.storage
        };
        
        if (format === 'json') {
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `tsunami_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
        }
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
     */
    clearAllData() {
        const confirmed = confirm('å…¨ã¦ã®æ´¥æ³¢ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚');
        
        if (confirmed) {
            localStorage.removeItem(this.config.storagePrefix + 'data');
            localStorage.removeItem(this.config.storagePrefix + 'backup');
            localStorage.removeItem(this.config.storagePrefix + 'lastSave');
            
            this.initializeEmptyStorage();
            
            console.log('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
            return true;
        }
        
        return false;
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
if (typeof window !== 'undefined') {
    window.TsunamiDataStore = TsunamiDataStore;
}

// Node.jsç’°å¢ƒå¯¾å¿œ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = TsunamiDataStore;
}

console.log('ğŸ’¾ æ´¥æ³¢ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');