<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É† - Professional Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        /* === „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É† CSS === */
        
        /* „É™„Çª„ÉÉ„Éà & Âü∫Êú¨Ë®≠ÂÆö */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0c1623 0%, #1a2332 100%);
            color: #ffffff;
            overflow: hidden;
        }
        
        /* === „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà === */
        .earthquake-dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            grid-template-rows: 70px 1fr;
            grid-template-areas: 
                "header header header"
                "sidebar main rightpanel";
            height: 100vh;
            gap: 1px;
            background: #0a0f1a;
        }
        
        /* === „Éò„ÉÉ„ÉÄ„Éº === */
        .main-header {
            grid-area: header;
            background: linear-gradient(90deg, #1e2a38 0%, #2d3748 100%);
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .app-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #2ed573;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .current-time {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        /* === „Çµ„Ç§„Éâ„Éê„Éº === */
        .left-sidebar {
            grid-area: sidebar;
            background: linear-gradient(180deg, #1a2332 0%, #2d3748 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            font-size: 18px;
        }
        
        /* EEW „Çπ„ÉÜ„Éº„Çø„Çπ */
        .eew-status {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .eew-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .eew-text {
            font-size: 14px;
            color: #ff9ff3;
        }
        
        /* Áµ±Ë®àÊÉÖÂ†± */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #4a9eff;
            font-family: 'SF Mono', monospace;
        }
        
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        /* ÊúÄÊñ∞Âú∞Èúá„É™„Çπ„Éà */
        .earthquake-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .earthquake-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .earthquake-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }
        
        .earthquake-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .magnitude {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .intensity {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .earthquake-location {
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }
        
        .earthquake-time {
            font-size: 12px;
            color: #94a3b8;
            font-family: 'SF Mono', monospace;
        }
        
        /* === „É°„Ç§„É≥Âú∞Âõ≥„Ç®„É™„Ç¢ === */
        .main-content {
            grid-area: main;
            background: #0f1419;
            position: relative;
            overflow: hidden;
        }
        
        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #earthquake-map {
            width: 100%;
            height: 100%;
            background: #0f1419;
        }
        
        .map-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(45, 55, 72, 0.92);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .overlay-title {
            font-size: 16px;
            font-weight: 600;
            color: #74b9ff;
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .coordinate-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .coord-item {
            text-align: center;
        }
        
        .coord-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        
        .coord-value {
            font-size: 14px;
            font-weight: 600;
            color: #f7fafc;
            font-family: 'SF Mono', monospace;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* === Âè≥„Éë„Éç„É´ === */
        .right-panel {
            grid-area: rightpanel;
            background: linear-gradient(180deg, #1a2332 0%, #2d3748 100%);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            animation: live-pulse 2s infinite;
        }
        
        @keyframes live-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .monitoring-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .monitoring-section {
            margin-bottom: 24px;
        }
        
        .monitoring-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 12px;
        }
        
        .real-time-clock {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .clock-display {
            font-size: 24px;
            font-weight: 700;
            color: #4a9eff;
            font-family: 'SF Mono', monospace;
        }
        
        .clock-date {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'SF Mono', monospace;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .activity-feed {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .feed-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .feed-item:last-child {
            border-bottom: none;
        }
        
        .feed-icon {
            font-size: 16px;
        }
        
        .feed-content {
            flex: 1;
        }
        
        .feed-text {
            font-size: 13px;
            color: #ffffff;
            line-height: 1.4;
        }
        
        .feed-time {
            font-size: 11px;
            color: #94a3b8;
            font-family: 'SF Mono', monospace;
        }
        
        /* ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†±„Éë„Éç„É´ */
        .earthquake-info-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        
        /* === „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº === */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-radius: 3px;
        }
        
        /* === „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú === */
        @media (max-width: 1200px) {
            .earthquake-dashboard {
                grid-template-columns: 300px 1fr 350px;
            }
        }
        
        @media (max-width: 768px) {
            .earthquake-dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 70px 1fr;
                grid-template-areas: 
                    "header"
                    "main";
            }
            
            .left-sidebar,
            .right-panel {
                display: none;
            }
        }
        
        /* === „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ === */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === ÈúáÂ∫¶ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó === */
        .intensity-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 42, 56, 0.98);
            border: 2px solid rgba(74, 158, 255, 0.4);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            max-height: 600px;
            overflow-y: auto;
            z-index: 10000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease-out;
        }
        
        @keyframes popupSlideIn {
            from { 
                opacity: 0; 
                transform: translate(-50%, -60%) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .popup-title {
            font-size: 18px;
            font-weight: 700;
            color: #74b9ff;
            margin: 0;
        }
        
        .popup-close {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .popup-close:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(1.1);
        }
        
        .earthquake-summary {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #f7fafc;
            font-family: 'SF Mono', monospace;
        }
        
        .intensity-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .intensity-section {
            margin-bottom: 16px;
        }
        
        .intensity-header {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .intensity-regions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
            margin-left: 12px;
        }
        
        .region-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .region-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeInOverlay 0.3s ease-out;
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* === Ë®≠ÂÆö„Éë„Éç„É´ === */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 42, 56, 0.98);
            border: 2px solid rgba(74, 158, 255, 0.4);
            border-radius: 16px;
            padding: 24px;
            width: 600px;
            max-width: 90vw;
            max-height: 700px;
            overflow-y: auto;
            z-index: 10000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease-out;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: 700;
            color: #74b9ff;
            margin: 0;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .settings-section-title:hover {
            color: #74b9ff;
            transform: translateX(2px);
        }
        
        .activity-feed-settings {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .map-layers-settings {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .layer-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .layer-option.active {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-color: rgba(74, 158, 255, 0.5);
            color: white;
        }
        
        .layer-option-name {
            font-size: 14px;
            font-weight: 500;
            min-width: 160px;
            flex: 1;
        }
        
        .layer-option-status {
            font-size: 12px;
            color: #74b9ff;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
            white-space: nowrap;
        }
        
        .layer-option.active .layer-option-status {
            color: white;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* === „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã === */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(74, 158, 255, 0.3);
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #94a3b8;
            font-size: 14px;
        }
        
        /* Leaflet „Éû„ÉÉ„Éó„Çπ„Çø„Ç§„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .leaflet-container {
            background: #0f1419;
            border-radius: 8px;
        }
        
        /* „Ç∫„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Åø„Å´filter„ÇíÈÅ©Áî® */
        .leaflet-control-zoom {
            filter: invert(1) hue-rotate(180deg);
        }
        
        /* „É¨„Ç§„É§„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Çπ„Çø„Ç§„É´ - Á¢∫ÂÆü„Å™ÂèØË¶ñÊÄß */
        .leaflet-control-layers {
            background: rgba(30, 42, 56, 0.95) !important;
            color: white !important;
            border: 1px solid rgba(74, 158, 255, 0.3) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            min-width: 180px !important;
            padding: 8px !important;
        }
        
        .leaflet-control-layers-expanded {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .leaflet-control-layers-list {
            color: white !important;
            padding: 8px 0 !important;
        }
        
        .leaflet-control-layers-toggle {
            background-image: none !important;
            background-color: rgba(74, 158, 255, 0.9) !important;
            border-radius: 6px !important;
            width: 36px !important;
            height: 36px !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            position: relative !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .leaflet-control-layers-toggle::before {
            content: 'üó∫Ô∏è';
            color: white !important;
            font-size: 16px !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            line-height: 1 !important;
            z-index: 2001 !important;
            pointer-events: none !important;
        }
        
        .leaflet-control-layers-toggle:hover {
            background-color: rgba(74, 158, 255, 1) !important;
            transform: scale(1.05) !important;
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(15, 20, 25, 0.95);
            color: white;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .leaflet-popup-tip {
            background: rgba(15, 20, 25, 0.95);
        }
        
        .japan-region-tooltip {
            background: rgba(74, 158, 255, 0.9) !important;
            color: white !important;
            border: 1px solid rgba(74, 158, 255, 0.5) !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 4px 8px !important;
        }
        
        /* Âú∞Èúá„Éû„Éº„Ç´„Éº„ÅÆÂº∑Ë™ø */
        .earthquake-marker {
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        
        /* „Éä„Ç§„Éà„É¢„Éº„Éâ„É¨„Ç§„É§„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .night-mode-layer {
            filter: brightness(0.7) contrast(1.2) saturate(0.8);
        }
        
        /* „É¨„Ç§„É§„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Çπ„Çø„Ç§„É´ÊîπÂñÑ */
        .leaflet-control-layers-list {
            color: white !important;
        }
        
        .leaflet-control-layers-base label {
            color: white !important;
            font-weight: 500 !important;
        }
        
        .leaflet-control-layers-base input[type="radio"] {
            accent-color: #4a9eff !important;
        }
        /* === Ë®≠ÂÆö„Éë„Éç„É´„Çπ„Çø„Ç§„É´ === */
        .setting-item {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #74b9ff;
            margin-bottom: 8px;
        }

        .setting-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-input-group input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #74b9ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .setting-input-group select {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
        }

        .setting-input-group select option {
            background: #2d3748;
            color: #ffffff;
        }

        .setting-value {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #74b9ff;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #74b9ff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .test-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.3);
        }

        /* === „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´ === */
        .home-control {
            transition: all 0.3s ease !important;
        }

        .home-control:hover {
            background-color: rgba(74, 158, 255, 1) !important;
            transform: scale(1.1) !important;
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.5) !important;
        }

        .home-control:active {
            transform: scale(0.95) !important;
        }
    </style>
</head>
<body>
    <div class="earthquake-dashboard">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="main-header">
            <div class="header-left">
                <div class="app-logo">üåè</div>
                <h1 class="app-title">Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†</h1>
            </div>
            
            <div class="header-center">
                <div class="connection-status">
                    <div class="status-indicator">
                        <div class="status-dot" id="p2p-status"></div>
                        P2PÊé•Á∂ö
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot" id="api-status"></div>
                        APIÊé•Á∂ö
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="current-time" id="current-time">--:--:--</div>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>
        </header>
        
        <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„Éº -->
        <aside class="left-sidebar">
            <!-- EEW „Çπ„ÉÜ„Éº„Çø„Çπ -->
            <div class="sidebar-section">
                <div class="section-title">
                    <span class="section-icon">‚ö°</span>
                    Á∑äÊÄ•Âú∞ÈúáÈÄüÂ†±
                </div>
                <div class="eew-status">
                    <div class="eew-icon">üì°</div>
                    <div class="eew-text" id="eew-status">Áô∫‰ø°„Å™„Åó</div>
                </div>
            </div>
            
            <!-- Áµ±Ë®àÊÉÖÂ†± -->
            <div class="sidebar-section">
                <div class="section-title">
                    <span class="section-icon">üìä</span>
                    Áõ£Ë¶ñÁµ±Ë®à
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="today-count">0</div>
                        <div class="stat-label">‰ªäÊó•„ÅÆÂú∞Èúá</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="week-count">0</div>
                        <div class="stat-label">‰ªäÈÄ±„ÅÆÂú∞Èúá</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="max-intensity">-</div>
                        <div class="stat-label">ÊúÄÂ§ßÈúáÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="response-time">0ms</div>
                        <div class="stat-label">ÂøúÁ≠îÊôÇÈñì</div>
                    </div>
                </div>
            </div>
            
            <!-- ÊúÄÊñ∞Âú∞Èúá„É™„Çπ„Éà -->
            <div class="earthquake-list">
                <div class="section-title">
                    <span class="section-icon">üî¥</span>
                    ÊúÄÊñ∞Âú∞ÈúáÊÉÖÂ†±
                </div>
                <div id="earthquake-history">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- „É°„Ç§„É≥Âú∞Âõ≥„Ç®„É™„Ç¢ -->
        <main class="main-content">
            <div class="map-container">
                <div id="earthquake-map"></div>
            </div>
        </main>
        
        <!-- Âè≥„Éë„Éç„É´ -->
        <aside class="right-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    üì° „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
                    <span class="live-indicator">LIVE</span>
                </h2>
            </div>
            
            <div class="monitoring-panel">
                <!-- „É™„Ç¢„É´„Çø„Ç§„É†ÊôÇË®à -->
                <div class="monitoring-section">
                    <div class="monitoring-title">„Ç∑„Çπ„ÉÜ„É†ÊôÇÂàª</div>
                    <div class="real-time-clock">
                        <div class="clock-display" id="system-clock">--:--:--</div>
                        <div class="clock-date" id="system-date">----/--/--</div>
                    </div>
                </div>
                
                <!-- „É°„Éà„É™„ÇØ„Çπ -->
                <div class="monitoring-section">
                    <div class="monitoring-title">„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="uptime">00:00:00</div>
                            <div class="metric-label">Á®ºÂÉçÊôÇÈñì</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="data-packets">0</div>
                            <div class="metric-label">Âèó‰ø°„Éá„Éº„Çø</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="memory-usage">0MB</div>
                            <div class="metric-label">„É°„É¢„É™‰ΩøÁî®Èáè</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="active-regions">0</div>
                            <div class="metric-label">Ê¥ªÁô∫Âú∞Âüü</div>
                        </div>
                    </div>
                </div>
                
                <!-- ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†± -->
                <div class="monitoring-section">
                    <div class="monitoring-title">üìç ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†±</div>
                    <div class="earthquake-info-panel">
                        <div class="coordinate-info">
                            <div class="coord-item">
                                <div class="coord-label">ÂåóÁ∑Ø</div>
                                <div class="coord-value" id="latitude">---.---¬∞</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">Êù±Áµå</div>
                                <div class="coord-value" id="longitude">---.---¬∞</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">Ê∑±„Åï</div>
                                <div class="coord-value" id="depth">-- km</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„Éâ</div>
                                <div class="coord-value" id="magnitude">M-.-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="config.js"></script>
    <script>
        // „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†
        class ProfessionalEarthquakeMonitor {
            constructor() {
                this.startTime = new Date();
                this.earthquakeHistory = [];
                this.stats = {
                    todayCount: 0,
                    weekCount: 0,
                    maxIntensity: '-',
                    dataPackets: 0,
                    responseTime: 0
                };
                this.map = null;
                this.websocket = null;
                
                // Ë®≠ÂÆö„Éá„Éº„Çø
                this.settings = this.loadSettings();
                
                // Âú∞Âõ≥Áä∂ÊÖãÁÆ°ÁêÜ
                this.mapState = {
                    initialView: { center: [36.2, 138.2], zoom: 5 },
                    isAtInitialView: true,
                    homeControl: null
                };
                
                this.init();
            }

            async init() {
                console.log('üåè Professional Earthquake Monitor v2.0 - Starting...');
                
                try {
                    // DOMË¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                    const requiredElements = [
                        'current-time', 'system-clock', 'system-date', 'uptime',
                        'latitude', 'longitude', 'depth', 'magnitude'
                    ];
                    
                    const missingElements = requiredElements.filter(id => !document.getElementById(id));
                    if (missingElements.length > 0) {
                        console.warn(`‚ö†Ô∏è Missing DOM elements: ${missingElements.join(', ')}`);
                    }
                    
                    // Âü∫Êú¨„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÔºà‰∏¶ÂàóÂÆüË°å„ÅßÈ´òÈÄüÂåñÔºâ
                    await Promise.all([
                        this.setupClockAsync(),
                        this.setupMapAsync(),
                        this.startPerformanceMonitoringAsync()
                    ]);
                    
                    // Êé•Á∂öÁä∂ÊÖã„ÇíË°®Á§∫
                    this.updateConnectionStatus('p2p-status', false);
                    this.updateConnectionStatus('api-status', false);
                    
                    // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßã„Çí„É≠„Ç∞
                    this.addActivityFeedItem('üü¢', '„Ç∑„Çπ„ÉÜ„É†„ÅåÈ´òÈÄü„É¢„Éº„Éâ„ÅßÈñãÂßã„Åï„Çå„Åæ„Åó„Åü', new Date());
                    
                    // ÈùûÂêåÊúü„Åß„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å®WebSocketÊé•Á∂ö
                    Promise.all([
                        this.loadHistoricalData(),
                        this.connectWebSocketAsync()
                    ]).then(() => {
                        console.log('‚úÖ All background tasks completed');
                        this.updateConnectionStatus('api-status', true);
                    }).catch(error => {
                        console.warn('‚ö†Ô∏è Some background tasks failed:', error);
                        this.updateConnectionStatus('api-status', false);
                    });
                    
                    console.log('‚úÖ Professional Earthquake Monitor initialized successfully');
                } catch (error) {
                    console.error('‚ùå Failed to initialize system:', error);
                    this.addActivityFeedItem('‚ùå', `ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, new Date());
                }
            }
            
            async setupClockAsync() {
                return new Promise(resolve => {
                    this.setupClock();
                    resolve();
                });
            }
            
            async setupMapAsync() {
                return new Promise(resolve => {
                    this.setupMap();
                    resolve();
                });
            }
            
            async startPerformanceMonitoringAsync() {
                return new Promise(resolve => {
                    this.startPerformanceMonitoring();
                    resolve();
                });
            }
            
            async connectWebSocketAsync() {
                return new Promise((resolve, reject) => {
                    try {
                        this.connectWebSocket();
                        setTimeout(resolve, 1000); // 1Áßí„ÅßÊé•Á∂öÁ¢∫Á´ã„Å®‰ªÆÂÆö
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            setupClock() {
                const updateClock = () => {
                    const now = new Date();
                    
                    // „Éò„ÉÉ„ÉÄ„ÉºÊôÇË®à
                    const currentTimeEl = document.getElementById('current-time');
                    if (currentTimeEl) {
                        currentTimeEl.textContent = now.toLocaleTimeString('ja-JP', { hour12: false });
                    }
                    
                    // „Ç∑„Çπ„ÉÜ„É†ÊôÇË®à
                    const systemClockEl = document.getElementById('system-clock');
                    if (systemClockEl) {
                        systemClockEl.textContent = now.toLocaleTimeString('ja-JP', { hour12: false });
                    }
                    
                    const systemDateEl = document.getElementById('system-date');
                    if (systemDateEl) {
                        systemDateEl.textContent = now.toLocaleDateString('ja-JP');
                    }
                    
                    // Á®ºÂÉçÊôÇÈñì
                    const uptimeEl = document.getElementById('uptime');
                    if (uptimeEl) {
                        const uptime = new Date(now - this.startTime);
                        const hours = String(Math.floor(uptime / 3600000)).padStart(2, '0');
                        const minutes = String(Math.floor((uptime % 3600000) / 60000)).padStart(2, '0');
                        const seconds = String(Math.floor((uptime % 60000) / 1000)).padStart(2, '0');
                        uptimeEl.textContent = `${hours}:${minutes}:${seconds}`;
                    }
                };
                
                updateClock();
                setInterval(updateClock, 1000);
                
                // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßãÊôÇÂàª„ÇíË®òÈå≤
                const systemStartTimeEl = document.getElementById('system-start-time');
                if (systemStartTimeEl) {
                    systemStartTimeEl.textContent = this.startTime.toLocaleTimeString('ja-JP');
                }
            }

            setupMap() {
                this.map = L.map('earthquake-map', {
                    center: [36.2, 138.2],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });

                // Ë§áÊï∞„ÅÆÂú∞Âõ≥„É¨„Ç§„É§„Éº„ÇíÂÆöÁæ©ÔºàÊòéÂ∫¶Ë™øÊï¥Ê∏à„ÅøÔºâ
                const mapLayers = {
                    '„ÉÄ„Éº„ÇØÔºàÊòé„Çã„ÇÅÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4
                    }),
                    '„Ç∞„É¨„ÉºÔºà‰∏≠ÈñìË™øÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4,
                        opacity: 0.8
                    }),
                    '„ÉÄ„Éº„ÇØÔºàÊ®ôÊ∫ñÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4
                    }),
                    '„ÉÄ„Éº„ÇØÔºà„É©„Éô„É´‰ªò„ÅçÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4
                    }),
                    '„Éä„Ç§„Éà„É¢„Éº„Éâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO (Night Mode)',
                        maxZoom: 18,
                        minZoom: 4,
                        className: 'night-mode-layer'
                    })
                };

                // „Éá„Éï„Ç©„É´„Éà„É¨„Ç§„É§„ÉºÔºàÊòé„Çã„ÇÅ„ÉÄ„Éº„ÇØÔºâ„ÇíË®≠ÂÆö
                const defaultLayer = mapLayers['„ÉÄ„Éº„ÇØÔºàÊòé„Çã„ÇÅÔºâ'];
                defaultLayer.addTo(this.map);

                // Âú∞Âõ≥„É¨„Ç§„É§„Éº„Çí‰øùÂ≠òÔºàË®≠ÂÆö„Éë„Éç„É´„Åß‰ΩøÁî®Ôºâ
                this.mapLayers = mapLayers;
                this.currentLayer = defaultLayer;
                this.currentLayerName = '„ÉÄ„Éº„ÇØÔºàÊòé„Çã„ÇÅÔºâ';
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Åß„É¨„Ç§„É§„ÉºÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                this.map.on('baselayerchange', (e) => {
                    this.currentLayerName = e.name;
                    console.log(`üó∫Ô∏è Map layer changed to: "${e.name}"`);
                    this.addActivityFeedItem('üó∫Ô∏è', `Âú∞Âõ≥„É¨„Ç§„É§„Éº„Çí${e.name}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, new Date());
                    
                    // Ë®≠ÂÆö„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØUI„ÇíÊõ¥Êñ∞
                    const layersContainer = document.getElementById('settings-map-layers');
                    if (layersContainer && layersContainer.style.display !== 'none') {
                        this.updateMapLayerOptions();
                    }
                });

                // „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ÔºàÊó•Êú¨ÂàóÂ≥∂„ÇíÂº∑Ë™øÔºâ
                this.addJapanOverlay();
                
                // „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
                this.addHomeControl();
                
                // Âú∞Âõ≥ÁßªÂãï„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
                this.setupMapEventListeners();

                console.log('üó∫Ô∏è Map initialized with enhanced visibility for Japan');
            }

            addJapanOverlay() {
                // Êó•Êú¨ÂàóÂ≥∂„ÅÆÂ¢ÉÁïåÁ∑ö„ÇíÂº∑Ë™ø„Åô„Çã„Çπ„Çø„Ç§„É´
                const japanStyle = {
                    color: '#4a9eff',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: 'transparent',
                    fillOpacity: 0
                };

                // Á∞°Áï•Âåñ„Åï„Çå„ÅüÊó•Êú¨ÂàóÂ≥∂„ÅÆÂ¢ÉÁïåÔºà‰∏ªË¶Å4Â≥∂Ôºâ
                const japanBounds = [
                    // Êú¨Â∑û„Åä„Åä„Çà„Åù„ÅÆÂ¢ÉÁïå
                    [
                        [35.7, 139.7], // Êù±‰∫¨
                        [34.7, 135.5], // Â§ßÈò™
                        [33.6, 130.4], // Á¶èÂ≤°
                        [38.3, 140.9], // ‰ªôÂè∞
                        [43.1, 141.3], // Êú≠Âπå
                        [35.7, 139.7]  // Êàª„Çä
                    ]
                ];

                // Êó•Êú¨ÂàóÂ≥∂„ÅÆÂ§ß„Åæ„Åã„Å™„Ç®„É™„Ç¢„ÇíÂÜÜ„ÅßË°®Á§∫
                const japanCircles = [
                    { center: [35.676, 139.650], radius: 50000, name: 'Èñ¢Êù±' },
                    { center: [34.693, 135.502], radius: 40000, name: 'Èñ¢Ë•ø' },
                    { center: [35.011, 135.768], radius: 30000, name: '‰∏≠ÈÉ®' },
                    { center: [33.584, 130.401], radius: 35000, name: '‰πùÂ∑û' },
                    { center: [43.064, 141.347], radius: 45000, name: 'ÂåóÊµ∑ÈÅì' },
                    { center: [38.268, 140.872], radius: 30000, name: 'Êù±Âåó' }
                ];

                japanCircles.forEach(region => {
                    L.circle(region.center, {
                        radius: region.radius,
                        color: '#4a9eff',
                        weight: 1,
                        opacity: 0.3,
                        fillColor: '#4a9eff',
                        fillOpacity: 0.05
                    }).addTo(this.map).bindTooltip(region.name, { 
                        permanent: false, 
                        direction: 'center',
                        className: 'japan-region-tooltip'
                    });
                });
            }

            // „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
            addHomeControl() {
                // Leaflet„Ç´„Çπ„Çø„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÇØ„É©„Çπ
                const HomeControl = L.Control.extend({
                    onAdd: (map) => {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom home-control');
                        
                        container.style.backgroundColor = 'rgba(74, 158, 255, 0.9)';
                        container.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDIwVjE0SDEzLjU4NTlWMjBIMTlWMTJIMjJMMTIgM0wyIDEySDE5VjIwSDEwWiIgZmlsbD0id2hpdGUiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo=')";
                        container.style.backgroundSize = '16px 16px';
                        container.style.backgroundRepeat = 'no-repeat';
                        container.style.backgroundPosition = 'center';
                        container.style.width = '30px';
                        container.style.height = '30px';
                        container.style.cursor = 'pointer';
                        container.style.border = '2px solid rgba(255, 255, 255, 0.8)';
                        container.style.borderRadius = '4px';
                        container.style.boxShadow = '0 1px 5px rgba(0,0,0,0.65)';
                        container.style.display = 'none'; // ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÈùûË°®Á§∫
                        container.title = 'ÂàùÊúüÁîªÈù¢„Å´Êàª„Çã';
                        
                        container.onclick = () => {
                            this.returnToHome();
                        };
                        
                        L.DomEvent.disableClickPropagation(container);
                        return container;
                    },
                    
                    onRemove: (map) => {
                        // cleanup
                    }
                });
                
                // „Éõ„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíÂú∞Âõ≥„Å´ËøΩÂä†ÔºàÂ∑¶‰∏ä„Å´ÈÖçÁΩÆÔºâ
                this.mapState.homeControl = new HomeControl({ position: 'topleft' });
                this.mapState.homeControl.addTo(this.map);
            }
            
            // Âú∞Âõ≥ÁßªÂãï„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupMapEventListeners() {
                // Âú∞Âõ≥„ÅÆÁßªÂãï„Éª„Ç∫„Éº„É†„Éª„Éë„É≥„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
                this.map.on('moveend zoomend', () => {
                    this.checkMapPosition();
                });
            }
            
            // Âú∞Âõ≥‰ΩçÁΩÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÂàùÊúüÁîªÈù¢„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
            checkMapPosition() {
                const currentCenter = this.map.getCenter();
                const currentZoom = this.map.getZoom();
                const initialView = this.mapState.initialView;
                
                // ÂàùÊúü‰ΩçÁΩÆ„Å®„ÅÆË∑ùÈõ¢„Å® „Ç∫„Éº„É†„É¨„Éô„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const centerDistance = currentCenter.distanceTo(L.latLng(initialView.center));
                const zoomDifference = Math.abs(currentZoom - initialView.zoom);
                
                // Ë®±ÂÆπÁØÑÂõ≤ÂÜÖÔºàË∑ùÈõ¢50km‰ª•ÂÜÖ„ÄÅ„Ç∫„Éº„É†Â∑Æ1‰ª•‰∏ãÔºâ„Å™„ÇâÂàùÊúüÁîªÈù¢„Å®„Åø„Å™„Åô
                const isAtInitialView = centerDistance < 50000 && zoomDifference <= 1;
                
                if (isAtInitialView !== this.mapState.isAtInitialView) {
                    this.mapState.isAtInitialView = isAtInitialView;
                    this.updateHomeControlVisibility();
                }
            }
            
            // „Éõ„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÊõ¥Êñ∞
            updateHomeControlVisibility() {
                if (this.mapState.homeControl) {
                    const container = this.mapState.homeControl.getContainer();
                    if (container) {
                        if (this.mapState.isAtInitialView) {
                            container.style.display = 'none';
                        } else {
                            container.style.display = 'block';
                            // „Éï„Çß„Éº„Éâ„Ç§„É≥ÂäπÊûú
                            container.style.opacity = '0';
                            setTimeout(() => {
                                container.style.transition = 'opacity 0.3s ease';
                                container.style.opacity = '1';
                            }, 50);
                        }
                    }
                }
            }
            
            // ÂàùÊúüÁîªÈù¢„Å´Êàª„Çã
            returnToHome() {
                const initialView = this.mapState.initialView;
                this.map.setView(initialView.center, initialView.zoom, {
                    animate: true,
                    duration: 1.0
                });
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('üè†', 'Âú∞Âõ≥„ÇíÂàùÊúüÁîªÈù¢„Å´Êàª„Åó„Åæ„Åó„Åü', new Date());
                console.log('üè† Map returned to initial view');
            }

            connectWebSocket() {
                try {
                    // Êé•Á∂öË©¶Ë°å‰∏≠Áä∂ÊÖã„ÇíË°®Á§∫
                    this.updateConnectionStatus('p2p-status', false);
                    
                    this.websocket = new WebSocket('wss://api.p2pquake.net/v2/ws');
                    
                    // Êé•Á∂ö„Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆö
                    const connectionTimeout = setTimeout(() => {
                        if (this.websocket.readyState === WebSocket.CONNECTING) {
                            this.websocket.close();
                            console.warn('‚ö†Ô∏è WebSocket connection timeout');
                            this.addActivityFeedItem('‚ö†Ô∏è', 'P2PÊé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', new Date());
                        }
                    }, 10000); // 10Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                    
                    this.websocket.onopen = () => {
                        clearTimeout(connectionTimeout);
                        console.log('üîå WebSocket connected');
                        this.updateConnectionStatus('p2p-status', true);
                        this.addActivityFeedItem('üü¢', 'P2PÂú∞ÈúáÊÉÖÂ†±„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', new Date());
                    };

                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleEarthquakeData(data);
                            this.stats.dataPackets++;
                            this.updateStats();
                        } catch (parseError) {
                            console.warn('‚ö†Ô∏è Failed to parse WebSocket message:', parseError);
                        }
                    };

                    this.websocket.onerror = (error) => {
                        clearTimeout(connectionTimeout);
                        console.error('‚ùå WebSocket error:', error);
                        this.updateConnectionStatus('p2p-status', false);
                    };

                    this.websocket.onclose = () => {
                        clearTimeout(connectionTimeout);
                        console.log('üîå WebSocket disconnected');
                        this.updateConnectionStatus('p2p-status', false);
                        this.addActivityFeedItem('üî¥', 'P2PÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü', new Date());
                        
                        // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï„ÅßÂÜçÊé•Á∂öË©¶Ë°å
                        const retryDelay = Math.min(5000 * Math.pow(2, this.reconnectAttempts || 0), 30000);
                        this.reconnectAttempts = (this.reconnectAttempts || 0) + 1;
                        
                        setTimeout(() => {
                            this.connectWebSocket();
                        }, retryDelay);
                    };
                } catch (error) {
                    console.error('‚ùå WebSocket connection failed:', error);
                    this.updateConnectionStatus('p2p-status', false);
                    this.addActivityFeedItem('‚ùå', `WebSocketÊé•Á∂ö„Ç®„É©„Éº: ${error.message}`, new Date());
                }
            }

            handleEarthquakeData(data) {
                if (data.code === 551) { // Âú∞ÈúáÊÉÖÂ†±
                    const earthquake = this.parseEarthquakeData(data);
                    this.earthquakeHistory.unshift(earthquake);
                    
                    // Â±•Ê≠¥„ÇíÊúÄÊñ∞10‰ª∂„Å´Âà∂Èôê
                    if (this.earthquakeHistory.length > 10) {
                        this.earthquakeHistory = this.earthquakeHistory.slice(0, 10);
                    }
                    
                    this.updateEarthquakeDisplay();
                    this.updateMapMarkers();
                    this.updateOverlayInfo(earthquake);
                    this.updateStatistics(earthquake);
                    
                    // ÈÄöÁü•Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    this.checkAndSendNotification(earthquake);
                    
                    this.addActivityFeedItem('üî¥', 
                        `Âú∞ÈúáÁô∫Áîü: ${earthquake.location} M${earthquake.magnitude} ÈúáÂ∫¶${earthquake.maxIntensity}`, 
                        new Date()
                    );
                    
                    console.log(`üåè Earthquake detected: ${earthquake.location} M${earthquake.magnitude}`);
                }
            }
            
            // ÈÄöÁü•Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÈÄÅ‰ø°
            checkAndSendNotification(earthquake) {
                const magnitude = earthquake.magnitude || 0;
                const intensity = this.getNumericIntensity(earthquake.maxIntensity);
                
                // Ë®≠ÂÆöÂÄ§„Å®ÊØîËºÉ
                const shouldNotify = magnitude >= this.settings.magnitudeThreshold || 
                                   intensity >= this.settings.intensityThreshold;
                
                if (shouldNotify && this.settings.notifications) {
                    // „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•
                    if (Notification.permission === 'granted') {
                        new Notification('üåè Âú∞ÈúáÁô∫ÁîüË≠¶Â†±', {
                            body: `${earthquake.location}\nM${magnitude.toFixed(1)} ÈúáÂ∫¶${earthquake.maxIntensity}\n${earthquake.time.toLocaleString('ja-JP')}`,
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNlMTcwNTUiLz4KPHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo=',
                            requireInteraction: true // ÈáçË¶Å„Å™ÈÄöÁü•„Å™„ÅÆ„ÅßÊâãÂãï„ÅßÈñâ„Åò„Çã„Åæ„ÅßË°®Á§∫
                        });
                    }
                    
                    // Èü≥Â£∞„Ç¢„É©„Éº„ÉàÔºà3ÂõûÁπ∞„ÇäËøî„ÅóÔºâ
                    this.playAlertSound(3);
                    
                    this.addActivityFeedItem('üö®', 
                        `Ë≠¶Â†±Áô∫‰ø°: M${magnitude.toFixed(1)} ÈúáÂ∫¶${earthquake.maxIntensity} (ÈñæÂÄ§: M${this.settings.magnitudeThreshold} ÈúáÂ∫¶${this.settings.intensityThreshold})`, 
                        new Date()
                    );
                    
                    console.log(`üö® Alert triggered: M${magnitude.toFixed(1)} intensity ${earthquake.maxIntensity}`);
                } else {
                    console.log(`‚ÑπÔ∏è No alert: M${magnitude.toFixed(1)} intensity ${earthquake.maxIntensity} (below thresholds)`);
                }
            }

            parseEarthquakeData(data) {
                const eq = data.earthquake || {};
                const hypocenter = eq.hypocenter || {};
                
                return {
                    id: `${data.time}-${hypocenter.name}`,
                    time: new Date(data.time),
                    location: hypocenter.name || '‰∏çÊòé',
                    magnitude: hypocenter.magnitude || 0,
                    depth: hypocenter.depth || 0,
                    latitude: hypocenter.latitude || 0,
                    longitude: hypocenter.longitude || 0,
                    maxIntensity: this.parseIntensity(eq.maxScale) || '‰∏çÊòé',
                    points: data.points || []
                };
            }

            parseIntensity(scale) {
                const intensityMap = {
                    10: '1', 20: '2', 30: '3', 40: '4',
                    45: '5Âº±', 50: '5Âº∑', 55: '6Âº±', 60: '6Âº∑', 70: '7'
                };
                return intensityMap[scale] || scale?.toString() || '‰∏çÊòé';
            }

            updateEarthquakeDisplay() {
                const container = document.getElementById('earthquake-history');
                
                if (this.earthquakeHistory.length === 0) {
                    container.innerHTML = `
                        <div class="loading">
                            <div class="loading-text">Âú∞Èúá„Éá„Éº„Çø„ÇíÂæÖÊ©ü‰∏≠...</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.earthquakeHistory.map(eq => `
                    <div class="earthquake-item fade-in" onclick="selectEarthquake('${eq.id}')">
                        <div class="earthquake-header">
                            <span class="magnitude">M${eq.magnitude.toFixed(1)}</span>
                            <span class="intensity">ÈúáÂ∫¶${eq.maxIntensity}</span>
                        </div>
                        <div class="earthquake-location">${eq.location}</div>
                        <div class="earthquake-time">${eq.time.toLocaleString('ja-JP')}</div>
                    </div>
                `).join('');
            }

            updateMapMarkers() {
                // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        this.map.removeLayer(layer);
                    }
                });

                // ÊúÄÊñ∞„ÅÆÂú∞Èúá„Å´„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
                this.earthquakeHistory.forEach((eq, index) => {
                    if (eq.latitude && eq.longitude) {
                        const opacity = 1 - (index * 0.1); // Âè§„ÅÑ„ÇÇ„ÅÆ„Åª„Å©ËñÑ„Åè
                        
                        const marker = L.circleMarker([eq.latitude, eq.longitude], {
                            radius: Math.max(8, eq.magnitude * 2.5),
                            fillColor: this.getEarthquakeColor(eq.magnitude),
                            color: '#ffffff',
                            weight: 3,
                            opacity: opacity,
                            fillOpacity: opacity * 0.9,
                            className: 'earthquake-marker'
                        }).addTo(this.map);

                        marker.bindPopup(`
                            <div style="color: white; background: transparent;">
                                <strong>${eq.location}</strong><br>
                                M${eq.magnitude.toFixed(1)} ÈúáÂ∫¶${eq.maxIntensity}<br>
                                Ê∑±„Åï: ${eq.depth}km<br>
                                ${eq.time.toLocaleString('ja-JP')}
                            </div>
                        `);
                    }
                });
            }

            getEarthquakeColor(magnitude) {
                if (magnitude >= 7) return '#9C27B0';
                if (magnitude >= 6) return '#E91E63';
                if (magnitude >= 5) return '#FF5722';
                if (magnitude >= 4) return '#FF9800';
                if (magnitude >= 3) return '#FFC107';
                return '#4CAF50';
            }

            updateOverlayInfo(earthquake) {
                const latitudeEl = document.getElementById('latitude');
                if (latitudeEl) {
                    latitudeEl.textContent = earthquake.latitude ? `${earthquake.latitude.toFixed(3)}¬∞` : '---.---¬∞';
                }
                
                const longitudeEl = document.getElementById('longitude');
                if (longitudeEl) {
                    longitudeEl.textContent = earthquake.longitude ? `${earthquake.longitude.toFixed(3)}¬∞` : '---.---¬∞';
                }
                
                const depthEl = document.getElementById('depth');
                if (depthEl) {
                    depthEl.textContent = earthquake.depth ? `${earthquake.depth} km` : '-- km';
                }
                
                const magnitudeEl = document.getElementById('magnitude');
                if (magnitudeEl) {
                    magnitudeEl.textContent = earthquake.magnitude ? `M${earthquake.magnitude.toFixed(1)}` : 'M-.-';
                }
            }

            updateStatistics(earthquake) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

                // ‰ªäÊó•„ÅÆÂú∞ÈúáÊï∞
                this.stats.todayCount = this.earthquakeHistory.filter(eq => 
                    eq.time >= today
                ).length;

                // ‰ªäÈÄ±„ÅÆÂú∞ÈúáÊï∞
                this.stats.weekCount = this.earthquakeHistory.filter(eq => 
                    eq.time >= weekAgo
                ).length;

                // ÊúÄÂ§ßÈúáÂ∫¶
                const maxIntensityEq = this.earthquakeHistory.reduce((max, eq) => {
                    const currentIntensity = this.getNumericIntensity(eq.maxIntensity);
                    const maxIntensity = this.getNumericIntensity(max.maxIntensity);
                    return currentIntensity > maxIntensity ? eq : max;
                }, { maxIntensity: '0' });
                
                this.stats.maxIntensity = maxIntensityEq.maxIntensity;
                this.updateStats();
            }

            getNumericIntensity(intensity) {
                const intensityMap = {
                    '1': 1, '2': 2, '3': 3, '4': 4,
                    '5Âº±': 4.5, '5Âº∑': 5.5, '6Âº±': 5.5, '6Âº∑': 6.5, '7': 7
                };
                return intensityMap[intensity] || 0;
            }

            updateStats() {
                const todayCountEl = document.getElementById('today-count');
                if (todayCountEl) {
                    todayCountEl.textContent = this.stats.todayCount;
                }
                
                const weekCountEl = document.getElementById('week-count');
                if (weekCountEl) {
                    weekCountEl.textContent = this.stats.weekCount;
                }
                
                const maxIntensityEl = document.getElementById('max-intensity');
                if (maxIntensityEl) {
                    maxIntensityEl.textContent = this.stats.maxIntensity;
                }
                
                const dataPacketsEl = document.getElementById('data-packets');
                if (dataPacketsEl) {
                    dataPacketsEl.textContent = this.stats.dataPackets;
                }
                
                const responseTimeEl = document.getElementById('response-time');
                if (responseTimeEl) {
                    responseTimeEl.textContent = `${this.stats.responseTime}ms`;
                }
            }

            updateConnectionStatus(elementId, isConnected) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.toggle('connected', isConnected);
                }
            }

            addActivityFeedItem(icon, text, time) {
                // „É°„É¢„É™ÂÜÖ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„ÇíÁÆ°ÁêÜ
                if (!this.activityLog) {
                    this.activityLog = [];
                }
                
                const logEntry = {
                    icon: icon,
                    text: text,
                    time: time
                };
                
                this.activityLog.unshift(logEntry);
                
                // ÊúÄÂ§ß20‰ª∂„Å´Âà∂Èôê
                if (this.activityLog.length > 20) {
                    this.activityLog = this.activityLog.slice(0, 20);
                }
                
                // Ë®≠ÂÆö„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„Åì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÊõ¥Êñ∞
                const settingsFeed = document.getElementById('settings-activity-feed');
                if (settingsFeed) {
                    this.updateActivityFeedDisplay(settingsFeed);
                }
            }
            
            updateActivityFeedDisplay(container) {
                if (!this.activityLog || this.activityLog.length === 0) {
                    container.innerHTML = `
                        <div class="feed-item">
                            <div class="feed-icon">üü¢</div>
                            <div class="feed-content">
                                <div class="feed-text">„Ç∑„Çπ„ÉÜ„É†„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü</div>
                                <div class="feed-time">${this.startTime.toLocaleTimeString('ja-JP')}</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.activityLog.map(log => `
                    <div class="feed-item">
                        <div class="feed-icon">${log.icon}</div>
                        <div class="feed-content">
                            <div class="feed-text">${log.text}</div>
                            <div class="feed-time">${log.time.toLocaleTimeString('ja-JP')}</div>
                        </div>
                    </div>
                `).join('');
            }

            async loadHistoricalData() {
                try {
                    console.log('üìö Loading historical earthquake data...');
                    
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„ÅßAPI„É™„ÇØ„Ç®„Çπ„Éà
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                    
                    const response = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=10', {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // „Éá„Éº„Çø„Çí‰∏¶ÂàóÂá¶ÁêÜ„ÅßÈ´òÈÄüÂåñ
                    this.earthquakeHistory = data.map(item => this.parseEarthquakeData(item));
                    
                    // UIÊõ¥Êñ∞„Çí‰∏¶ÂàóÂÆüË°å
                    await Promise.all([
                        this.updateEarthquakeDisplayAsync(),
                        this.updateMapMarkersAsync()
                    ]);
                    
                    if (this.earthquakeHistory.length > 0) {
                        this.updateOverlayInfo(this.earthquakeHistory[0]);
                        this.updateStatistics(this.earthquakeHistory[0]);
                    }
                    
                    this.addActivityFeedItem('üìä', `ÈÅéÂéª„ÅÆÂú∞Èúá„Éá„Éº„Çø ${data.length}‰ª∂„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, new Date());
                    console.log(`‚úÖ Loaded ${data.length} historical earthquake records in optimized mode`);
                } catch (error) {
                    console.error('‚ùå Failed to load historical data:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç≠„É£„ÉÉ„Ç∑„É•„Åæ„Åü„ÅØ„Çµ„É≥„Éó„É´„Éá„Éº„Çø„Çí‰ΩøÁî®
                    this.loadFallbackData();
                    
                    if (error.name === 'AbortError') {
                        this.addActivityFeedItem('‚ö†Ô∏è', '„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºà„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË°®Á§∫Ôºâ', new Date());
                    } else {
                        this.addActivityFeedItem('‚ö†Ô∏è', `Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó: ${error.message}`, new Date());
                    }
                }
            }
            
            async updateEarthquakeDisplayAsync() {
                return new Promise(resolve => {
                    requestAnimationFrame(() => {
                        this.updateEarthquakeDisplay();
                        resolve();
                    });
                });
            }
            
            async updateMapMarkersAsync() {
                return new Promise(resolve => {
                    requestAnimationFrame(() => {
                        this.updateMapMarkers();
                        resolve();
                    });
                });
            }
            
            loadFallbackData() {
                // „Çµ„É≥„Éó„É´Âú∞Èúá„Éá„Éº„ÇøÔºàÊé•Á∂öÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                this.earthquakeHistory = [
                    {
                        id: 'sample-1',
                        time: new Date(),
                        location: 'Êé•Á∂ö„Ç®„É©„Éº - „Çµ„É≥„Éó„É´„Éá„Éº„Çø',
                        magnitude: 0,
                        depth: 0,
                        latitude: 36.0,
                        longitude: 138.0,
                        maxIntensity: '-',
                        points: []
                    }
                ];
                
                this.updateEarthquakeDisplay();
                this.updateMapMarkers();
                
                console.log('üîÑ Fallback data loaded');
            }

            startPerformanceMonitoring() {
                setInterval(() => {
                    // „É°„É¢„É™‰ΩøÁî®Èáè„ÅÆÁõ£Ë¶ñ
                    if (performance.memory) {
                        const memoryUsageEl = document.getElementById('memory-usage');
                        if (memoryUsageEl) {
                            const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                            memoryUsageEl.textContent = `${memoryMB}MB`;
                        }
                    }
                    
                    // Ê¥ªÁô∫Âú∞ÂüüÊï∞„ÅÆÊõ¥Êñ∞
                    const activeRegionsEl = document.getElementById('active-regions');
                    if (activeRegionsEl && this.earthquakeHistory) {
                        const activeRegions = new Set(this.earthquakeHistory.map(eq => eq.location)).size;
                        activeRegionsEl.textContent = activeRegions;
                    }
                }, 5000);
            }

            showIntensityPopup(earthquake) {
                // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                this.closeIntensityPopup();
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                overlay.id = 'intensity-popup-overlay';
                overlay.onclick = () => this.closeIntensityPopup();
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó‰ΩúÊàê
                const popup = document.createElement('div');
                popup.className = 'intensity-popup';
                popup.id = 'intensity-popup';
                
                // „Éò„ÉÉ„ÉÄ„Éº
                const header = `
                    <div class="popup-header">
                        <h3 class="popup-title">üåè Âú∞ÈúáË©≥Á¥∞ÊÉÖÂ†±</h3>
                        <button class="popup-close" onclick="window.monitor.closeIntensityPopup()">√ó</button>
                    </div>
                `;
                
                // Âú∞ÈúáÊ¶ÇË¶Å
                const summary = `
                    <div class="earthquake-summary">
                        <div style="font-size: 16px; font-weight: 600; color: #f7fafc; margin-bottom: 8px;">
                            ${earthquake.location}
                        </div>
                        <div style="font-size: 14px; color: #a0aec0; margin-bottom: 12px;">
                            ${earthquake.time.toLocaleString('ja-JP')}
                        </div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„Éâ</div>
                                <div class="summary-value">M${earthquake.magnitude.toFixed(1)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ÊúÄÂ§ßÈúáÂ∫¶</div>
                                <div class="summary-value">ÈúáÂ∫¶${earthquake.maxIntensity}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Ê∑±„Åï</div>
                                <div class="summary-value">${earthquake.depth}km</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Â∫ßÊ®ô</div>
                                <div class="summary-value">${earthquake.latitude.toFixed(2)}¬∞, ${earthquake.longitude.toFixed(2)}¬∞</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ÈúáÂ∫¶ÊÉÖÂ†±
                let intensityContent = '';
                if (earthquake.points && earthquake.points.length > 0) {
                    // ÈúáÂ∫¶Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
                    const intensityGroups = {};
                    earthquake.points.forEach(point => {
                        const intensity = this.parseIntensity(point.scale);
                        if (!intensityGroups[intensity]) {
                            intensityGroups[intensity] = [];
                        }
                        intensityGroups[intensity].push(point.addr);
                    });
                    
                    // ÈúáÂ∫¶„ÅÆÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                    const sortedIntensities = Object.keys(intensityGroups).sort((a, b) => {
                        return this.getNumericIntensity(b) - this.getNumericIntensity(a);
                    });
                    
                    intensityContent = `
                        <div style="font-size: 16px; font-weight: 600; color: #74b9ff; margin-bottom: 12px;">
                            üìç ÂêÑÂú∞„ÅÆÈúáÂ∫¶ÊÉÖÂ†±
                        </div>
                        <div class="intensity-list">
                    `;
                    
                    sortedIntensities.forEach(intensity => {
                        const regions = intensityGroups[intensity];
                        const intensityColor = this.getIntensityColor(intensity);
                        
                        intensityContent += `
                            <div class="intensity-section">
                                <div class="intensity-header" style="background: ${intensityColor};">
                                    <span>ÈúáÂ∫¶${intensity}</span>
                                    <span>${regions.length}Âú∞Âüü</span>
                                </div>
                                <div class="intensity-regions">
                        `;
                        
                        regions.forEach(region => {
                            intensityContent += `<div class="region-item">${region}</div>`;
                        });
                        
                        intensityContent += `
                                </div>
                            </div>
                        `;
                    });
                    
                    intensityContent += '</div>';
                } else {
                    intensityContent = `
                        <div style="font-size: 16px; font-weight: 600; color: #74b9ff; margin-bottom: 12px;">
                            üìç ÈúáÂ∫¶ÊÉÖÂ†±
                        </div>
                        <div style="color: #a0aec0; text-align: center; padding: 20px;">
                            Ë©≥Á¥∞„Å™ÈúáÂ∫¶ÊÉÖÂ†±„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì
                        </div>
                    `;
                }
                
                popup.innerHTML = header + summary + intensityContent;
                
                // DOM „Å´ËøΩÂä†
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('üìã', `${earthquake.location}„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫`, new Date());
            }
            
            closeIntensityPopup() {
                const overlay = document.getElementById('intensity-popup-overlay');
                const popup = document.getElementById('intensity-popup');
                
                if (overlay) overlay.remove();
                if (popup) popup.remove();
            }
            
            getIntensityColor(intensity) {
                const colorMap = {
                    '7': 'linear-gradient(135deg, #8B0000 0%, #B22222 100%)',
                    '6Âº∑': 'linear-gradient(135deg, #DC143C 0%, #FF1493 100%)',
                    '6Âº±': 'linear-gradient(135deg, #FF4500 0%, #FF6347 100%)',
                    '5Âº∑': 'linear-gradient(135deg, #FF8C00 0%, #FFA500 100%)',
                    '5Âº±': 'linear-gradient(135deg, #FFD700 0%, #FFFF00 100%)',
                    '4': 'linear-gradient(135deg, #32CD32 0%, #7CFC00 100%)',
                    '3': 'linear-gradient(135deg, #00CED1 0%, #00FFFF 100%)',
                    '2': 'linear-gradient(135deg, #4169E1 0%, #6495ED 100%)',
                    '1': 'linear-gradient(135deg, #9370DB 0%, #BA55D3 100%)'
                };
                return colorMap[intensity] || 'linear-gradient(135deg, #4a9eff 0%, #667eea 100%)';
            }
            
            showSettingsPanel() {
                // Êó¢Â≠ò„ÅÆË®≠ÂÆö„Éë„Éç„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                this.closeSettingsPanel();
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                overlay.id = 'settings-overlay';
                overlay.onclick = () => this.closeSettingsPanel();
                
                // Ë®≠ÂÆö„Éë„Éç„É´‰ΩúÊàê
                const panel = document.createElement('div');
                panel.className = 'settings-panel';
                panel.id = 'settings-panel';
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÅÆHTML„ÇíÁîüÊàê
                const activityFeedHTML = document.getElementById('activity-feed') ? 
                    document.getElementById('activity-feed').innerHTML : 
                    '<div class="feed-item"><div class="feed-icon">üü¢</div><div class="feed-content"><div class="feed-text">„Ç∑„Çπ„ÉÜ„É†„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü</div><div class="feed-time">--:--:--</div></div></div>';
                
                panel.innerHTML = `
                    <div class="settings-header">
                        <h3 class="settings-title">‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</h3>
                        <button class="popup-close" onclick="window.monitor.closeSettingsPanel()">√ó</button>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleActivityFeed()">
                            <span>üìã</span>
                            „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ
                            <span id="activity-feed-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="activity-feed-settings" id="settings-activity-feed" style="display: none;">
                            ${activityFeedHTML}
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleMapLayers()">
                            <span>üó∫Ô∏è</span>
                            Âú∞Âõ≥Ë®≠ÂÆö
                            <span id="map-layers-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="map-layers-settings" id="settings-map-layers" style="display: none;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 14px; color: #a0aec0; margin-bottom: 8px;">
                                    ÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº: <span id="current-layer-name" style="color: #74b9ff;">„ÉÄ„Éº„ÇØÔºàÊòé„Çã„ÇÅÔºâ</span>
                                </div>
                            </div>
                            <div id="layer-options"></div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleNotificationSettings()">
                            <span>üîî</span>
                            ÈÄöÁü•Ë®≠ÂÆö
                            <span id="notification-settings-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="notification-settings" id="settings-notification" style="display: none;">
                        <div class="setting-item">
                            <label class="setting-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„ÉâÈñæÂÄ§</label>
                            <div class="setting-input-group">
                                <input type="range" id="magnitude-threshold" min="2.0" max="8.0" step="0.1" value="${this.settings.magnitudeThreshold}" 
                                       onchange="window.monitor.updateSetting('magnitudeThreshold', parseFloat(this.value)); document.getElementById('magnitude-value').textContent = 'M' + this.value">
                                <span id="magnitude-value" class="setting-value">M${this.settings.magnitudeThreshold}</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">ÈúáÂ∫¶ÈñæÂÄ§</label>
                            <div class="setting-input-group">
                                <select id="intensity-threshold" onchange="window.monitor.updateSetting('intensityThreshold', parseInt(this.value))">
                                    <option value="1" ${this.settings.intensityThreshold === 1 ? 'selected' : ''}>ÈúáÂ∫¶1</option>
                                    <option value="2" ${this.settings.intensityThreshold === 2 ? 'selected' : ''}>ÈúáÂ∫¶2</option>
                                    <option value="3" ${this.settings.intensityThreshold === 3 ? 'selected' : ''}>ÈúáÂ∫¶3</option>
                                    <option value="4" ${this.settings.intensityThreshold === 4 ? 'selected' : ''}>ÈúáÂ∫¶4</option>
                                    <option value="5" ${this.settings.intensityThreshold === 5 ? 'selected' : ''}>ÈúáÂ∫¶5Âº±‰ª•‰∏ä</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Èü≥Èáè</label>
                            <div class="setting-input-group">
                                <input type="range" id="volume-setting" min="0" max="100" step="5" value="${this.settings.volume}" 
                                       onchange="window.monitor.updateSetting('volume', parseInt(this.value)); document.getElementById('volume-value').textContent = this.value + '%'">
                                <span id="volume-value" class="setting-value">${this.settings.volume}%</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Ëá™Âãï„Ç∫„Éº„É†</label>
                            <div class="setting-input-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-zoom" ${this.settings.autoZoom ? 'checked' : ''} 
                                           onchange="window.monitor.updateSetting('autoZoom', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="setting-value">${this.settings.autoZoom ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <button class="test-button" onclick="window.monitor.testNotification()">üîî ÈÄöÁü•„ÉÜ„Çπ„Éà</button>
                            <button class="test-button" onclick="window.monitor.testSound()">üîä Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
                        </div>
                        </div>
                    </div>
                `;
                
                // DOM „Å´ËøΩÂä†
                document.body.appendChild(overlay);
                document.body.appendChild(panel);
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('‚öôÔ∏è', '„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', new Date());
            }
            
            toggleNotificationSettings() {
                const settingsContainer = document.getElementById('settings-notification');
                const toggleIcon = document.getElementById('notification-settings-toggle');
                
                if (settingsContainer && toggleIcon) {
                    const isVisible = settingsContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        settingsContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        settingsContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üîî', 
                        isVisible ? 'ÈÄöÁü•Ë®≠ÂÆö„ÇíÈñâ„Åò„Åæ„Åó„Åü' : 'ÈÄöÁü•Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            // Ë®≠ÂÆöÁÆ°ÁêÜ„É°„ÇΩ„ÉÉ„Éâ
            loadSettings() {
                const defaultSettings = {
                    magnitudeThreshold: 4.0,
                    intensityThreshold: 3,
                    volume: 50,
                    autoZoom: true,
                    notifications: true
                };
                
                try {
                    const saved = localStorage.getItem('earthquake_settings');
                    if (saved) {
                        return { ...defaultSettings, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.warn('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
                
                return defaultSettings;
            }
            
            saveSettings() {
                try {
                    localStorage.setItem('earthquake_settings', JSON.stringify(this.settings));
                    this.addActivityFeedItem('üíæ', 'Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', new Date());
                } catch (error) {
                    console.error('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
            }
            
            updateSetting(key, value) {
                this.settings[key] = value;
                this.saveSettings();
                
                // Ëá™Âãï„Ç∫„Éº„É†Ë®≠ÂÆö„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ UI Êõ¥Êñ∞
                if (key === 'autoZoom') {
                    const toggleElement = document.getElementById('auto-zoom');
                    const valueElement = toggleElement?.parentElement?.nextElementSibling;
                    if (valueElement) {
                        valueElement.textContent = value ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
                    }
                }
            }
            
            // „ÉÜ„Çπ„ÉàÊ©üËÉΩ
            testNotification() {
                if (Notification.permission === 'granted') {
                    new Notification('üåè Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†', {
                        body: '„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅåÊ≠£Â∏∏„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„Åü„ÄÇ\nM4.5 „ÉÜ„Çπ„ÉàÂú∞Èúá ÈúáÂ∫¶3',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM3NGI5ZmYiLz4KPHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo='
                    });
                    this.addActivityFeedItem('üîî', 'ÈÄöÁü•„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü', new Date());
                } else if (Notification.permission === 'denied') {
                    alert('ÈÄöÁü•„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„ÇâÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            this.testNotification();
                        }
                    });
                }
            }
            
            testSound() {
                try {
                    this.playAlertSound(3); // 3ÂõûÁπ∞„ÇäËøî„ÅóÂÜçÁîü
                    this.addActivityFeedItem('üîä', 'Èü≥Â£∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„ÅüÔºà3ÂõûÂÜçÁîüÔºâ', new Date());
                } catch (error) {
                    console.error('Èü≥Â£∞„ÉÜ„Çπ„ÉàÂ§±Êïó:', error);
                    alert('Èü≥Â£∞„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
            
            // Èü≥Â£∞„Ç¢„É©„Éº„ÉàÂÜçÁîüÈñ¢Êï∞ÔºàÁπ∞„ÇäËøî„ÅóÂØæÂøúÔºâ
            playAlertSound(repeatCount = 1) {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const volume = this.settings.volume / 100 * 0.3;
                    
                    for (let i = 0; i < repeatCount; i++) {
                        const delay = i * 0.8; // 0.8ÁßíÈñìÈöî„ÅßÂÜçÁîü
                        
                        // ÂêÑÂõû„ÅÆÈü≥Â£∞‰ΩúÊàê
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // Âë®Ê≥¢Êï∞„Éë„Çø„Éº„É≥ÔºàË≠¶ÂëäÈü≥„Çâ„Åó„ÅÑÈü≥Á®ãÔºâ
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + delay);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + delay + 0.1);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + delay + 0.2);
                        
                        // Èü≥Èáè„Ç®„É≥„Éô„É≠„Éº„Éó
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime + delay);
                        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + delay + 0.01);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.3);
                        
                        // ÂÜçÁîüÊôÇÈñìË®≠ÂÆö
                        oscillator.start(audioContext.currentTime + delay);
                        oscillator.stop(audioContext.currentTime + delay + 0.3);
                    }
                    
                    console.log(`üîä Èü≥Â£∞„Ç¢„É©„Éº„Éà„Çí${repeatCount}ÂõûÂÜçÁîüÈñãÂßã`);
                } catch (error) {
                    console.error('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', error);
                    throw error;
                }
            }
            
            closeSettingsPanel() {
                const overlay = document.getElementById('settings-overlay');
                const panel = document.getElementById('settings-panel');
                
                if (overlay) overlay.remove();
                if (panel) panel.remove();
            }
            
            toggleActivityFeed() {
                const feedContainer = document.getElementById('settings-activity-feed');
                const toggleIcon = document.getElementById('activity-feed-toggle');
                
                if (feedContainer && toggleIcon) {
                    const isVisible = feedContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        feedContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        feedContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                        // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÊõ¥Êñ∞
                        this.updateActivityFeedDisplay(feedContainer);
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üìã', 
                        isVisible ? '„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÈñâ„Åò„Åæ„Åó„Åü' : '„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            toggleMapLayers() {
                const layersContainer = document.getElementById('settings-map-layers');
                const toggleIcon = document.getElementById('map-layers-toggle');
                
                if (layersContainer && toggleIcon) {
                    const isVisible = layersContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        layersContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        layersContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                        // Âú∞Âõ≥„É¨„Ç§„É§„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
                        this.updateMapLayerOptions();
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üó∫Ô∏è', 
                        isVisible ? 'Âú∞Âõ≥Ë®≠ÂÆö„ÇíÈñâ„Åò„Åæ„Åó„Åü' : 'Âú∞Âõ≥Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            updateMapLayerOptions() {
                const container = document.getElementById('layer-options');
                const currentLayerEl = document.getElementById('current-layer-name');
                
                if (!container || !this.mapLayers) return;
                
                // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„ÉºÂêç„ÇíÊõ¥Êñ∞
                if (currentLayerEl) {
                    currentLayerEl.textContent = this.currentLayerName || '„ÉÄ„Éº„ÇØÔºàÊòé„Çã„ÇÅÔºâ';
                }
                
                // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
                container.innerHTML = '';
                
                // „É¨„Ç§„É§„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂÄãÂà•„Å´‰ΩúÊàê
                Object.keys(this.mapLayers).forEach(layerName => {
                    const isActive = layerName === this.currentLayerName;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `layer-option ${isActive ? 'active' : ''}`;
                    optionDiv.setAttribute('data-layer', layerName);
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'layer-option-name';
                    nameSpan.textContent = layerName;
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'layer-option-status';
                    statusSpan.textContent = isActive ? '‚úì ‰ΩøÁî®‰∏≠' : '';
                    
                    optionDiv.appendChild(nameSpan);
                    optionDiv.appendChild(statusSpan);
                    
                    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁõ¥Êé•ËøΩÂä†
                    optionDiv.addEventListener('click', () => {
                        console.log(`Clicked layer: "${layerName}"`);
                        this.changeMapLayer(layerName);
                    });
                    
                    container.appendChild(optionDiv);
                    
                    console.log(`Created option for "${layerName}", active: ${isActive}`);
                });
                
                console.log(`UI Updated - Current layer: "${this.currentLayerName}"`);
            }
            
            changeMapLayer(layerName) {
                console.log(`üîÑ Changing map layer to: "${layerName}"`);
                
                if (!this.mapLayers || !this.mapLayers[layerName] || !this.map) {
                    console.error(`‚ùå Layer "${layerName}" not found or map not ready`);
                    return;
                }
                
                try {
                    // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
                    if (this.currentLayer) {
                        this.map.removeLayer(this.currentLayer);
                        console.log(`üóëÔ∏è Removed previous layer`);
                    }
                    
                    // Êñ∞„Åó„ÅÑ„É¨„Ç§„É§„Éº„ÇíËøΩÂä†
                    this.currentLayer = this.mapLayers[layerName];
                    this.currentLayer.addTo(this.map);
                    this.currentLayerName = layerName;
                    
                    console.log(`‚úÖ Added new layer: "${layerName}"`);
                    
                    // UI „ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                    this.updateMapLayerOptions();
                    
                    // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„ÉºË°®Á§∫„ÇÇÊõ¥Êñ∞
                    const currentLayerEl = document.getElementById('current-layer-name');
                    if (currentLayerEl) {
                        currentLayerEl.textContent = layerName;
                    }
                    
                    // „É¨„Ç§„É§„ÉºÂ§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíÊâãÂãï„ÅßÁô∫ÁÅ´
                    this.map.fire('baselayerchange', { name: layerName, layer: this.currentLayer });
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üó∫Ô∏è', `Âú∞Âõ≥„É¨„Ç§„É§„Éº„Çí${layerName}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, new Date());
                    
                    console.log(`üéØ Successfully changed to: "${layerName}"`);
                } catch (error) {
                    console.error(`‚ùå Error changing layer to "${layerName}":`, error);
                }
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        function selectEarthquake(id) {
            const earthquake = window.monitor.earthquakeHistory.find(eq => eq.id === id);
            if (earthquake) {
                window.monitor.updateOverlayInfo(earthquake);
                // Ëá™Âãï„Ç∫„Éº„É†Ë®≠ÂÆö„ÅåÊúâÂäπ„Åã„Å§Â∫ßÊ®ô„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂú∞Âõ≥„ÇíÁßªÂãï
                if (window.monitor.settings.autoZoom && earthquake.latitude && earthquake.longitude) {
                    window.monitor.map.setView([earthquake.latitude, earthquake.longitude], 8);
                    // Âú∞Âõ≥ÁßªÂãïÂæå„Å´‰ΩçÁΩÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºà„Éõ„Éº„É†„Éú„Çø„É≥Ë°®Á§∫„ÅÆ„Åü„ÇÅÔºâ
                    setTimeout(() => {
                        window.monitor.checkMapPosition();
                    }, 100);
                }
                // ÈúáÂ∫¶ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
                window.monitor.showIntensityPopup(earthquake);
                console.log(`üìç Selected earthquake: ${earthquake.location}`);
            }
        }

        function openSettings() {
            window.monitor.showSettingsPanel();
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        document.addEventListener('DOMContentLoaded', () => {
            window.monitor = new ProfessionalEarthquakeMonitor();
        });
    </script>
</body>
</html>