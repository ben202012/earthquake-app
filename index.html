<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É† - Professional Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        /* === „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É† CSS === */
        
        /* „É™„Çª„ÉÉ„Éà & Âü∫Êú¨Ë®≠ÂÆö */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0c1623 0%, #1a2332 100%);
            color: #ffffff;
            overflow: hidden;
        }
        
        /* === „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà === */
        .earthquake-dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            grid-template-rows: 70px 1fr;
            grid-template-areas: 
                "header header header"
                "sidebar main rightpanel";
            height: 100vh;
            gap: 1px;
            background: #0a0f1a;
        }
        
        /* === „Éò„ÉÉ„ÉÄ„Éº === */
        .main-header {
            grid-area: header;
            background: linear-gradient(90deg, #1e2a38 0%, #2d3748 100%);
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .app-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #2ed573;
        }
        
        .status-dot.partial {
            background: #ffa502;
            animation: pulse 1s infinite;
        }
        
        .reconnect-btn {
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        
        .reconnect-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(180deg);
        }
        
        .reconnect-btn:active {
            transform: rotate(180deg) scale(0.9);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .current-time {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        /* === „Çµ„Ç§„Éâ„Éê„Éº === */
        .left-sidebar {
            grid-area: sidebar;
            background: linear-gradient(180deg, #1a2332 0%, #2d3748 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            font-size: 18px;
        }
        
        /* EEW „Çπ„ÉÜ„Éº„Çø„Çπ */
        .eew-status {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .eew-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .eew-text {
            font-size: 14px;
            color: #ff9ff3;
        }
        
        /* Áµ±Ë®àÊÉÖÂ†± */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #4a9eff;
            font-family: 'SF Mono', monospace;
        }
        
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        /* ÊúÄÊñ∞Âú∞Èúá„É™„Çπ„Éà */
        .earthquake-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .earthquake-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .earthquake-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }
        
        .earthquake-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .magnitude {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .intensity {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .earthquake-location {
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }
        
        .earthquake-time {
            font-size: 12px;
            color: #94a3b8;
            font-family: 'SF Mono', monospace;
        }
        
        /* === „É°„Ç§„É≥Âú∞Âõ≥„Ç®„É™„Ç¢ === */
        .main-content {
            grid-area: main;
            background: #0f1419;
            position: relative;
            overflow: hidden;
        }
        
        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #earthquake-map {
            width: 100%;
            height: 100%;
            background: #0f1419;
        }
        
        .map-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(45, 55, 72, 0.92);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .overlay-title {
            font-size: 16px;
            font-weight: 600;
            color: #74b9ff;
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .coordinate-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .coord-item {
            text-align: center;
        }
        
        .coord-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        
        .coord-value {
            font-size: 14px;
            font-weight: 600;
            color: #f7fafc;
            font-family: 'SF Mono', monospace;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* === Âè≥„Éë„Éç„É´ === */
        .right-panel {
            grid-area: rightpanel;
            background: linear-gradient(180deg, #1a2332 0%, #2d3748 100%);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            animation: live-pulse 2s infinite;
        }
        
        @keyframes live-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .monitoring-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .monitoring-section {
            margin-bottom: 24px;
        }
        
        .monitoring-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 12px;
        }

        /* === Ê¥•Ê≥¢Ë≠¶Â†±„Éë„Éç„É´ === */
        .tsunami-warning-panel {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%);
            border: 1px solid rgba(255, 69, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .tsunami-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .tsunami-level {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .tsunami-level.major-warning {
            background: rgba(139, 0, 0, 0.2);
            border: 1px solid #8B0000;
            color: #FF6B6B;
        }

        .tsunami-level.warning {
            background: rgba(255, 69, 0, 0.2);
            border: 1px solid #FF4500;
            color: #FFB347;
        }

        .tsunami-level.advisory {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: #FFFF8C;
        }

        .level-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .tsunami-level.major-warning .level-indicator {
            background: #8B0000;
        }

        .tsunami-level.warning .level-indicator {
            background: #FF4500;
        }

        .tsunami-level.advisory .level-indicator {
            background: #FFD700;
        }

        .tsunami-time {
            font-size: 12px;
            color: #a0a9b8;
        }

        .tsunami-regions {
            margin-bottom: 16px;
        }

        .region-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.02);
        }

        .region-item.major-warning {
            border-left-color: #8B0000;
            background: rgba(139, 0, 0, 0.05);
        }

        .region-item.warning {
            border-left-color: #FF4500;
            background: rgba(255, 69, 0, 0.05);
        }

        .region-item.advisory {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .region-name {
            font-size: 13px;
            font-weight: 500;
            color: #ffffff;
        }

        .region-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .wave-height {
            font-size: 14px;
            font-weight: 700;
            color: #4a9eff;
        }

        .arrival-time {
            font-size: 11px;
            color: #a0a9b8;
        }

        .tsunami-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 6px;
            color: #4a9eff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(74, 158, 255, 0.2);
            border-color: rgba(74, 158, 255, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .real-time-clock {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .clock-display {
            font-size: 24px;
            font-weight: 700;
            color: #4a9eff;
            font-family: 'SF Mono', monospace;
        }
        
        .clock-date {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'SF Mono', monospace;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .activity-feed {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .feed-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .feed-item:last-child {
            border-bottom: none;
        }
        
        .feed-icon {
            font-size: 16px;
        }
        
        .feed-content {
            flex: 1;
        }
        
        .feed-text {
            font-size: 13px;
            color: #ffffff;
            line-height: 1.4;
        }
        
        .feed-time {
            font-size: 11px;
            color: #94a3b8;
            font-family: 'SF Mono', monospace;
        }
        
        /* ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†±„Éë„Éç„É´ */
        .earthquake-info-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        
        /* === „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº === */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-radius: 3px;
        }
        
        /* === „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú === */
        @media (max-width: 1200px) {
            .earthquake-dashboard {
                grid-template-columns: 300px 1fr 350px;
            }
        }
        
        @media (max-width: 768px) {
            .earthquake-dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 70px 1fr;
                grid-template-areas: 
                    "header"
                    "main";
            }
            
            .left-sidebar,
            .right-panel {
                display: none;
            }
        }
        
        /* === „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ === */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === ÈúáÂ∫¶ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó === */
        .intensity-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 42, 56, 0.98);
            border: 2px solid rgba(74, 158, 255, 0.4);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            max-height: 600px;
            overflow-y: auto;
            z-index: 10000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease-out;
        }
        
        @keyframes popupSlideIn {
            from { 
                opacity: 0; 
                transform: translate(-50%, -60%) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .popup-title {
            font-size: 18px;
            font-weight: 700;
            color: #74b9ff;
            margin: 0;
        }
        
        .popup-close {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .popup-close:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(1.1);
        }
        
        .earthquake-summary {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #f7fafc;
            font-family: 'SF Mono', monospace;
        }
        
        .intensity-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .intensity-section {
            margin-bottom: 16px;
        }
        
        .intensity-header {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .intensity-regions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
            margin-left: 12px;
        }
        
        .region-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .region-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeInOverlay 0.3s ease-out;
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* === Ë®≠ÂÆö„Éë„Éç„É´ === */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 42, 56, 0.98);
            border: 2px solid rgba(74, 158, 255, 0.4);
            border-radius: 16px;
            padding: 24px;
            width: 600px;
            max-width: 90vw;
            max-height: 700px;
            overflow-y: auto;
            z-index: 10000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease-out;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: 700;
            color: #74b9ff;
            margin: 0;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .settings-section-title:hover {
            color: #74b9ff;
            transform: translateX(2px);
        }
        
        .activity-feed-settings {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .map-layers-settings {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .layer-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .layer-option.active {
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border-color: rgba(74, 158, 255, 0.5);
            color: white;
        }
        
        .layer-option-name {
            font-size: 14px;
            font-weight: 500;
            min-width: 160px;
            flex: 1;
        }
        
        .layer-option-status {
            font-size: 12px;
            color: #74b9ff;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
            white-space: nowrap;
        }
        
        .layer-option.active .layer-option-status {
            color: white;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* === „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã === */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(74, 158, 255, 0.3);
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #94a3b8;
            font-size: 14px;
        }
        
        /* Leaflet „Éû„ÉÉ„Éó„Çπ„Çø„Ç§„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .leaflet-container {
            background: #0f1419;
            border-radius: 8px;
        }
        
        /* „Ç∫„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Åø„Å´filter„ÇíÈÅ©Áî® */
        .leaflet-control-zoom {
            filter: invert(1) hue-rotate(180deg);
        }
        
        /* „É¨„Ç§„É§„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Çπ„Çø„Ç§„É´ - Á¢∫ÂÆü„Å™ÂèØË¶ñÊÄß */
        .leaflet-control-layers {
            background: rgba(30, 42, 56, 0.95) !important;
            color: white !important;
            border: 1px solid rgba(74, 158, 255, 0.3) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            min-width: 180px !important;
            padding: 8px !important;
        }
        
        .leaflet-control-layers-expanded {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .leaflet-control-layers-list {
            color: white !important;
            padding: 8px 0 !important;
        }
        
        .leaflet-control-layers-toggle {
            background-image: none !important;
            background-color: rgba(74, 158, 255, 0.9) !important;
            border-radius: 6px !important;
            width: 36px !important;
            height: 36px !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            position: relative !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .leaflet-control-layers-toggle::before {
            content: 'üó∫Ô∏è';
            color: white !important;
            font-size: 16px !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            line-height: 1 !important;
            z-index: 2001 !important;
            pointer-events: none !important;
        }
        
        .leaflet-control-layers-toggle:hover {
            background-color: rgba(74, 158, 255, 1) !important;
            transform: scale(1.05) !important;
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(15, 20, 25, 0.95);
            color: white;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 158, 255, 0.3);
        }
        
        .leaflet-popup-tip {
            background: rgba(15, 20, 25, 0.95);
        }
        
        .japan-region-tooltip {
            background: rgba(74, 158, 255, 0.9) !important;
            color: white !important;
            border: 1px solid rgba(74, 158, 255, 0.5) !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 4px 8px !important;
        }
        
        /* Âú∞Èúá„Éû„Éº„Ç´„Éº„ÅÆÂº∑Ë™ø */
        .earthquake-marker {
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        

        
        .standard-map-layer {
            transition: filter 0.5s ease;
        }
        
        .dark-subtle {
            opacity: 0.95;
        }
        
        /* Âú∞Èúá„Éû„Éº„Ç´„Éº„ÅÆÂü∫Êú¨„Çπ„Çø„Ç§„É´ */
        .earthquake-marker {
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }
        
        /* Ê¥•Ê≥¢„Ç®„É™„Ç¢„ÅÆÊ®ôÊ∫ñË°®Á§∫ */
        .jma-tsunami-area {
            stroke-width: 2px !important;
            stroke-opacity: 0.8 !important;
            fill-opacity: 0.6 !important;
        }
        
        /* Êó•Êú¨ÈÉΩÂ∏Ç„Éû„Éº„Ç´„Éº„ÅÆË°®Á§∫ */
        .japan-city-marker {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        /* „Éû„Éº„Ç´„Éº„ÅÆ„Éõ„Éê„ÉºÂäπÊûú */
        .japan-city-marker:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.6));
        }
        
        /* ÈÉΩÂ∏Ç„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Çπ„Çø„Ç§„É´ */
        .japan-city-tooltip {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #333333 !important;
            border: 1px solid #cccccc !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            padding: 4px 8px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* „É¨„Ç§„É§„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Çπ„Çø„Ç§„É´ÊîπÂñÑ */
        .leaflet-control-layers-list {
            color: white !important;
        }
        
        .leaflet-control-layers-base label {
            color: white !important;
            font-weight: 500 !important;
        }
        
        .leaflet-control-layers-base input[type="radio"] {
            accent-color: #4a9eff !important;
        }
        /* === Ë®≠ÂÆö„Éë„Éç„É´„Çπ„Çø„Ç§„É´ === */
        .setting-item {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-description {
            font-size: 13px;
            color: #a0aec0;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .test-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .quick-test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .setting-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #74b9ff;
            margin-bottom: 8px;
        }

        .setting-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-input-group input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #74b9ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .setting-input-group select {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
        }

        .setting-input-group select option {
            background: #2d3748;
            color: #ffffff;
        }

        .setting-value {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #74b9ff;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #74b9ff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .test-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.3);
        }

        /* === „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´ === */
        .home-control {
            transition: all 0.3s ease !important;
        }

        .home-control:hover {
            background-color: rgba(74, 158, 255, 1) !important;
            transform: scale(1.1) !important;
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.5) !important;
        }

        .home-control:active {
            transform: scale(0.95) !important;
        }
    </style>
</head>
<body>
    <div class="earthquake-dashboard">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="main-header">
            <div class="header-left">
                <div class="app-logo">üåè</div>
                <h1 class="app-title">Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†</h1>
            </div>
            
            <div class="header-center">
                <div class="connection-status">
                    <div class="status-indicator">
                        <div class="status-dot" id="p2p-status"></div>
                        P2PÊé•Á∂ö
                        <button id="reconnect-btn" class="reconnect-btn" onclick="monitor.reconnectWebSocket()" title="ÊâãÂãï„ÅßÂÜçÊé•Á∂ö">
                            üîÑ
                        </button>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot" id="api-status"></div>
                        APIÊé•Á∂ö
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="current-time" id="current-time">--:--:--</div>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>
        </header>
        
        <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„Éº -->
        <aside class="left-sidebar">
            <!-- EEW „Çπ„ÉÜ„Éº„Çø„Çπ -->
            <div class="sidebar-section">
                <div class="section-title">
                    <span class="section-icon">‚ö°</span>
                    Á∑äÊÄ•Âú∞ÈúáÈÄüÂ†±
                </div>
                <div class="eew-status">
                    <div class="eew-icon">üì°</div>
                    <div class="eew-text" id="eew-status">Áô∫‰ø°„Å™„Åó</div>
                </div>
            </div>
            
            <!-- Áµ±Ë®àÊÉÖÂ†± -->
            <div class="sidebar-section">
                <div class="section-title">
                    <span class="section-icon">üìä</span>
                    Áõ£Ë¶ñÁµ±Ë®à
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="today-count">0</div>
                        <div class="stat-label">‰ªäÊó•„ÅÆÂú∞Èúá</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="week-count">0</div>
                        <div class="stat-label">‰ªäÈÄ±„ÅÆÂú∞Èúá</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="max-intensity">-</div>
                        <div class="stat-label">ÊúÄÂ§ßÈúáÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="response-time">0ms</div>
                        <div class="stat-label">ÂøúÁ≠îÊôÇÈñì</div>
                    </div>
                </div>
            </div>
            
            <!-- ÊúÄÊñ∞Âú∞Èúá„É™„Çπ„Éà -->
            <div class="earthquake-list">
                <div class="section-title">
                    <span class="section-icon">üî¥</span>
                    ÊúÄÊñ∞Âú∞ÈúáÊÉÖÂ†±
                </div>
                <div id="earthquake-history">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- „É°„Ç§„É≥Âú∞Âõ≥„Ç®„É™„Ç¢ -->
        <main class="main-content">
            <div class="map-container">
                <div id="earthquake-map"></div>
            </div>
        </main>
        
        <!-- Âè≥„Éë„Éç„É´ -->
        <aside class="right-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    üì° „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
                    <span class="live-indicator">LIVE</span>
                </h2>
            </div>
            
            <div class="monitoring-panel">
                <!-- „É™„Ç¢„É´„Çø„Ç§„É†ÊôÇË®à -->
                <div class="monitoring-section">
                    <div class="monitoring-title">„Ç∑„Çπ„ÉÜ„É†ÊôÇÂàª</div>
                    <div class="real-time-clock">
                        <div class="clock-display" id="system-clock">--:--:--</div>
                        <div class="clock-date" id="system-date">----/--/--</div>
                    </div>
                </div>
                
                <!-- „É°„Éà„É™„ÇØ„Çπ -->
                <div class="monitoring-section">
                    <div class="monitoring-title">„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="uptime">00:00:00</div>
                            <div class="metric-label">Á®ºÂÉçÊôÇÈñì</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="data-packets">0</div>
                            <div class="metric-label">Âèó‰ø°„Éá„Éº„Çø</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="memory-usage">0MB</div>
                            <div class="metric-label">„É°„É¢„É™‰ΩøÁî®Èáè</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="active-regions">0</div>
                            <div class="metric-label">Ê¥ªÁô∫Âú∞Âüü</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ê¥•Ê≥¢Ë≠¶Â†±„Éë„Éç„É´ -->
                <div class="monitoring-section">
                    <div class="monitoring-title" id="tsunami-section-title">üåä Ê¥•Ê≥¢Ë≠¶Â†±„ÉªÊ≥®ÊÑèÂ†±</div>
                    <div class="tsunami-warning-panel">
                        <div class="tsunami-status">
                            <div class="tsunami-level advisory" id="tsunami-level">
                                <div class="level-indicator"></div>
                                <div class="level-text">Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±</div>
                            </div>
                            <div class="tsunami-time">Áô∫Ë°®: 30Êó•20:45 JST</div>
                        </div>
                        
                        <div class="tsunami-regions">
                            <div class="region-item advisory">
                                <div class="region-name">ÂåóÊµ∑ÈÅìÂ§™Âπ≥Ê¥ãÊ≤øÂ≤∏Êù±ÈÉ®</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                            <div class="region-item advisory">
                                <div class="region-name">ÂåóÊµ∑ÈÅìÂ§™Âπ≥Ê¥ãÊ≤øÂ≤∏‰∏≠ÈÉ®</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                            <div class="region-item advisory">
                                <div class="region-name">ÈùíÊ£ÆÁúåÂ§™Âπ≥Ê¥ãÊ≤øÂ≤∏</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                            <div class="region-item advisory">
                                <div class="region-name">Â≤©ÊâãÁúå</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                            <div class="region-item advisory">
                                <div class="region-name">ÂÆÆÂüéÁúå</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                            <div class="region-item advisory">
                                <div class="region-name">Â∞èÁ¨†ÂéüË´∏Â≥∂</div>
                                <div class="region-info">
                                    <span class="wave-height">1m</span>
                                    <span class="arrival-time">Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tsunami-actions">
                            <button class="action-btn" id="tsunami-sound-toggle">üîä Èü≥Â£∞ÈÄöÁü• ON</button>
                            <button class="action-btn" id="tsunami-details">üìã Ë©≥Á¥∞ÊÉÖÂ†±</button>
                        </div>
                    </div>
                </div>

                <!-- ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†± -->
                <div class="monitoring-section">
                    <div class="monitoring-title">üìç ÈúáÊ∫ê‰ΩçÁΩÆÊÉÖÂ†±</div>
                    <div class="earthquake-info-panel">
                        <div class="coordinate-info">
                            <div class="coord-item">
                                <div class="coord-label">ÂåóÁ∑Ø</div>
                                <div class="coord-value" id="latitude">---.---¬∞</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">Êù±Áµå</div>
                                <div class="coord-value" id="longitude">---.---¬∞</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">Ê∑±„Åï</div>
                                <div class="coord-value" id="depth">-- km</div>
                            </div>
                            <div class="coord-item">
                                <div class="coord-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„Éâ</div>
                                <div class="coord-value" id="magnitude">M-.-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <script src="config.js"></script>
    <script src="jma-data-converter.js"></script>
    <script src="jma-tsunami-loader.js"></script>
    <script src="jma-xml-client.js"></script>
    <script src="tsunami-data-store.js"></script>
    <script src="audio-alert-system.js"></script>
    <script src="tsunami-alert-system.js"></script>
    <script src="tsunami-manager.js"></script>
    <!-- 60%ÂÆüÁî®Ê©üËÉΩÈÅîÊàê„ÅÆ„Åü„ÇÅ„ÅÆÈ´òÂ∫¶„Ç∑„Çπ„ÉÜ„É† -->
    <script src="tsunami-prediction-engine.js"></script>
    <script src="multi-site-verification.js"></script>
    <script src="historical-tsunami-data.js"></script>
    <script>
        // „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†
        class ProfessionalEarthquakeMonitor {
            constructor() {
                this.startTime = new Date();
                this.earthquakeHistory = [];
                this.stats = {
                    todayCount: 0,
                    weekCount: 0,
                    maxIntensity: '-',
                    dataPackets: 0,
                    responseTime: 0
                };
                this.map = null;
                this.websocket = null;
                
                // Ë®≠ÂÆö„Éá„Éº„Çø
                this.settings = this.loadSettings();
                
                // Âú∞Âõ≥Áä∂ÊÖãÁÆ°ÁêÜ
                this.mapState = {
                    initialView: { center: [36.2, 138.2], zoom: 5 },
                    isAtInitialView: true,
                    homeControl: null
                };
                
                // Â§úÈñì„É¢„Éº„ÉâÁä∂ÊÖã
                this.nightModeEnabled = false;
                
                // ÂÆüÁî®Ê¥•Ê≥¢Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É† (50%ÂÆåÊàêÂ∫¶Áâà)
                this.tsunamiManager = new TsunamiManager();
                this.jmaXmlClient = new JMAXMLClient();
                this.tsunamiDataStore = new TsunamiDataStore();
                this.tsunamiAlertSystem = new TsunamiAlertSystem();
                
                this.setupPracticalTsunamiSystem();
                
                this.init();
            }

            async init() {
                console.log('üåè Professional Earthquake Monitor v2.0 - Starting...');
                
                try {
                    // DOMË¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                    const requiredElements = [
                        'current-time', 'system-clock', 'system-date', 'uptime',
                        'latitude', 'longitude', 'depth', 'magnitude'
                    ];
                    
                    const missingElements = requiredElements.filter(id => !document.getElementById(id));
                    if (missingElements.length > 0) {
                        console.warn(`‚ö†Ô∏è Missing DOM elements: ${missingElements.join(', ')}`);
                    }
                    
                    // Âü∫Êú¨„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÔºà‰∏¶ÂàóÂÆüË°å„ÅßÈ´òÈÄüÂåñÔºâ
                    await Promise.all([
                        this.setupClockAsync(),
                        this.setupMapAsync(),
                        this.startPerformanceMonitoringAsync()
                    ]);
                    
                    // Êé•Á∂öÁä∂ÊÖã„ÇíË°®Á§∫
                    this.updateConnectionStatus('p2p-status', false);
                    this.updateConnectionStatus('api-status', false);
                    
                    // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßã„Çí„É≠„Ç∞
                    this.addActivityFeedItem('üü¢', '„Ç∑„Çπ„ÉÜ„É†„ÅåÈ´òÈÄü„É¢„Éº„Éâ„ÅßÈñãÂßã„Åï„Çå„Åæ„Åó„Åü', new Date());
                    
                    // ÈùûÂêåÊúü„Åß„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å®WebSocketÊé•Á∂ö
                    Promise.all([
                        this.loadHistoricalData(),
                        this.connectWebSocketAsync()
                    ]).then(() => {
                        console.log('‚úÖ All background tasks completed');
                        this.updateConnectionStatus('api-status', true);
                    }).catch(error => {
                        console.warn('‚ö†Ô∏è Some background tasks failed:', error);
                        this.updateConnectionStatus('api-status', false);
                    });
                    
                    console.log('‚úÖ Professional Earthquake Monitor initialized successfully');
                } catch (error) {
                    console.error('‚ùå Failed to initialize system:', error);
                    this.addActivityFeedItem('‚ùå', `ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, new Date());
                }
            }
            
            async setupClockAsync() {
                return new Promise(resolve => {
                    this.setupClock();
                    resolve();
                });
            }
            
            async setupMapAsync() {
                return new Promise(resolve => {
                    this.setupMap();
                    resolve();
                });
            }
            
            async startPerformanceMonitoringAsync() {
                return new Promise(resolve => {
                    this.startPerformanceMonitoring();
                    resolve();
                });
            }
            
            async connectWebSocketAsync() {
                return new Promise((resolve, reject) => {
                    try {
                        this.connectWebSocket();
                        setTimeout(resolve, 1000); // 1Áßí„ÅßÊé•Á∂öÁ¢∫Á´ã„Å®‰ªÆÂÆö
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            setupClock() {
                const updateClock = () => {
                    const now = new Date();
                    
                    // „Éò„ÉÉ„ÉÄ„ÉºÊôÇË®à
                    const currentTimeEl = document.getElementById('current-time');
                    if (currentTimeEl) {
                        currentTimeEl.textContent = now.toLocaleTimeString('ja-JP', { hour12: false });
                    }
                    
                    // „Ç∑„Çπ„ÉÜ„É†ÊôÇË®à
                    const systemClockEl = document.getElementById('system-clock');
                    if (systemClockEl) {
                        systemClockEl.textContent = now.toLocaleTimeString('ja-JP', { hour12: false });
                    }
                    
                    const systemDateEl = document.getElementById('system-date');
                    if (systemDateEl) {
                        systemDateEl.textContent = now.toLocaleDateString('ja-JP');
                    }
                    
                    // Á®ºÂÉçÊôÇÈñì
                    const uptimeEl = document.getElementById('uptime');
                    if (uptimeEl) {
                        const uptime = new Date(now - this.startTime);
                        const hours = String(Math.floor(uptime / 3600000)).padStart(2, '0');
                        const minutes = String(Math.floor((uptime % 3600000) / 60000)).padStart(2, '0');
                        const seconds = String(Math.floor((uptime % 60000) / 1000)).padStart(2, '0');
                        uptimeEl.textContent = `${hours}:${minutes}:${seconds}`;
                    }
                };
                
                updateClock();
                setInterval(updateClock, 1000);
                
                // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßãÊôÇÂàª„ÇíË®òÈå≤
                const systemStartTimeEl = document.getElementById('system-start-time');
                if (systemStartTimeEl) {
                    systemStartTimeEl.textContent = this.startTime.toLocaleTimeString('ja-JP');
                }
            }

            setupMap() {
                this.map = L.map('earthquake-map', {
                    center: [36.2, 138.2],
                    zoom: 5,
                    zoomControl: true,
                    attributionControl: false
                });

                // ÂÆüÁî®ÁöÑ„Å™Âú∞Âõ≥„É¨„Ç§„É§„ÉºË®≠ÂÆö
                const mapLayers = {
                    'Ê®ôÊ∫ñ„Éû„ÉÉ„Éó': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18,
                        minZoom: 4,
                        className: 'standard-map-layer'
                    }),
                    '„ÉÄ„Éº„ÇØÔºàÊéß„Åà„ÇÅÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4,
                        className: 'dark-subtle'
                    }),
                    '„Ç∞„É¨„ÉºÔºà‰∏≠ÈñìË™øÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4,
                        opacity: 0.8
                    }),
                    '„É©„Ç§„ÉàÔºàÊòé„Çã„ÇÅÔºâ': L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 18,
                        minZoom: 4
                    })
                };

                // „Éá„Éï„Ç©„É´„Éà„É¨„Ç§„É§„ÉºÔºàÊ®ôÊ∫ñ„Éû„ÉÉ„ÉóÔºâ„ÇíË®≠ÂÆö
                const defaultLayer = mapLayers['Ê®ôÊ∫ñ„Éû„ÉÉ„Éó'];
                defaultLayer.addTo(this.map);

                // Âú∞Âõ≥„É¨„Ç§„É§„Éº„Çí‰øùÂ≠òÔºàË®≠ÂÆö„Éë„Éç„É´„Åß‰ΩøÁî®Ôºâ
                this.mapLayers = mapLayers;
                this.currentLayer = defaultLayer;
                this.currentLayerName = 'Ê®ôÊ∫ñ„Éû„ÉÉ„Éó';
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Åß„É¨„Ç§„É§„ÉºÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                this.map.on('baselayerchange', (e) => {
                    this.currentLayerName = e.name;
                    console.log(`üó∫Ô∏è Map layer changed to: "${e.name}"`);
                    this.addActivityFeedItem('üó∫Ô∏è', `Âú∞Âõ≥„É¨„Ç§„É§„Éº„Çí${e.name}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, new Date());
                    
                    // „É¨„Ç§„É§„ÉºÂ§âÊõ¥ÊôÇ„Å´Â¢ÉÁïå„ÇÇÂº∑Âà∂Êõ¥Êñ∞
                    setTimeout(() => {
                        this.updateJapanBoundariesForLayer();
                        console.log(`üîÑ „É¨„Ç§„É§„ÉºÂ§âÊõ¥Âæå„ÅÆÂ¢ÉÁïåÊõ¥Êñ∞ÂÆå‰∫Ü: ${e.name}`);
                    }, 500); // 500msÂæå„Å´ÂÆüË°å„Åó„Å¶„É¨„Ç§„É§„ÉºÂ§âÊõ¥ÂÆå‰∫Ü„ÇíÂæÖ„Å§
                    
                    // Ë®≠ÂÆö„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØUI„ÇíÊõ¥Êñ∞
                    const layersContainer = document.getElementById('settings-map-layers');
                    if (layersContainer && layersContainer.style.display !== 'none') {
                        this.updateMapLayerOptions();
                    }
                });

                // Â§úÈñì„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÊ©üËÉΩ„ÇíÊ∫ñÂÇô
                this.setupNightModeToggle();

                // „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ÔºàÊó•Êú¨ÂàóÂ≥∂„ÇíÂº∑Ë™øÔºâ
                this.addJapanOverlay();
                
                // Ê¥•Ê≥¢Ê≤øÂ≤∏„É©„Ç§„É≥Ë°®Á§∫
                this.addTsunamiCoastlines();
                
                // „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
                this.addHomeControl();
                
                // Âú∞Âõ≥ÁßªÂãï„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
                this.setupMapEventListeners();
                
                // ÊòéÂ∫¶Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ„ÉªÈÅ©Áî®
                this.initializeBrightnessSettings();

                console.log('üó∫Ô∏è Map initialized with enhanced visibility for Japan');
            }

            addJapanOverlay() {
                // ‰∏ªË¶ÅÈÉΩÂ∏Ç„Éá„Éº„ÇøÔºàÊéß„Åà„ÇÅ„Å™Ë°®Á§∫Áî®Ôºâ
                this.japanCityMarkers = [
                    { name: 'Êú≠Âπå', coords: [43.064, 141.347], region: 'ÂåóÊµ∑ÈÅì' },
                    { name: 'ÈùíÊ£Æ', coords: [40.824, 140.740], region: 'Êù±Âåó' },
                    { name: '‰ªôÂè∞', coords: [38.268, 140.872], region: 'Êù±Âåó' },
                    { name: 'Êù±‰∫¨', coords: [35.676, 139.650], region: 'Èñ¢Êù±' },
                    { name: 'Êñ∞ÊΩü', coords: [37.902, 139.023], region: '‰∏≠ÈÉ®' },
                    { name: 'ÂêçÂè§Â±ã', coords: [35.011, 136.768], region: '‰∏≠ÈÉ®' },
                    { name: 'Â§ßÈò™', coords: [34.693, 135.502], region: 'Èñ¢Ë•ø' },
                    { name: 'Â∫ÉÂ≥∂', coords: [34.396, 132.459], region: '‰∏≠ÂõΩ' },
                    { name: 'È´òÊùæ', coords: [34.340, 134.043], region: 'ÂõõÂõΩ' },
                    { name: 'Á¶èÂ≤°', coords: [33.584, 130.401], region: '‰πùÂ∑û' },
                    { name: 'ÈπøÂÖêÂ≥∂', coords: [31.560, 130.558], region: '‰πùÂ∑û' }
                ];

                // ÂàùÊúüË°®Á§∫„ÅÆÊó•Êú¨ÂàóÂ≥∂ÁõÆÂÆâ„Çí‰ΩúÊàê
                this.applyLayerSpecificStyles(); // ÂàùÊúüÂåñÊôÇ„ÇÇ„Çπ„Çø„Ç§„É´ÈÅ©Áî®
                this.createJapanBoundaries();

                console.log('üóæ Êó•Êú¨‰∏ªË¶ÅÈÉΩÂ∏Ç„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫');
            }

            // Êó•Êú¨ÂàóÂ≥∂„Éû„Éº„Ç´„Éº„ÅÆ‰ΩúÊàêÔºà‰∏ªË¶ÅÈÉΩÂ∏ÇË°®Á§∫Ôºâ
            createJapanBoundaries() {
                // Êó¢Â≠ò„ÅÆÂ¢ÉÁïå„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
                if (this.japanBoundaryLayers) {
                    this.japanBoundaryLayers.forEach(layer => {
                        this.map.removeLayer(layer);
                    });
                }
                this.japanBoundaryLayers = [];

                // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº„Å´Âøú„Åò„Åü„Éû„Éº„Ç´„Éº„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó
                const markerStyle = this.getJapanMarkerStyle();

                // „Ç´„Çπ„Çø„É†pane„Çí‰ΩúÊàêÔºàÊ¥•Ê≥¢„É¨„Ç§„É§„Éº„Çà„Çä‰∏ä„Å´Ë°®Á§∫Ôºâ
                if (!this.map.getPane('japan-markers')) {
                    const japanPane = this.map.createPane('japan-markers');
                    japanPane.style.zIndex = 650; // Ê¥•Ê≥¢„É¨„Ç§„É§„Éº(600)„Çà„Çä‰∏ä
                }

                // ‰∏ªË¶ÅÈÉΩÂ∏Ç„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
                if (this.japanCityMarkers) {
                    this.japanCityMarkers.forEach(city => {
                        const marker = L.circleMarker(city.coords, {
                            ...markerStyle,
                            className: 'japan-city-marker',
                            pane: 'japan-markers'  // Â∞ÇÁî®pane„Å´ÈÖçÁΩÆ
                        }).addTo(this.map);
                        
                        this.japanBoundaryLayers.push(marker);
                        
                        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóËøΩÂä†
                        marker.bindTooltip(`${city.name} (${city.region})`, {
                            permanent: false,
                            direction: 'top',
                            className: 'japan-city-tooltip'
                        });
                        
                        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
                        console.log(`‚úÖ ÈÉΩÂ∏Ç„Éû„Éº„Ç´„Éº‰ΩúÊàê: ${city.name} - Ëâ≤:${markerStyle.fillColor}`);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Êó•Êú¨ÈÉΩÂ∏Ç„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }

                console.log(`üóæ Êó•Êú¨‰∏ªË¶ÅÈÉΩÂ∏Ç„Éû„Éº„Ç´„ÉºÊõ¥Êñ∞: ${this.currentLayerName || 'Ê®ôÊ∫ñ'}„É¨„Ç§„É§„ÉºÂØæÂøú`);
            }

            // „É¨„Ç§„É§„Éº„Å´Âøú„Åò„Åü„Éû„Éº„Ç´„Éº„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó
            getJapanMarkerStyle() {
                const layerName = this.currentLayerName || 'Ê®ôÊ∫ñ„Éû„ÉÉ„Éó';
                
                // „É¨„Ç§„É§„Éº„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éû„Éº„Ç´„ÉºË®≠ÂÆö
                const markerStyles = {
                    // „ÉÄ„Éº„ÇØÁ≥ª„É¨„Ç§„É§„ÉºÔºöÊòé„Çã„ÅÑ„Éû„Éº„Ç´„Éº
                    '„ÉÄ„Éº„ÇØÔºàÊéß„Åà„ÇÅÔºâ': {
                        radius: 3,
                        fillColor: '#dddddd',    // Êòé„Çã„ÅÑ„Ç∞„É¨„Éº
                        color: '#ffffff',        // ÁôΩ„ÅÑÊû†Á∑ö
                        weight: 1,
                    opacity: 0.8,
                        fillOpacity: 0.7
                    },
                    // „Ç∞„É¨„ÉºÁ≥ª„É¨„Ç§„É§„ÉºÔºö‰∏≠ÈñìËâ≤„Éû„Éº„Ç´„Éº
                    '„Ç∞„É¨„ÉºÔºà‰∏≠ÈñìË™øÔºâ': {
                        radius: 3,
                        fillColor: '#666666',    // ‰∏≠Èñì„Ç∞„É¨„Éº
                        color: '#333333',        // Êöó„ÅÑÊû†Á∑ö
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.7
                    },
                    // „É©„Ç§„ÉàÁ≥ª„É¨„Ç§„É§„ÉºÔºöÊöó„ÅÑ„Éû„Éº„Ç´„Éº
                    '„É©„Ç§„ÉàÔºàÊòé„Çã„ÇÅÔºâ': {
                        radius: 3,
                        fillColor: '#333333',    // Êöó„ÅÑ„Ç∞„É¨„Éº
                        color: '#000000',        // Èªí„ÅÑÊû†Á∑ö
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.7
                    },
                    // Ê®ôÊ∫ñ„Éû„ÉÉ„ÉóÔºö„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„Åü„Éû„Éº„Ç´„Éº
                    'Ê®ôÊ∫ñ„Éû„ÉÉ„Éó': {
                        radius: 3,
                        fillColor: '#666666',    // ‰∏≠Èñì„Ç∞„É¨„Éº
                        color: '#333333',        // Êöó„ÇÅ„ÅÆÊû†Á∑ö
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }
                };

                // ÊåáÂÆö„Åï„Çå„Åü„É¨„Ç§„É§„Éº„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøî„Åô„ÄÅÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊ®ôÊ∫ñ„Çí‰ΩøÁî®
                return markerStyles[layerName] || markerStyles['Ê®ôÊ∫ñ„Éû„ÉÉ„Éó'];
            }

            // Â§úÈñì„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÊ©üËÉΩ„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
            setupNightModeToggle() {
                // ÁèæÂú®„ÅÆÊôÇÂàª„ÇíÂèñÂæó
                const now = new Date();
                const hour = now.getHours();
                
                // Â§úÈñìÊôÇÈñìÂ∏Ø„ÇíÂà§ÂÆöÔºà18ÊôÇ„Äú6ÊôÇÔºâ
                const isNightTime = hour >= 18 || hour < 6;
                
                // Â§úÈñìÊôÇÈñìÂ∏Ø„ÅÆÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´Êöó„ÇÅ„Å´„Åô„Çã
                if (isNightTime) {
                    this.enableNightMode(true); // Ëá™ÂãïÈÅ©Áî®
                } else {
                    this.enableNightMode(false);
                }
                
                // „Éò„ÉÉ„ÉÄ„Éº„Å´Â§úÈñì„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíËøΩÂä†
                this.addNightModeToggleButton();
                
                console.log(`üåó Â§úÈñì„É¢„Éº„ÉâË®≠ÂÆö: ${isNightTime ? 'Ëá™ÂãïÈÅ©Áî®‰∏≠' : 'Ê®ôÊ∫ñË°®Á§∫'} (${hour}ÊôÇ)`);
            }
            
            // Â§úÈñì„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆËøΩÂä†
            addNightModeToggleButton() {
                const headerRight = document.querySelector('.header-right');
                if (!headerRight) return;
                
                const nightModeBtn = document.createElement('button');
                nightModeBtn.id = 'night-mode-toggle';
                nightModeBtn.className = 'settings-btn';
                nightModeBtn.innerHTML = 'üåô Â§úÈñì„É¢„Éº„Éâ';
                nightModeBtn.title = 'Âú∞Âõ≥„ÇíÊöó„ÇÅ„Å´Ë™øÊï¥';
                
                nightModeBtn.onclick = () => {
                    this.toggleNightMode();
                };
                
                // Ë®≠ÂÆö„Éú„Çø„É≥„ÅÆÂâç„Å´ÊåøÂÖ•
                const settingsBtn = headerRight.querySelector('.settings-btn');
                if (settingsBtn) {
                    headerRight.insertBefore(nightModeBtn, settingsBtn);
                } else {
                    headerRight.appendChild(nightModeBtn);
                }
            }
            
            // Â§úÈñì„É¢„Éº„Éâ„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂåñÔºàÊòéÂ∫¶Ë™øÊï¥Ê©üËÉΩ„Å´Áµ±ÂêàÔºâ
            enableNightMode(enabled) {
                const nightModeBtn = document.getElementById('night-mode-toggle');
                
                if (enabled) {
                    // ÊòéÂ∫¶Ë™øÊï¥Ê©üËÉΩ„Çí‰Ωø„Å£„Å¶70%„Å´Ë®≠ÂÆöÔºàÂ§úÈñì„É¢„Éº„ÉâÔºâ
                    this.updateMapBrightness(70);
                    if (nightModeBtn) {
                        nightModeBtn.innerHTML = '‚òÄÔ∏è Ê®ôÊ∫ñË°®Á§∫';
                        nightModeBtn.title = 'Êòé„Çã„ÅÑË°®Á§∫„Å´Êàª„Åô';
                    }
                    this.nightModeEnabled = true;
                } else {
                    // ÊòéÂ∫¶Ë™øÊï¥Ê©üËÉΩ„Çí‰Ωø„Å£„Å¶100%„Å´Ë®≠ÂÆöÔºàÊ®ôÊ∫ñË°®Á§∫Ôºâ
                    this.updateMapBrightness(100);
                    if (nightModeBtn) {
                        nightModeBtn.innerHTML = 'üåô Â§úÈñì„É¢„Éº„Éâ';
                        nightModeBtn.title = 'Âú∞Âõ≥„ÇíÊöó„ÇÅ„Å´Ë™øÊï¥';
                    }
                    this.nightModeEnabled = false;
                }
            }
            
            // Â§úÈñì„É¢„Éº„Éâ„ÅÆ„Éà„Ç∞„É´
            toggleNightMode() {
                this.enableNightMode(!this.nightModeEnabled);
                
                const message = this.nightModeEnabled ? 
                    'Âú∞Âõ≥„ÇíÊöó„ÇÅ„Å´Ë™øÊï¥„Åó„Åæ„Åó„Åü' : 
                    'Ê®ôÊ∫ñ„ÅÆÊòé„Çã„Åï„Å´Êàª„Åó„Åæ„Åó„Åü';
                    
                this.addActivityFeedItem(
                    this.nightModeEnabled ? 'üåô' : '‚òÄÔ∏è', 
                    message, 
                    new Date()
                );
                
                console.log(`üåó Â§úÈñì„É¢„Éº„Éâ: ${this.nightModeEnabled ? 'ON' : 'OFF'}`);
            }

            // „É¨„Ç§„É§„ÉºÂàá„ÇäÊõø„ÅàÊôÇ„ÅÆÊó•Êú¨ÂàóÂ≥∂Â¢ÉÁïåÊõ¥Êñ∞
            updateJapanBoundariesForLayer() {
                if (!this.japanRegions || !this.map) {
                    console.warn('‚ö†Ô∏è Êó•Êú¨Âú∞Âüü„Éá„Éº„Çø„Åæ„Åü„ÅØÂú∞Âõ≥„ÅåÊú™ÂàùÊúüÂåñ');
                    return;
                }
                
                try {
                    // Âú∞Âõ≥„Ç≥„É≥„ÉÜ„Éä„Å´„É¨„Ç§„É§„ÉºÂà•„ÅÆ„ÇØ„É©„Çπ„ÇíÈÅ©Áî®
                    this.applyLayerSpecificStyles();
                    
                    // Êó•Êú¨ÂàóÂ≥∂Â¢ÉÁïå„ÇíÂÜç‰ΩúÊàêÔºàÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº„Å´Âêà„Çè„Åõ„Å¶Ôºâ
                    this.createJapanBoundaries();
                    console.log(`üîÑ Êó•Êú¨Â¢ÉÁïå„Çí${this.currentLayerName}„É¨„Ç§„É§„Éº„Å´ÈÅ©Âøú`);
                } catch (error) {
                    console.error('‚ùå Êó•Êú¨Â¢ÉÁïåÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                }
            }

            // „É¨„Ç§„É§„ÉºÂà•„ÅÆ„Çπ„Çø„Ç§„É´„ÇØ„É©„Çπ„ÇíÈÅ©Áî®
            applyLayerSpecificStyles() {
                const mapContainer = document.querySelector('.leaflet-container');
                if (!mapContainer) return;
                
                // Êó¢Â≠ò„ÅÆ„É¨„Ç§„É§„Éº„ÇØ„É©„Çπ„ÇíÂâäÈô§
                mapContainer.classList.remove('dark-layer', 'light-layer', 'standard-layer');
                
                // ÁèæÂú®„ÅÆ„É¨„Ç§„É§„Éº„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíËøΩÂä†
                switch (this.currentLayerName) {
                    case '„ÉÄ„Éº„ÇØÔºàÊéß„Åà„ÇÅÔºâ':
                        mapContainer.classList.add('dark-layer');
                        break;
                    case '„É©„Ç§„ÉàÔºàÊòé„Çã„ÇÅÔºâ':
                        mapContainer.classList.add('light-layer');
                        break;
                    case 'Ê®ôÊ∫ñ„Éû„ÉÉ„Éó':
                        mapContainer.classList.add('standard-layer');
                        break;
                    default:
                        mapContainer.classList.add('standard-layer');
                        break;
                }
                
                console.log(`üé® „É¨„Ç§„É§„Éº„ÇØ„É©„ÇπÈÅ©Áî®: ${this.currentLayerName}`);
            }

            // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÂ¢ÉÁïåÁ∑ö„ÇíÂº∑Âà∂ÂÜçË°®Á§∫
            forceBoundaryDisplay() {
                console.log('üîß Â¢ÉÁïåÁ∑öÂº∑Âà∂Ë°®Á§∫ÈñãÂßã...');
                
                // Êó¢Â≠òÂ¢ÉÁïå„Çí„ÇØ„É™„Ç¢
                if (this.japanBoundaryLayers) {
                    this.japanBoundaryLayers.forEach(layer => {
                        this.map.removeLayer(layer);
                    });
                }
                this.japanBoundaryLayers = [];
                
                // „ÉÜ„Çπ„ÉàÁî®„ÅÆÂº∑Âà∂Â¢ÉÁïåÔºàÂøÖ„ÅöË¶ã„Åà„ÇãË®≠ÂÆöÔºâ
                const testStyle = {
                    color: '#ff0000',        // Ëµ§Ëâ≤„ÅßÁ¢∫ÂÆü„Å´Ë¶ã„Åà„Çã
                    weight: 5,               // ÈùûÂ∏∏„Å´Â§™„ÅÑÁ∑ö
                    opacity: 1.0,            // ÂÆåÂÖ®‰∏çÈÄèÊòé
                    fillColor: 'rgba(255, 0, 0, 0.2)',
                    fillOpacity: 0.2
                };
                
                this.japanRegions.forEach(region => {
                    const boundary = L.circle(region.center, {
                        radius: region.radius,
                        ...testStyle,
                        pane: 'japan-boundaries'
                    }).addTo(this.map);
                    
                    this.japanBoundaryLayers.push(boundary);
                    
                    boundary.bindTooltip(`„ÉÜ„Çπ„ÉàÂ¢ÉÁïå: ${region.name}`, {
                        permanent: false, 
                        direction: 'center'
                    });
                });
                
                console.log('‚úÖ „ÉÜ„Çπ„ÉàÂ¢ÉÁïåË°®Á§∫ÂÆå‰∫Ü - Ëµ§„ÅÑÂÜÜ„ÅåË¶ã„Åà„Çã„ÅØ„Åö„Åß„Åô');
            }

            // Ê∞óË±°Â∫ÅÂÖ¨ÂºèTopoJSONÊ¥•Ê≥¢‰∫àÂ†±Âå∫„Éá„Éº„Çø‰ΩøÁî®Ôºà89MB‚Üí1.5MBÊúÄÈÅ©ÂåñÊ∏à„ÅøÔºâ
            async addTsunamiCoastlines() {
                this.tsunamiLayers = [];
                
                try {
                    console.log('üîÑ Ê∞óË±°Â∫ÅÂÖ¨ÂºèÊ¥•Ê≥¢‰∫àÂ†±Âå∫„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
                    
                    // Ë£ΩÂìÅÁâà„É¢„Éº„Éâ: Ê∞óË±°Â∫ÅÂÖ¨ÂºèTopoJSON„Éá„Éº„Çø‰ΩøÁî®  
                    const demoMode = true; // ‰∏ÄÊôÇÁöÑ„Å´„Éá„É¢„É¢„Éº„Éâ„Å´Â§âÊõ¥„Åó„Å¶„ÉÜ„Çπ„Éà
                    
                    let tsunamiData;
                    
                    const loader = new JMATsunamiLoader();
                    let allTsunamiData;
                    
                    if (demoMode) {
                        // „Éá„É¢Áî®Ôºö„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éá„Éº„Çø„ÇíÁõ¥Êé•‰ΩøÁî®
                        allTsunamiData = loader.getFallbackData();
                        // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´ÊâãÂãï„Åß‰øùÂ≠ò
                        loader.cache = allTsunamiData;
                        console.log('üìã „Éá„É¢„É¢„Éº„Éâ: „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éá„Éº„Çø‰ΩøÁî®');
                        
                    } else {
                        // Ë£ΩÂìÅÁâàÔºöTopoJSON„É≠„Éº„ÉÄ„Éº‰ΩøÁî®
                        allTsunamiData = await loader.loadTsunamiAreas();
                        
                        // Áµ±Ë®àÊÉÖÂ†±Ë°®Á§∫
                        const stats = loader.getStatistics();
                        console.log('üìä Ê¥•Ê≥¢‰∫àÂ†±Âå∫Áµ±Ë®à:', stats);
                        console.log('‚úÖ Ê∞óË±°Â∫ÅÂÖ¨Âºè„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê¥•Ê≥¢‰∫àÂ†±Âå∫„ÅÆ„Åø„ÇíÂèñÂæóÔºàËß£Èô§„Åï„Çå„Åü„ÇÇ„ÅÆ„ÇíÈô§Â§ñÔºâ
                    const activeAreas = loader.getActiveAreas();
                    tsunamiData = {
                        type: "FeatureCollection",
                        features: activeAreas
                    };
                    
                    console.log(`üö® „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±: ${activeAreas.length}Âú∞Âüü`);
                    
                    // Âá°‰æã„ÅÆÂú∞ÂüüÊï∞„ÇíÊõ¥Êñ∞
                    const areaCountElement = document.getElementById('tsunami-area-count');
                    if (areaCountElement) {
                        areaCountElement.textContent = activeAreas.length;
                    }
                    
                    // Ê¥•Ê≥¢„Éë„Éç„É´„Å®Âá°‰æã„ÅÆË°®Á§∫Âà∂Âæ°
                    updateTsunamiDisplay(activeAreas);
                    
                    // „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ„Éë„Éç„É´„ÅÆÊ¥•Ê≥¢Âú∞Âüü„ÇíÊõ¥Êñ∞
                    updateTsunamiRegionsPanel(activeAreas);
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê¥•Ê≥¢„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂú∞Âõ≥„É¨„Ç§„É§„Éº„Å®Âá°‰æã„ÇíÈùûË°®Á§∫
                    if (activeAreas.length === 0) {
                        console.log('üö´ Ê¥•Ê≥¢„Éá„Éº„Çø„Å™„Åó: Âú∞Âõ≥„É¨„Ç§„É§„Éº„Å®Âá°‰æã„ÇíÈùûË°®Á§∫');
                        // Êó¢Â≠ò„ÅÆÊ¥•Ê≥¢„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
                        if (this.tsunamiLayers) {
                            this.tsunamiLayers.forEach(layer => {
                                if (layer.layer) this.map.removeLayer(layer.layer);
                            });
                            this.tsunamiLayers = [];
                        }
                        // Ê¥•Ê≥¢„É¨„Ç∏„Çß„É≥„Éâ„ÇíÈùûË°®Á§∫
                        if (this.tsunamiLegend) {
                            this.map.removeControl(this.tsunamiLegend);
                            this.tsunamiLegend = null;
                        }
                        return; // Ê¥•Ê≥¢„É¨„Ç§„É§„Éº‰ΩúÊàê„Çí„Çπ„Ç≠„ÉÉ„Éó
                    }
                    
                    // GeoJSON„É¨„Ç§„É§„Éº‰ΩúÊàê
                    const tsunamiGeoJSON = L.geoJSON(tsunamiData, {
                        style: (feature) => {
                            const status = feature.properties.STATUS || 'advisory';
                            return {
                                color: '#FFD700',           // Ê∞óË±°Â∫ÅÊ®ôÊ∫ñÈªÑËâ≤
                                weight: 2,
                                opacity: 0.9,
                                fillColor: '#FFD700',
                                fillOpacity: 0.6,
                                className: `jma-tsunami-area jma-${status}`
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const props = feature.properties;
                            
                            // Ê∞óË±°Â∫ÅÂÖ¨ÂºèÂΩ¢Âºè„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
                            const popupContent = `
                                <div class="jma-tsunami-popup">
                                    <div class="popup-header">
                                        <span class="popup-icon">üåä</span>
                                        <span class="popup-title">${props.AREA_NAME}</span>
                                        <span class="area-code">Âå∫Âüü„Ç≥„Éº„Éâ: ${props.AREA_CODE || '191'}</span>
                                    </div>
                                    <div class="popup-content">
                                        <div class="popup-row status">
                                            <strong>Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±</strong>
                                        </div>
                                        <div class="popup-row">
                                            <strong>‰∫àÊÉ≥Ê¥•Ê≥¢È´ò:</strong> ${props.WAVE_HEIGHT || '1m'}
                                        </div>
                                        <div class="popup-row">
                                            <strong>Âà∞ÈÅîÁä∂Ê≥Å:</strong> ${props.ARRIVAL_TIME || 'Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö'}
                                        </div>
                                        <div class="popup-footer">
                                            <small>Ê∞óË±°Â∫ÅÂÖ¨ÂºèÊ¥•Ê≥¢‰∫àÂ†±Âå∫„Éá„Éº„Çø‰ΩøÁî® (TopoJSONÊúÄÈÅ©ÂåñÊ∏à„Åø)</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            layer.bindPopup(popupContent, {
                                maxWidth: 340,
                                className: 'jma-tsunami-popup-container'
                            });
                            
                            // Ê∞óË±°Â∫ÅÂΩ¢Âºè„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
                            layer.bindTooltip(`${props.AREA_NAME} (${props.WAVE_HEIGHT || '1m'})`, {
                                permanent: false,
                                direction: 'center',
                                className: 'jma-tsunami-tooltip'
                            });
                            
                            // „É¨„Ç§„É§„ÉºÁÆ°ÁêÜ„Å´ËøΩÂä†
                            this.tsunamiLayers.push({
                                layer: layer,
                                area: props
                            });
                        }
                    }).addTo(this.map);
                    
                    // Ê∞óË±°Â∫ÅÈ¢®„É¨„Ç∏„Çß„É≥„ÉâËøΩÂä†
                    this.addJMATsunamiLegend();
                    
                    // KyoshinEewViewerÈ¢®„Çπ„Çø„Ç§„É´ÈÅ©Áî®
                    this.addKyoshinEewViewerStyles();
                    
                    // Ë£ΩÂìÅÁâàÂÆüË£ÖÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏
                    const message = demoMode ? 
                        'üåä Ê¥•Ê≥¢‰∫àÂ†±Âå∫Ë°®Á§∫ÂÆå‰∫Ü („Éá„É¢Áî®„Éá„Éº„Çø)' :
                        'üåä Ë£ΩÂìÅÁâà: Ê∞óË±°Â∫ÅÂÖ¨ÂºèÊ¥•Ê≥¢‰∫àÂ†±Âå∫„Éá„Éº„ÇøÂÆüË£ÖÂÆå‰∫Ü';
                    console.log(message);
                    
                    // Ë£ΩÂìÅÁâàÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    if (!demoMode) {
                        console.log('üéâ Ë£ΩÂìÅÁâàÂÆüË£ÖÊàêÂäü:');
                        console.log('‚úÖ Ê∞óË±°Â∫ÅÂÖ¨Âºè„Éá„Éº„Çø‰ΩøÁî®');
                        console.log('‚ö° TopoJSONÊúÄÈÅ©Âåñ (È´òÈÄüË™≠„ÅøËæº„Åø)');
                        console.log('üó∫Ô∏è  Ê≠£Á¢∫„Å™Ê¥•Ê≥¢‰∫àÂ†±Âå∫Â¢ÉÁïåË°®Á§∫');
                        console.log('üìä NHK„ÉªKyoshinEewViewerÂêåÁ≠âÂìÅË≥™ÂÆüÁèæ');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Ê¥•Ê≥¢‰∫àÂ†±Âå∫„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂü∫Êú¨Ë°®Á§∫
                    this.addBasicTsunamiDisplay();
                }
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Âü∫Êú¨Ê¥•Ê≥¢Ë°®Á§∫
            addBasicTsunamiDisplay() {
                console.log('üîÑ Âü∫Êú¨Ê¥•Ê≥¢Ë°®Á§∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà');
                // Êó¢Â≠ò„ÅÆ„Éá„É¢„Éá„Éº„Çø„ÅßÊúÄ‰ΩéÈôê„ÅÆË°®Á§∫„ÇíÊèê‰æõ
            }
            
            // Ê∞óË±°Â∫ÅÈ¢®Ê¥•Ê≥¢„É¨„Ç∏„Çß„É≥„ÉâÔºàKyoshinEewViewerÊ∫ñÊã†Ôºâ
            addJMATsunamiLegend() {
                const legend = L.control({ position: 'bottomright' });
                
                legend.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'jma-tsunami-legend');
                    div.innerHTML = `
                        <div class="legend-header">
                            <div class="legend-title">Ê¥•Ê≥¢‰∫àÂ†±Âå∫</div>
                            <div class="legend-subtitle">Êó•Êú¨Â§™Âπ≥Ê¥ãÊ≤øÂ≤∏ÂÖ®‰Ωì</div>
                        </div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-color jma-advisory"></span>
                                Ê¥•Ê≥¢Ê≥®ÊÑèÂ†± (<span id="tsunami-area-count">9</span>Âú∞Âüü)
                            </div>
                        </div>
                        <div class="legend-footer">
                            <small>Ê∞óË±°Â∫ÅÂÖ¨Âºè„Éá„Éº„Çø‰ΩøÁî®</small>
                        </div>
                    `;
                    return div;
                };
                
                legend.addTo(this.map);
                this.tsunamiLegend = legend;
            }
            
            // Ê¥•Ê≥¢„É¨„Éô„É´„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
            getTsunamiLevelText(level) {
                const levelTexts = {
                    'major_warning': 'Â§ßÊ¥•Ê≥¢Ë≠¶Â†±',
                    'warning': 'Ê¥•Ê≥¢Ë≠¶Â†±',
                    'advisory': 'Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±',
                    'forecast': 'Ê¥•Ê≥¢‰∫àÂ†±',
                    'none': 'Ê¥•Ê≥¢„Å™„Åó'
                };
                return levelTexts[level] || level;
            }
            
            // KyoshinEewViewerÈ¢®Ê¥•Ê≥¢Ë°®Á§∫„Çπ„Çø„Ç§„É´ÔºàÊ∞óË±°Â∫ÅÊ∫ñÊã†Ôºâ
            addKyoshinEewViewerStyles() {
                // KyoshinEewViewerÈ¢®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂãïÁöÑ„Å´‰ΩúÊàê
                const style = document.createElement('style');
                style.textContent = `
                    /* KyoshinEewViewerÈ¢® JMAÊ¥•Ê≥¢„Ç®„É™„Ç¢Ë°®Á§∫ */
                    .jma-tsunami-area {
                        cursor: pointer;
                        transition: all 0.15s ease;
                    }
                    
                    .jma-tsunami-area:hover {
                        fill-opacity: 0.8 !important;
                        stroke-width: 3px !important;
                    }
                    
                    /* Ê∞óË±°Â∫ÅÈ¢®Ê¥•Ê≥¢„É¨„Ç∏„Çß„É≥„Éâ */
                    .jma-tsunami-legend {
                        background: rgba(245, 245, 245, 0.95);
                        border: 1px solid #ccc;
                        border-radius: 6px;
                        padding: 10px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        font-family: 'Inter', 'Meiryo UI', sans-serif;
                        font-size: 12px;
                        min-width: 140px;
                    }
                    
                    .legend-header {
                        border-bottom: 1px solid #ddd;
                        margin-bottom: 8px;
                        padding-bottom: 6px;
                    }
                    
                    .legend-title {
                        font-weight: 700;
                        color: #333;
                        font-size: 13px;
                        margin-bottom: 2px;
                    }
                    
                    .legend-subtitle {
                        color: #666;
                        font-size: 10px;
                    }
                    
                    .legend-items {
                        margin-bottom: 6px;
                    }
                    
                    .legend-item {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        color: #333;
                        font-weight: 500;
                        margin-bottom: 4px;
                    }
                    
                    .legend-color {
                        width: 16px;
                        height: 12px;
                        border-radius: 2px;
                        border: 1px solid #aaa;
                        display: inline-block;
                    }
                    
                    .legend-color.jma-advisory {
                        background: #FFD700;
                    }
                    
                    .legend-footer {
                        border-top: 1px solid #eee;
                        padding-top: 4px;
                        text-align: center;
                        color: #888;
                        font-size: 9px;
                    }
                    
                    /* Ê∞óË±°Â∫ÅÈ¢®„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
                    .jma-tsunami-popup {
                        font-family: 'Inter', 'Meiryo UI', sans-serif;
                        background: #f8f9fa;
                        color: #333;
                        border-radius: 6px;
                        padding: 0;
                        border: 2px solid #FFD700;
                        min-width: 280px;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                    }
                    
                    .jma-tsunami-popup .popup-header {
                        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                        padding: 12px;
                        border-radius: 6px 6px 0 0;
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                        border-bottom: 1px solid #ddd;
                    }
                    
                    .jma-tsunami-popup .popup-header .popup-title {
                        font-weight: 700;
                        font-size: 14px;
                        color: #000;
                        margin: 0;
                    }
                    
                    .jma-tsunami-popup .area-code {
                        font-size: 11px;
                        color: #444;
                        font-weight: 500;
                    }
                    
                    .jma-tsunami-popup .popup-content {
                        padding: 12px;
                        background: #fff;
                    }
                    
                    .jma-tsunami-popup .popup-row {
                        margin-bottom: 8px;
                        font-size: 13px;
                        line-height: 1.4;
                    }
                    
                    .jma-tsunami-popup .popup-row.status {
                        color: #FF4500;
                        font-weight: 700;
                        font-size: 14px;
                        margin-bottom: 10px;
                    }
                    
                    .jma-tsunami-popup .popup-footer {
                        border-top: 1px solid #eee;
                        padding: 8px 12px;
                        background: #f1f3f4;
                        border-radius: 0 0 6px 6px;
                        text-align: center;
                    }
                    
                    .jma-tsunami-popup .popup-footer small {
                        color: #666;
                        font-size: 10px;
                    }
                    
                    /* KyoshinEewViewerÈ¢®„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
                    .jma-tsunami-tooltip {
                        background: rgba(255, 215, 0, 0.9) !important;
                        border: 1px solid #B8860B !important;
                        border-radius: 4px !important;
                        color: #000 !important;
                        font-size: 12px !important;
                        font-weight: 600 !important;
                        padding: 6px 10px !important;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
                        text-shadow: none !important;
                        font-family: 'Inter', 'Meiryo UI', sans-serif !important;
                    }
                    
                    /* Leaflet„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÔºàÊ∞óË±°Â∫ÅÈ¢®Ôºâ */
                    .jma-tsunami-popup-container .leaflet-popup-content-wrapper {
                        background: transparent !important;
                        padding: 0 !important;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;
                        border-radius: 6px !important;
                    }
                    
                    .jma-tsunami-popup-container .leaflet-popup-tip {
                        background: #f8f9fa !important;
                        border: 1px solid #FFD700 !important;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
                    }
                    
                    .jma-tsunami-popup-container .leaflet-popup-close-button {
                        color: #333 !important;
                        font-size: 16px !important;
                        font-weight: bold !important;
                        text-shadow: none !important;
                        top: 8px !important;
                        right: 8px !important;
                    }
                    
                    .jma-tsunami-popup-container .leaflet-popup-close-button:hover {
                        color: #000 !important;
                        background: rgba(255, 215, 0, 0.3) !important;
                        border-radius: 50% !important;
                    }
                `;
                document.head.appendChild(style);
                
                console.log('üé® KyoshinEewViewerÈ¢®„Çπ„Çø„Ç§„É´ÈÅ©Áî®ÂÆå‰∫Ü');
            }

            // „Éõ„Éº„É†„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíËøΩÂä†
            addHomeControl() {
                // Leaflet„Ç´„Çπ„Çø„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÇØ„É©„Çπ
                const HomeControl = L.Control.extend({
                    onAdd: (map) => {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom home-control');
                        
                        container.style.backgroundColor = 'rgba(74, 158, 255, 0.9)';
                        container.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDIwVjE0SDEzLjU4NTlWMjBIMTlWMTJIMjJMMTIgM0wyIDEySDE5VjIwSDEwWiIgZmlsbD0id2hpdGUiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo=')";
                        container.style.backgroundSize = '16px 16px';
                        container.style.backgroundRepeat = 'no-repeat';
                        container.style.backgroundPosition = 'center';
                        container.style.width = '30px';
                        container.style.height = '30px';
                        container.style.cursor = 'pointer';
                        container.style.border = '2px solid rgba(255, 255, 255, 0.8)';
                        container.style.borderRadius = '4px';
                        container.style.boxShadow = '0 1px 5px rgba(0,0,0,0.65)';
                        container.style.display = 'none'; // ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÈùûË°®Á§∫
                        container.title = 'ÂàùÊúüÁîªÈù¢„Å´Êàª„Çã';
                        
                        container.onclick = () => {
                            this.returnToHome();
                        };
                        
                        L.DomEvent.disableClickPropagation(container);
                        return container;
                    },
                    
                    onRemove: (map) => {
                        // cleanup
                    }
                });
                
                // „Éõ„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíÂú∞Âõ≥„Å´ËøΩÂä†ÔºàÂ∑¶‰∏ä„Å´ÈÖçÁΩÆÔºâ
                this.mapState.homeControl = new HomeControl({ position: 'topleft' });
                this.mapState.homeControl.addTo(this.map);
            }
            
            // Âú∞Âõ≥ÁßªÂãï„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupMapEventListeners() {
                // Âú∞Âõ≥„ÅÆÁßªÂãï„Éª„Ç∫„Éº„É†„Éª„Éë„É≥„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
                this.map.on('moveend zoomend', () => {
                    this.checkMapPosition();
                });
            }
            
            // Âú∞Âõ≥‰ΩçÁΩÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÂàùÊúüÁîªÈù¢„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
            checkMapPosition() {
                const currentCenter = this.map.getCenter();
                const currentZoom = this.map.getZoom();
                const initialView = this.mapState.initialView;
                
                // ÂàùÊúü‰ΩçÁΩÆ„Å®„ÅÆË∑ùÈõ¢„Å® „Ç∫„Éº„É†„É¨„Éô„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const centerDistance = currentCenter.distanceTo(L.latLng(initialView.center));
                const zoomDifference = Math.abs(currentZoom - initialView.zoom);
                
                // Ë®±ÂÆπÁØÑÂõ≤ÂÜÖÔºàË∑ùÈõ¢50km‰ª•ÂÜÖ„ÄÅ„Ç∫„Éº„É†Â∑Æ1‰ª•‰∏ãÔºâ„Å™„ÇâÂàùÊúüÁîªÈù¢„Å®„Åø„Å™„Åô
                const isAtInitialView = centerDistance < 50000 && zoomDifference <= 1;
                
                if (isAtInitialView !== this.mapState.isAtInitialView) {
                    this.mapState.isAtInitialView = isAtInitialView;
                    this.updateHomeControlVisibility();
                }
            }
            
            // „Éõ„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÊõ¥Êñ∞
            updateHomeControlVisibility() {
                if (this.mapState.homeControl) {
                    const container = this.mapState.homeControl.getContainer();
                    if (container) {
                        if (this.mapState.isAtInitialView) {
                            container.style.display = 'none';
                        } else {
                            container.style.display = 'block';
                            // „Éï„Çß„Éº„Éâ„Ç§„É≥ÂäπÊûú
                            container.style.opacity = '0';
                            setTimeout(() => {
                                container.style.transition = 'opacity 0.3s ease';
                                container.style.opacity = '1';
                            }, 50);
                        }
                    }
                }
            }
            
            // ÂàùÊúüÁîªÈù¢„Å´Êàª„Çã
            returnToHome() {
                const initialView = this.mapState.initialView;
                this.map.setView(initialView.center, initialView.zoom, {
                    animate: true,
                    duration: 1.0
                });
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('üè†', 'Âú∞Âõ≥„ÇíÂàùÊúüÁîªÈù¢„Å´Êàª„Åó„Åæ„Åó„Åü', new Date());
                console.log('üè† Map returned to initial view');
            }

            connectWebSocket() {
                try {
                    // Êé•Á∂öË©¶Ë°å‰∏≠Áä∂ÊÖã„ÇíË°®Á§∫
                    this.updateConnectionStatus('p2p-status', false);
                    
                    // WebSocketÊé•Á∂öÂâç„ÅÆ‰∫ãÂâç„ÉÅ„Çß„ÉÉ„ÇØ
                    this.preConnectionCheck();
                    
                    this.websocket = new WebSocket('wss://api.p2pquake.net/v2/ws');
                    
                    // Êé•Á∂ö„Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆö
                    const connectionTimeout = setTimeout(() => {
                        if (this.websocket.readyState === WebSocket.CONNECTING) {
                            this.websocket.close();
                            console.warn('‚ö†Ô∏è WebSocket connection timeout');
                            this.addActivityFeedItem('‚ö†Ô∏è', 'P2PÊé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', new Date());
                        }
                    }, 10000); // 10Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                    
                    this.websocket.onopen = () => {
                        clearTimeout(connectionTimeout);
                        
                        // Êé•Á∂öÊàêÂäüÊôÇ„Å´ÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Çí„É™„Çª„ÉÉ„Éà
                        this.reconnectAttempts = 0;
                        
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÂÅúÊ≠¢
                        this.stopFallbackMode();
                        
                        console.log('üîå WebSocket connected');
                        this.updateConnectionStatus('p2p-status', true);
                        this.addActivityFeedItem('üü¢', 'P2PÂú∞ÈúáÊÉÖÂ†±„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', new Date());
                    };

                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleEarthquakeData(data);
                            this.stats.dataPackets++;
                            this.updateStats();
                        } catch (parseError) {
                            console.warn('‚ö†Ô∏è Failed to parse WebSocket message:', parseError);
                        }
                    };

                    this.websocket.onerror = (error) => {
                        clearTimeout(connectionTimeout);
                        
                        // „Ç®„É©„Éº„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
                        let errorMessage = 'WebSocketÊé•Á∂ö„Ç®„É©„Éº';
                        if (error.type) {
                            errorMessage += ` (${error.type})`;
                        }
                        if (error.target && error.target.url) {
                            errorMessage += ` - URL: ${error.target.url}`;
                        }
                        if (error.target && error.target.readyState !== undefined) {
                            const states = ['Êé•Á∂ö‰∏≠', 'Êé•Á∂öÊ∏à„Åø', 'ÂàáÊñ≠‰∏≠', 'ÂàáÊñ≠Ê∏à„Åø'];
                            errorMessage += ` - Áä∂ÊÖã: ${states[error.target.readyState] || error.target.readyState}`;
                        }
                        
                        console.error('‚ùå P2P WebSocketÊé•Á∂öÂ§±Êïó:', errorMessage);
                        this.updateConnectionStatus('p2p-status', false);
                        this.addActivityFeedItem('‚ùå', errorMessage, new Date());
                        
                        // Ë©≥Á¥∞Ë®∫Êñ≠„ÇíÂÆüË°å
                        this.diagnoseWebSocketIssue(error, { target: error.target });
                        
                        // ÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„ÇíÂà∂Èôê
                        if ((this.reconnectAttempts || 0) < 5) {
                            const retryDelay = Math.min(3000 * Math.pow(1.5, this.reconnectAttempts || 0), 15000);
                            this.reconnectAttempts = (this.reconnectAttempts || 0) + 1;
                            
                            console.log(`üîÑ ${retryDelay/1000}ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å„Åó„Åæ„Åô (Ë©¶Ë°åÂõûÊï∞: ${this.reconnectAttempts}/5)`);
                            this.addActivityFeedItem('üîÑ', `${retryDelay/1000}ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å„Åó„Åæ„Åô (${this.reconnectAttempts}/5)`, new Date());
                            
                            setTimeout(() => {
                                this.connectWebSocket();
                            }, retryDelay);
                        } else {
                            console.warn('‚ö†Ô∏è ÊúÄÂ§ßÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂ±•Ê≠¥API„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
                            this.addActivityFeedItem('‚ö†Ô∏è', 'ÊúÄÂ§ßÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂ±•Ê≠¥API„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ', new Date());
                            this.startFallbackMode();
                        }
                    };

                    this.websocket.onclose = (event) => {
                        clearTimeout(connectionTimeout);
                        
                        // ÂàáÊñ≠„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
                        let closeMessage = 'P2PÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü';
                        if (event.code) {
                            closeMessage += ` („Ç≥„Éº„Éâ: ${event.code})`;
                        }
                        if (event.reason) {
                            closeMessage += ` - ÁêÜÁî±: ${event.reason}`;
                        }
                        
                        console.log('üîå WebSocket disconnected:', closeMessage);
                        this.updateConnectionStatus('p2p-status', false);
                        this.addActivityFeedItem('üî¥', closeMessage, new Date());
                        
                        // ÂàáÊñ≠ÊôÇ„ÅÆË©≥Á¥∞Ë®∫Êñ≠„ÇíÂÆüË°å
                        this.diagnoseWebSocketIssue(null, event);
                        
                        // Ê≠£Â∏∏„Å™ÂàáÊñ≠Ôºà„Ç≥„Éº„Éâ1000Ôºâ„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÂÜçÊé•Á∂ö„ÇíË©¶Ë°å
                        if (event.code !== 1000 && (this.reconnectAttempts || 0) < 5) {
                            const retryDelay = Math.min(3000 * Math.pow(1.5, this.reconnectAttempts || 0), 15000);
                        this.reconnectAttempts = (this.reconnectAttempts || 0) + 1;
                            
                            console.log(`üîÑ ${retryDelay/1000}ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å„Åó„Åæ„Åô (Ë©¶Ë°åÂõûÊï∞: ${this.reconnectAttempts}/5)`);
                            this.addActivityFeedItem('üîÑ', `${retryDelay/1000}ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å„Åó„Åæ„Åô (${this.reconnectAttempts}/5)`, new Date());
                        
                        setTimeout(() => {
                            this.connectWebSocket();
                        }, retryDelay);
                        } else if (event.code !== 1000) {
                            console.warn('‚ö†Ô∏è ÊúÄÂ§ßÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂ±•Ê≠¥API„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
                            this.addActivityFeedItem('‚ö†Ô∏è', 'ÊúÄÂ§ßÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂ±•Ê≠¥API„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ', new Date());
                            this.startFallbackMode();
                        }
                    };
                } catch (error) {
                    console.error('‚ùå WebSocket connection failed:', error);
                    this.updateConnectionStatus('p2p-status', false);
                    this.addActivityFeedItem('‚ùå', `WebSocketÊé•Á∂ö„Ç®„É©„Éº: ${error.message}`, new Date());
                    
                    // Ë®∫Êñ≠Ê©üËÉΩ„ÇíËøΩÂä†
                    this.diagnoseWebSocketIssue(error, null);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´ÁßªË°å
                    this.startFallbackMode();
                }
            }

            // WebSocketÊé•Á∂öÂâç„ÅÆ‰∫ãÂâç„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩ
            preConnectionCheck() {
                console.log('üîç WebSocketÊé•Á∂ö‰∫ãÂâç„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å...');
                
                // 1. „Éñ„É©„Ç¶„Ç∂„Çµ„Éù„Éº„ÉàÁ¢∫Ë™ç
                if (typeof WebSocket === 'undefined') {
                    console.error('‚ùå WebSocket API„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    this.addActivityFeedItem('‚ùå', 'WebSocket API„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', new Date());
                    return false;
                }
                
                // 2. „Çª„Ç≠„É•„Ç¢Áí∞Â¢ÉÁ¢∫Ë™ç
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('‚ö†Ô∏è Èùû„Çª„Ç≠„É•„Ç¢Áí∞Â¢É„Åß„ÅÆWSSÊé•Á∂ö„ÅØÂà∂Èôê„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô');
                    this.addActivityFeedItem('‚ö†Ô∏è', 'Èùû„Çª„Ç≠„É•„Ç¢Áí∞Â¢É„Åß„ÅÆWSSÊé•Á∂ö„ÅØÂà∂Èôê„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô', new Date());
                }
                
                // 3. „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁ¢∫Ë™çÔºàHTTP API„ÅßÁ¢∫Ë™çÔºâ
                this.checkNetworkConnectivity();
                
                return true;
            }

            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁ¢∫Ë™ç
            async checkNetworkConnectivity() {
                try {
                    console.log('üåê „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁ¢∫Ë™ç‰∏≠...');
                    const response = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=1', {
                        method: 'HEAD',
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        console.log('‚úÖ „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÊ≠£Â∏∏ - P2P API„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ');
                        this.addActivityFeedItem('‚úÖ', '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÊ≠£Â∏∏', new Date());
                        return true;
                    } else {
                        console.warn(`‚ö†Ô∏è P2P APIÂøúÁ≠îÁï∞Â∏∏: ${response.status}`);
                        this.addActivityFeedItem('‚ö†Ô∏è', `P2P APIÂøúÁ≠îÁï∞Â∏∏: ${response.status}`, new Date());
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁ¢∫Ë™çÂ§±Êïó:', error.message);
                    this.addActivityFeedItem('‚ùå', `„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂öÁ¢∫Ë™çÂ§±Êïó: ${error.message}`, new Date());
                    return false;
                }
            }

            // ÊîπÂñÑ„Åï„Çå„ÅüWebSocketË®∫Êñ≠Ê©üËÉΩ
            diagnoseWebSocketIssue(error, event) {
                console.log('üîç WebSocketË®∫Êñ≠„ÇíÂÆüË°å...');
                
                const diagnosis = [];
                
                // „Ç®„É©„Éº„Çø„Ç§„ÉóÂàÜÊûê
                if (error) {
                    diagnosis.push(`„Ç®„É©„Éº„Çø„Ç§„Éó: ${error.type || 'unknown'}`);
                    diagnosis.push(`„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏: ${error.message || 'N/A'}`);
                }
                
                // Êé•Á∂öÁä∂ÊÖãÂàÜÊûê
                if (event && event.target) {
                    const states = ['Êé•Á∂ö‰∏≠', 'Êé•Á∂öÊ∏à„Åø', 'ÂàáÊñ≠‰∏≠', 'ÂàáÊñ≠Ê∏à„Åø'];
                    diagnosis.push(`Êé•Á∂öÁä∂ÊÖã: ${states[event.target.readyState] || event.target.readyState}`);
                    diagnosis.push(`Êé•Á∂öURL: ${event.target.url || 'N/A'}`);
                }
                
                // ÂàáÊñ≠„Ç≥„Éº„ÉâÂàÜÊûê
                if (event && event.code) {
                    const commonCodes = {
                        1000: 'Ê≠£Â∏∏ÂàáÊñ≠',
                        1001: '„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÈõ¢ËÑ±',
                        1002: '„Éó„É≠„Éà„Ç≥„É´„Ç®„É©„Éº',
                        1003: 'Êú™„Çµ„Éù„Éº„Éà„Éá„Éº„Çø',
                        1006: 'Áï∞Â∏∏ÂàáÊñ≠Ôºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂïèÈ°å„ÅÆÂèØËÉΩÊÄßÔºâ',
                        1011: '„Çµ„Éº„Éê„ÉºÂÜÖÈÉ®„Ç®„É©„Éº',
                        1012: '„Çµ„Éº„Éê„ÉºÂÜçËµ∑Âãï',
                        1013: '„Çµ„Éº„Éê„Éº‰∏ÄÊôÇÁöÑÂà©Áî®‰∏çÂèØ'
                    };
                    
                    diagnosis.push(`ÂàáÊñ≠„Ç≥„Éº„Éâ: ${event.code} (${commonCodes[event.code] || '‰∏çÊòé'})`);
                    if (event.reason) {
                        diagnosis.push(`ÂàáÊñ≠ÁêÜÁî±: ${event.reason}`);
                    }
                }
                
                // Ë®∫Êñ≠ÁµêÊûú„Çí„É≠„Ç∞„Å´Ë®òÈå≤
                console.log('üìã WebSocketË®∫Êñ≠ÁµêÊûú:');
                diagnosis.forEach(item => console.log(`  - ${item}`));
                
                // „É¶„Éº„Ç∂„Éº„Å´Ë®∫Êñ≠ÁµêÊûú„ÇíË°®Á§∫
                this.addActivityFeedItem('üîç', `WebSocketË®∫Êñ≠: ${diagnosis.join(', ')}`, new Date());
                
                return diagnosis;
            }

            // ÊâãÂãï„ÅßWebSocketÂÜçÊé•Á∂ö„ÇíË©¶Ë°å„Åô„ÇãÈñ¢Êï∞
            reconnectWebSocket() {
                console.log('üîÑ ÊâãÂãï„ÅßWebSocketÂÜçÊé•Á∂ö„ÇíÈñãÂßã...');
                this.addActivityFeedItem('üîÑ', 'ÊâãÂãï„ÅßWebSocketÂÜçÊé•Á∂ö„ÇíÈñãÂßã...', new Date());
                
                // Êó¢Â≠ò„ÅÆÊé•Á∂ö„ÇíÂàáÊñ≠
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                
                // ÂÜçÊé•Á∂öË©¶Ë°åÂõûÊï∞„Çí„É™„Çª„ÉÉ„Éà
                this.reconnectAttempts = 0;
                
                // ÂÜçÊé•Á∂öÂÆüË°å
                this.connectWebSocket();
            }

            // WebSocketÊé•Á∂öÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÈñãÂßã
            startFallbackMode() {
                console.log('üîÑ „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÈñãÂßã: P2PÂ±•Ê≠¥API„Çí‰ΩøÁî®„Åó„ÅüÂÆöÊúüÊõ¥Êñ∞');
                this.addActivityFeedItem('üîÑ', '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ: P2PÂ±•Ê≠¥API„ÅßÂÆöÊúüÊõ¥Êñ∞„ÇíÈñãÂßã', new Date());
                
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
                this.fallbackMode = true;
                
                // Êé•Á∂öÁä∂ÊÖã„ÇíÈÉ®ÂàÜÁöÑÊé•Á∂ö„Å®„Åó„Å¶Ë°®Á§∫
                this.updateConnectionStatus('p2p-status', 'partial');
                
                // Êó¢Â≠ò„ÅÆÂ±•Ê≠¥„Éá„Éº„ÇøÂèñÂæóÈñìÈöî„ÇíÁü≠Á∏ÆÔºà30ÁßíÈñìÈöî„Å´Â§âÊõ¥Ôºâ
                if (this.fallbackInterval) {
                    clearInterval(this.fallbackInterval);
                }
                
                // Âç≥Â∫ß„Å´Â±•Ê≠¥„Éá„Éº„Çø„ÇíÂèñÂæó
                this.loadHistoricalData();
                
                // 30ÁßíÈñìÈöî„ÅßÂ±•Ê≠¥„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                this.fallbackInterval = setInterval(() => {
                    this.loadHistoricalData();
                }, 30000);
                
                this.addActivityFeedItem('‚ÑπÔ∏è', '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ: 30ÁßíÈñìÈöî„Åß„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åô', new Date());
            }

            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÂÅúÊ≠¢ÔºàWebSocketÊé•Á∂öÂæ©ÊóßÊôÇÔºâ
            stopFallbackMode() {
                if (this.fallbackMode) {
                    console.log('‚úÖ „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÁµÇ‰∫Ü: WebSocketÊé•Á∂öÂæ©Êóß');
                    this.addActivityFeedItem('‚úÖ', 'WebSocketÊé•Á∂öÂæ©Êóß: „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâÁµÇ‰∫Ü', new Date());
                    
                    this.fallbackMode = false;
                    
                    if (this.fallbackInterval) {
                        clearInterval(this.fallbackInterval);
                        this.fallbackInterval = null;
                    }
                }
            }

            handleEarthquakeData(data) {
                if (data.code === 551) { // Âú∞ÈúáÊÉÖÂ†±
                    const earthquake = this.parseEarthquakeData(data);
                    this.earthquakeHistory.unshift(earthquake);
                    
                    // Â±•Ê≠¥„ÇíÊúÄÊñ∞10‰ª∂„Å´Âà∂Èôê
                    if (this.earthquakeHistory.length > 10) {
                        this.earthquakeHistory = this.earthquakeHistory.slice(0, 10);
                    }
                    
                    this.updateEarthquakeDisplay();
                    this.updateMapMarkers();
                    this.updateOverlayInfo(earthquake);
                    this.updateStatistics(earthquake);
                    
                    // ÈÄöÁü•Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    this.checkAndSendNotification(earthquake);
                    
                    this.addActivityFeedItem('üî¥', 
                        `Âú∞ÈúáÁô∫Áîü: ${earthquake.location} M${earthquake.magnitude} ÈúáÂ∫¶${earthquake.maxIntensity}`, 
                        new Date()
                    );
                    
                    console.log(`üåè Earthquake detected: ${earthquake.location} M${earthquake.magnitude}`);
                }
            }
            
            // ÈÄöÁü•Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÈÄÅ‰ø°
            checkAndSendNotification(earthquake) {
                const magnitude = earthquake.magnitude || 0;
                const intensity = this.getNumericIntensity(earthquake.maxIntensity);
                
                // Ë®≠ÂÆöÂÄ§„Å®ÊØîËºÉ
                const shouldNotify = magnitude >= this.settings.magnitudeThreshold || 
                                   intensity >= this.settings.intensityThreshold;
                
                if (shouldNotify && this.settings.notifications) {
                    // „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•
                    if (Notification.permission === 'granted') {
                        new Notification('üåè Âú∞ÈúáÁô∫ÁîüË≠¶Â†±', {
                            body: `${earthquake.location}\nM${magnitude.toFixed(1)} ÈúáÂ∫¶${earthquake.maxIntensity}\n${earthquake.time.toLocaleString('ja-JP')}`,
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNlMTcwNTUiLz4KPHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo=',
                            requireInteraction: true // ÈáçË¶Å„Å™ÈÄöÁü•„Å™„ÅÆ„ÅßÊâãÂãï„ÅßÈñâ„Åò„Çã„Åæ„ÅßË°®Á§∫
                        });
                    }
                    
                    // Èü≥Â£∞„Ç¢„É©„Éº„ÉàÔºà3ÂõûÁπ∞„ÇäËøî„ÅóÔºâ
                    this.playAlertSound(3);
                    
                    this.addActivityFeedItem('üö®', 
                        `Ë≠¶Â†±Áô∫‰ø°: M${magnitude.toFixed(1)} ÈúáÂ∫¶${earthquake.maxIntensity} (ÈñæÂÄ§: M${this.settings.magnitudeThreshold} ÈúáÂ∫¶${this.settings.intensityThreshold})`, 
                        new Date()
                    );
                    
                    console.log(`üö® Alert triggered: M${magnitude.toFixed(1)} intensity ${earthquake.maxIntensity}`);
                } else {
                    console.log(`‚ÑπÔ∏è No alert: M${magnitude.toFixed(1)} intensity ${earthquake.maxIntensity} (below thresholds)`);
                }
            }

            parseEarthquakeData(data) {
                const eq = data.earthquake || {};
                const hypocenter = eq.hypocenter || {};
                
                return {
                    id: `${data.time}-${hypocenter.name}`,
                    time: new Date(data.time),
                    location: hypocenter.name || '‰∏çÊòé',
                    magnitude: hypocenter.magnitude || 0,
                    depth: hypocenter.depth || 0,
                    latitude: hypocenter.latitude || 0,
                    longitude: hypocenter.longitude || 0,
                    maxIntensity: this.parseIntensity(eq.maxScale) || '‰∏çÊòé',
                    points: data.points || []
                };
            }

            parseIntensity(scale) {
                const intensityMap = {
                    10: '1', 20: '2', 30: '3', 40: '4',
                    45: '5Âº±', 50: '5Âº∑', 55: '6Âº±', 60: '6Âº∑', 70: '7'
                };
                return intensityMap[scale] || scale?.toString() || '‰∏çÊòé';
            }

            updateEarthquakeDisplay() {
                const container = document.getElementById('earthquake-history');
                
                if (this.earthquakeHistory.length === 0) {
                    container.innerHTML = `
                        <div class="loading">
                            <div class="loading-text">Âú∞Èúá„Éá„Éº„Çø„ÇíÂæÖÊ©ü‰∏≠...</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.earthquakeHistory.map(eq => `
                    <div class="earthquake-item fade-in" onclick="selectEarthquake('${eq.id}')">
                        <div class="earthquake-header">
                            <span class="magnitude">M${eq.magnitude.toFixed(1)}</span>
                            <span class="intensity">ÈúáÂ∫¶${eq.maxIntensity}</span>
                        </div>
                        <div class="earthquake-location">${eq.location}</div>
                        <div class="earthquake-time">${eq.time.toLocaleString('ja-JP')}</div>
                    </div>
                `).join('');
            }

            updateMapMarkers() {
                // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        this.map.removeLayer(layer);
                    }
                });

                // ÊúÄÊñ∞„ÅÆÂú∞Èúá„Å´„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
                this.earthquakeHistory.forEach((eq, index) => {
                    if (eq.latitude && eq.longitude) {
                        const opacity = 1 - (index * 0.1); // Âè§„ÅÑ„ÇÇ„ÅÆ„Åª„Å©ËñÑ„Åè
                        
                        const marker = L.circleMarker([eq.latitude, eq.longitude], {
                            radius: Math.max(8, eq.magnitude * 2.5),
                            fillColor: this.getEarthquakeColor(eq.magnitude),
                            color: '#ffffff',
                            weight: 3,
                            opacity: opacity,
                            fillOpacity: opacity * 0.9,
                            className: 'earthquake-marker'
                        }).addTo(this.map);

                        marker.bindPopup(`
                            <div style="color: white; background: transparent;">
                                <strong>${eq.location}</strong><br>
                                M${eq.magnitude.toFixed(1)} ÈúáÂ∫¶${eq.maxIntensity}<br>
                                Ê∑±„Åï: ${eq.depth}km<br>
                                ${eq.time.toLocaleString('ja-JP')}
                            </div>
                        `);
                    }
                });
            }

            getEarthquakeColor(magnitude) {
                if (magnitude >= 7) return '#9C27B0';
                if (magnitude >= 6) return '#E91E63';
                if (magnitude >= 5) return '#FF5722';
                if (magnitude >= 4) return '#FF9800';
                if (magnitude >= 3) return '#FFC107';
                return '#4CAF50';
            }

            updateOverlayInfo(earthquake) {
                const latitudeEl = document.getElementById('latitude');
                if (latitudeEl) {
                    latitudeEl.textContent = earthquake.latitude ? `${earthquake.latitude.toFixed(3)}¬∞` : '---.---¬∞';
                }
                
                const longitudeEl = document.getElementById('longitude');
                if (longitudeEl) {
                    longitudeEl.textContent = earthquake.longitude ? `${earthquake.longitude.toFixed(3)}¬∞` : '---.---¬∞';
                }
                
                const depthEl = document.getElementById('depth');
                if (depthEl) {
                    depthEl.textContent = earthquake.depth ? `${earthquake.depth} km` : '-- km';
                }
                
                const magnitudeEl = document.getElementById('magnitude');
                if (magnitudeEl) {
                    magnitudeEl.textContent = earthquake.magnitude ? `M${earthquake.magnitude.toFixed(1)}` : 'M-.-';
                }
            }

            updateStatistics(earthquake) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

                // ‰ªäÊó•„ÅÆÂú∞ÈúáÊï∞
                this.stats.todayCount = this.earthquakeHistory.filter(eq => 
                    eq.time >= today
                ).length;

                // ‰ªäÈÄ±„ÅÆÂú∞ÈúáÊï∞
                this.stats.weekCount = this.earthquakeHistory.filter(eq => 
                    eq.time >= weekAgo
                ).length;

                // ÊúÄÂ§ßÈúáÂ∫¶
                const maxIntensityEq = this.earthquakeHistory.reduce((max, eq) => {
                    const currentIntensity = this.getNumericIntensity(eq.maxIntensity);
                    const maxIntensity = this.getNumericIntensity(max.maxIntensity);
                    return currentIntensity > maxIntensity ? eq : max;
                }, { maxIntensity: '0' });
                
                this.stats.maxIntensity = maxIntensityEq.maxIntensity;
                this.updateStats();
            }

            getNumericIntensity(intensity) {
                const intensityMap = {
                    '1': 1, '2': 2, '3': 3, '4': 4,
                    '5Âº±': 4.5, '5Âº∑': 5.5, '6Âº±': 5.5, '6Âº∑': 6.5, '7': 7
                };
                return intensityMap[intensity] || 0;
            }

            updateStats() {
                const todayCountEl = document.getElementById('today-count');
                if (todayCountEl) {
                    todayCountEl.textContent = this.stats.todayCount;
                }
                
                const weekCountEl = document.getElementById('week-count');
                if (weekCountEl) {
                    weekCountEl.textContent = this.stats.weekCount;
                }
                
                const maxIntensityEl = document.getElementById('max-intensity');
                if (maxIntensityEl) {
                    maxIntensityEl.textContent = this.stats.maxIntensity;
                }
                
                const dataPacketsEl = document.getElementById('data-packets');
                if (dataPacketsEl) {
                    dataPacketsEl.textContent = this.stats.dataPackets;
                }
                
                const responseTimeEl = document.getElementById('response-time');
                if (responseTimeEl) {
                    responseTimeEl.textContent = `${this.stats.responseTime}ms`;
                }
            }

            updateConnectionStatus(elementId, status) {
                const element = document.getElementById(elementId);
                if (element) {
                    // ÂÖ®„Å¶„ÅÆÁä∂ÊÖã„ÇØ„É©„Çπ„ÇíÂâäÈô§
                    element.classList.remove('connected', 'partial');
                    
                    // Êñ∞„Åó„ÅÑÁä∂ÊÖã„ÇíË®≠ÂÆö
                    if (status === true || status === 'connected') {
                        element.classList.add('connected');
                    } else if (status === 'partial') {
                        element.classList.add('partial');
                    }
                    // false „Åæ„Åü„ÅØ 'disconnected' „ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÔºàËµ§Ôºâ„ÅÆ„Åæ„Åæ
                }
            }

            addActivityFeedItem(icon, text, time) {
                // „É°„É¢„É™ÂÜÖ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„ÇíÁÆ°ÁêÜ
                if (!this.activityLog) {
                    this.activityLog = [];
                }
                
                const logEntry = {
                    icon: icon,
                    text: text,
                    time: time
                };
                
                this.activityLog.unshift(logEntry);
                
                // ÊúÄÂ§ß20‰ª∂„Å´Âà∂Èôê
                if (this.activityLog.length > 20) {
                    this.activityLog = this.activityLog.slice(0, 20);
                }
                
                // Ë®≠ÂÆö„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„Åì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÊõ¥Êñ∞
                const settingsFeed = document.getElementById('settings-activity-feed');
                if (settingsFeed) {
                    this.updateActivityFeedDisplay(settingsFeed);
                }
            }
            
            updateActivityFeedDisplay(container) {
                if (!this.activityLog || this.activityLog.length === 0) {
                    container.innerHTML = `
                        <div class="feed-item">
                            <div class="feed-icon">üü¢</div>
                            <div class="feed-content">
                                <div class="feed-text">„Ç∑„Çπ„ÉÜ„É†„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü</div>
                                <div class="feed-time">${this.startTime.toLocaleTimeString('ja-JP')}</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.activityLog.map(log => `
                    <div class="feed-item">
                        <div class="feed-icon">${log.icon}</div>
                        <div class="feed-content">
                            <div class="feed-text">${log.text}</div>
                            <div class="feed-time">${log.time.toLocaleTimeString('ja-JP')}</div>
                        </div>
                    </div>
                `).join('');
            }

            async loadHistoricalData() {
                try {
                    console.log('üìö Loading historical earthquake data...');
                    
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„ÅßAPI„É™„ÇØ„Ç®„Çπ„Éà
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                    
                    const response = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=10', {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // „Éá„Éº„Çø„Çí‰∏¶ÂàóÂá¶ÁêÜ„ÅßÈ´òÈÄüÂåñ
                    this.earthquakeHistory = data.map(item => this.parseEarthquakeData(item));
                    
                    // UIÊõ¥Êñ∞„Çí‰∏¶ÂàóÂÆüË°å
                    await Promise.all([
                        this.updateEarthquakeDisplayAsync(),
                        this.updateMapMarkersAsync()
                    ]);
                    
                    if (this.earthquakeHistory.length > 0) {
                        this.updateOverlayInfo(this.earthquakeHistory[0]);
                        this.updateStatistics(this.earthquakeHistory[0]);
                    }
                    
                    this.addActivityFeedItem('üìä', `ÈÅéÂéª„ÅÆÂú∞Èúá„Éá„Éº„Çø ${data.length}‰ª∂„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, new Date());
                    console.log(`‚úÖ Loaded ${data.length} historical earthquake records in optimized mode`);
                } catch (error) {
                    console.error('‚ùå Failed to load historical data:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç≠„É£„ÉÉ„Ç∑„É•„Åæ„Åü„ÅØ„Çµ„É≥„Éó„É´„Éá„Éº„Çø„Çí‰ΩøÁî®
                    this.loadFallbackData();
                    
                    if (error.name === 'AbortError') {
                        this.addActivityFeedItem('‚ö†Ô∏è', '„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºà„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË°®Á§∫Ôºâ', new Date());
                    } else {
                        this.addActivityFeedItem('‚ö†Ô∏è', `Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó: ${error.message}`, new Date());
                    }
                }
            }
            
            async updateEarthquakeDisplayAsync() {
                return new Promise(resolve => {
                    requestAnimationFrame(() => {
                        this.updateEarthquakeDisplay();
                        resolve();
                    });
                });
            }
            
            async updateMapMarkersAsync() {
                return new Promise(resolve => {
                    requestAnimationFrame(() => {
                        this.updateMapMarkers();
                        resolve();
                    });
                });
            }
            
            loadFallbackData() {
                // „Çµ„É≥„Éó„É´Âú∞Èúá„Éá„Éº„ÇøÔºàÊé•Á∂öÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                this.earthquakeHistory = [
                    {
                        id: 'sample-1',
                        time: new Date(),
                        location: 'Êé•Á∂ö„Ç®„É©„Éº - „Çµ„É≥„Éó„É´„Éá„Éº„Çø',
                        magnitude: 0,
                        depth: 0,
                        latitude: 36.0,
                        longitude: 138.0,
                        maxIntensity: '-',
                        points: []
                    }
                ];
                
                this.updateEarthquakeDisplay();
                this.updateMapMarkers();
                
                console.log('üîÑ Fallback data loaded');
            }

            startPerformanceMonitoring() {
                setInterval(() => {
                    // „É°„É¢„É™‰ΩøÁî®Èáè„ÅÆÁõ£Ë¶ñ
                    if (performance.memory) {
                        const memoryUsageEl = document.getElementById('memory-usage');
                        if (memoryUsageEl) {
                            const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                            memoryUsageEl.textContent = `${memoryMB}MB`;
                        }
                    }
                    
                    // Ê¥ªÁô∫Âú∞ÂüüÊï∞„ÅÆÊõ¥Êñ∞
                    const activeRegionsEl = document.getElementById('active-regions');
                    if (activeRegionsEl && this.earthquakeHistory) {
                        const activeRegions = new Set(this.earthquakeHistory.map(eq => eq.location)).size;
                        activeRegionsEl.textContent = activeRegions;
                    }
                }, 5000);
            }

            showIntensityPopup(earthquake) {
                // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                this.closeIntensityPopup();
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                overlay.id = 'intensity-popup-overlay';
                overlay.onclick = () => this.closeIntensityPopup();
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó‰ΩúÊàê
                const popup = document.createElement('div');
                popup.className = 'intensity-popup';
                popup.id = 'intensity-popup';
                
                // „Éò„ÉÉ„ÉÄ„Éº
                const header = `
                    <div class="popup-header">
                        <h3 class="popup-title">üåè Âú∞ÈúáË©≥Á¥∞ÊÉÖÂ†±</h3>
                        <button class="popup-close" onclick="window.monitor.closeIntensityPopup()">√ó</button>
                    </div>
                `;
                
                // Âú∞ÈúáÊ¶ÇË¶Å
                const summary = `
                    <div class="earthquake-summary">
                        <div style="font-size: 16px; font-weight: 600; color: #f7fafc; margin-bottom: 8px;">
                            ${earthquake.location}
                        </div>
                        <div style="font-size: 14px; color: #a0aec0; margin-bottom: 12px;">
                            ${earthquake.time.toLocaleString('ja-JP')}
                        </div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„Éâ</div>
                                <div class="summary-value">M${earthquake.magnitude.toFixed(1)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ÊúÄÂ§ßÈúáÂ∫¶</div>
                                <div class="summary-value">ÈúáÂ∫¶${earthquake.maxIntensity}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Ê∑±„Åï</div>
                                <div class="summary-value">${earthquake.depth}km</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Â∫ßÊ®ô</div>
                                <div class="summary-value">${earthquake.latitude.toFixed(2)}¬∞, ${earthquake.longitude.toFixed(2)}¬∞</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ÈúáÂ∫¶ÊÉÖÂ†±
                let intensityContent = '';
                if (earthquake.points && earthquake.points.length > 0) {
                    // ÈúáÂ∫¶Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
                    const intensityGroups = {};
                    earthquake.points.forEach(point => {
                        const intensity = this.parseIntensity(point.scale);
                        if (!intensityGroups[intensity]) {
                            intensityGroups[intensity] = [];
                        }
                        intensityGroups[intensity].push(point.addr);
                    });
                    
                    // ÈúáÂ∫¶„ÅÆÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                    const sortedIntensities = Object.keys(intensityGroups).sort((a, b) => {
                        return this.getNumericIntensity(b) - this.getNumericIntensity(a);
                    });
                    
                    intensityContent = `
                        <div style="font-size: 16px; font-weight: 600; color: #74b9ff; margin-bottom: 12px;">
                            üìç ÂêÑÂú∞„ÅÆÈúáÂ∫¶ÊÉÖÂ†±
                        </div>
                        <div class="intensity-list">
                    `;
                    
                    sortedIntensities.forEach(intensity => {
                        const regions = intensityGroups[intensity];
                        const intensityColor = this.getIntensityColor(intensity);
                        
                        intensityContent += `
                            <div class="intensity-section">
                                <div class="intensity-header" style="background: ${intensityColor};">
                                    <span>ÈúáÂ∫¶${intensity}</span>
                                    <span>${regions.length}Âú∞Âüü</span>
                                </div>
                                <div class="intensity-regions">
                        `;
                        
                        regions.forEach(region => {
                            intensityContent += `<div class="region-item">${region}</div>`;
                        });
                        
                        intensityContent += `
                                </div>
                            </div>
                        `;
                    });
                    
                    intensityContent += '</div>';
                } else {
                    intensityContent = `
                        <div style="font-size: 16px; font-weight: 600; color: #74b9ff; margin-bottom: 12px;">
                            üìç ÈúáÂ∫¶ÊÉÖÂ†±
                        </div>
                        <div style="color: #a0aec0; text-align: center; padding: 20px;">
                            Ë©≥Á¥∞„Å™ÈúáÂ∫¶ÊÉÖÂ†±„ÅØÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì
                        </div>
                    `;
                }
                
                popup.innerHTML = header + summary + intensityContent;
                
                // DOM „Å´ËøΩÂä†
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('üìã', `${earthquake.location}„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫`, new Date());
            }
            
            closeIntensityPopup() {
                const overlay = document.getElementById('intensity-popup-overlay');
                const popup = document.getElementById('intensity-popup');
                
                if (overlay) overlay.remove();
                if (popup) popup.remove();
            }
            
            getIntensityColor(intensity) {
                const colorMap = {
                    '7': 'linear-gradient(135deg, #8B0000 0%, #B22222 100%)',
                    '6Âº∑': 'linear-gradient(135deg, #DC143C 0%, #FF1493 100%)',
                    '6Âº±': 'linear-gradient(135deg, #FF4500 0%, #FF6347 100%)',
                    '5Âº∑': 'linear-gradient(135deg, #FF8C00 0%, #FFA500 100%)',
                    '5Âº±': 'linear-gradient(135deg, #FFD700 0%, #FFFF00 100%)',
                    '4': 'linear-gradient(135deg, #32CD32 0%, #7CFC00 100%)',
                    '3': 'linear-gradient(135deg, #00CED1 0%, #00FFFF 100%)',
                    '2': 'linear-gradient(135deg, #4169E1 0%, #6495ED 100%)',
                    '1': 'linear-gradient(135deg, #9370DB 0%, #BA55D3 100%)'
                };
                return colorMap[intensity] || 'linear-gradient(135deg, #4a9eff 0%, #667eea 100%)';
            }
            
            showSettingsPanel() {
                // Êó¢Â≠ò„ÅÆË®≠ÂÆö„Éë„Éç„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                this.closeSettingsPanel();
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
                const overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                overlay.id = 'settings-overlay';
                overlay.onclick = () => this.closeSettingsPanel();
                
                // Ë®≠ÂÆö„Éë„Éç„É´‰ΩúÊàê
                const panel = document.createElement('div');
                panel.className = 'settings-panel';
                panel.id = 'settings-panel';
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÅÆHTML„ÇíÁîüÊàê
                const activityFeedHTML = document.getElementById('activity-feed') ? 
                    document.getElementById('activity-feed').innerHTML : 
                    '<div class="feed-item"><div class="feed-icon">üü¢</div><div class="feed-content"><div class="feed-text">„Ç∑„Çπ„ÉÜ„É†„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü</div><div class="feed-time">--:--:--</div></div></div>';
                
                panel.innerHTML = `
                    <div class="settings-header">
                        <h3 class="settings-title">‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</h3>
                        <button class="popup-close" onclick="window.monitor.closeSettingsPanel()">√ó</button>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleActivityFeed()">
                            <span>üìã</span>
                            „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ
                            <span id="activity-feed-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="activity-feed-settings" id="settings-activity-feed" style="display: none;">
                            ${activityFeedHTML}
                        </div>
                    </div>
                    
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleBrightnessSettings()">
                            <span>üîÜ</span>
                            Ë°®Á§∫Ë™øÊï¥
                            <span id="brightness-settings-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="brightness-settings" id="settings-brightness" style="display: none;">
                            <div class="setting-item">
                                <label class="setting-label">Âú∞Âõ≥„ÅÆÊòéÂ∫¶</label>
                                <div class="setting-input-group">
                                    <input type="range" id="map-brightness-slider" min="50" max="200" step="10" value="100" 
                                           onchange="window.monitor.updateMapBrightness(this.value); document.getElementById('brightness-display').textContent = this.value + '%'">
                                    <span id="brightness-display" class="setting-value">100%</span>
                                </div>
                                <div class="brightness-presets" style="margin-top: 8px; display: flex; gap: 8px;">
                                    <button class="preset-btn" onclick="window.monitor.setBrightness(70)" style="padding: 4px 8px; background: #2d3748; color: white; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer;">Êöó„ÇÅ</button>
                                    <button class="preset-btn" onclick="window.monitor.setBrightness(100)" style="padding: 4px 8px; background: #2d3748; color: white; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer;">Ê®ôÊ∫ñ</button>
                                    <button class="preset-btn" onclick="window.monitor.setBrightness(140)" style="padding: 4px 8px; background: #2d3748; color: white; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer;">Êòé„Çã„ÇÅ</button>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleNotificationSettings()">
                            <span>üîî</span>
                            ÈÄöÁü•Ë®≠ÂÆö
                            <span id="notification-settings-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="notification-settings" id="settings-notification" style="display: none;">
                        <div class="setting-item">
                            <label class="setting-label">„Éû„Ç∞„Éã„ÉÅ„É•„Éº„ÉâÈñæÂÄ§</label>
                            <div class="setting-input-group">
                                <input type="range" id="magnitude-threshold" min="2.0" max="8.0" step="0.1" value="${this.settings.magnitudeThreshold}" 
                                       onchange="window.monitor.updateSetting('magnitudeThreshold', parseFloat(this.value)); document.getElementById('magnitude-value').textContent = 'M' + this.value">
                                <span id="magnitude-value" class="setting-value">M${this.settings.magnitudeThreshold}</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">ÈúáÂ∫¶ÈñæÂÄ§</label>
                            <div class="setting-input-group">
                                <select id="intensity-threshold" onchange="window.monitor.updateSetting('intensityThreshold', parseInt(this.value))">
                                    <option value="1" ${this.settings.intensityThreshold === 1 ? 'selected' : ''}>ÈúáÂ∫¶1</option>
                                    <option value="2" ${this.settings.intensityThreshold === 2 ? 'selected' : ''}>ÈúáÂ∫¶2</option>
                                    <option value="3" ${this.settings.intensityThreshold === 3 ? 'selected' : ''}>ÈúáÂ∫¶3</option>
                                    <option value="4" ${this.settings.intensityThreshold === 4 ? 'selected' : ''}>ÈúáÂ∫¶4</option>
                                    <option value="5" ${this.settings.intensityThreshold === 5 ? 'selected' : ''}>ÈúáÂ∫¶5Âº±‰ª•‰∏ä</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Èü≥Èáè</label>
                            <div class="setting-input-group">
                                <input type="range" id="volume-setting" min="0" max="100" step="5" value="${this.settings.volume}" 
                                       onchange="window.monitor.updateSetting('volume', parseInt(this.value)); document.getElementById('volume-value').textContent = this.value + '%'">
                                <span id="volume-value" class="setting-value">${this.settings.volume}%</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Ëá™Âãï„Ç∫„Éº„É†</label>
                            <div class="setting-input-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-zoom" ${this.settings.autoZoom ? 'checked' : ''} 
                                           onchange="window.monitor.updateSetting('autoZoom', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="setting-value">${this.settings.autoZoom ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <button class="test-button" onclick="window.monitor.testNotification()">üîî ÈÄöÁü•„ÉÜ„Çπ„Éà</button>
                            <button class="test-button" onclick="window.monitor.testSound()">üîä Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
                        </div>
                        <div class="setting-item">
                            <button class="test-button" onclick="window.monitor.testTsunamiAlert('advisory')">üåä Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±„ÉÜ„Çπ„Éà</button>
                            <button class="test-button" onclick="window.monitor.testTsunamiAlert('warning')">‚ö†Ô∏è Ê¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„Éà</button>
                            <button class="test-button" onclick="window.monitor.testTsunamiAlert('major_warning')">üö® Â§ßÊ¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„Éà</button>
                        </div>
                        <div class="setting-item">
                            <button class="test-button" onclick="window.monitor.stopAllSounds()" style="background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);">üîá ÂÖ®Èü≥Â£∞ÂÅúÊ≠¢</button>
                        </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title" style="cursor: pointer;" onclick="window.monitor.toggleTestToolsSettings()">
                            <span>üß™</span>
                            „ÉÜ„Çπ„Éà„ÉÑ„Éº„É´„ÉªË®∫Êñ≠
                            <span id="test-tools-settings-toggle" style="margin-left: auto; color: #74b9ff;">‚ñ∂</span>
                        </div>
                        <div class="test-tools-settings" id="settings-test-tools" style="display: none;">
                            <div class="setting-item">
                                <label class="setting-label">„Ç∑„Çπ„ÉÜ„É†Ë®∫Êñ≠„ÉÑ„Éº„É´</label>
                                <div class="setting-description">ÂêÑÊ©üËÉΩ„ÅÆÂãï‰ΩúÁ¢∫Ë™ç„Å®„Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞</div>
                                <div class="test-tools-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                                    <button class="test-tool-btn" onclick="window.monitor.openTestTool('test')" 
                                            style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <span>üß™</span>
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold;">Á∑èÂêà„ÉÜ„Çπ„Éà</div>
                                            <div style="font-size: 12px; opacity: 0.9;">ÂÖ®Ê©üËÉΩÊ§úË®º</div>
                                        </div>
                                    </button>
                                    <button class="test-tool-btn" onclick="window.monitor.openTestTool('websocket-test')" 
                                            style="padding: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <span>üîå</span>
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold;">WebSocketË®∫Êñ≠</div>
                                            <div style="font-size: 12px; opacity: 0.9;">Êé•Á∂öÂïèÈ°åËß£Ê±∫</div>
                                        </div>
                                    </button>
                                    <button class="test-tool-btn" onclick="window.monitor.openTestTool('audio-test')" 
                                            style="padding: 12px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <span>üîä</span>
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold;">Èü≥Â£∞„ÉÜ„Çπ„Éà</div>
                                            <div style="font-size: 12px; opacity: 0.9;">Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†</div>
                                        </div>
                                    </button>
                                    <button class="test-tool-btn" onclick="window.monitor.openTestTool('cors-test')" 
                                            style="padding: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <span>üåê</span>
                                        <div style="text-align: left;">
                                            <div style="font-weight: bold;">API/CORSË®∫Êñ≠</div>
                                            <div style="font-size: 12px; opacity: 0.8;">Â§ñÈÉ®APIÊé•Á∂ö</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„É¢„Éã„Çø„Éº</label>
                                <div class="setting-description">„É™„Ç¢„É´„Çø„Ç§„É†„Åß„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Å®„Ç®„É©„ÉºÊÉÖÂ†±„ÇíË°®Á§∫</div>
                                <div id="system-status-monitor" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 13px; max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);">
                                    <div style="color: #00d4aa; margin-bottom: 8px;">üîÑ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.refreshSystemStatus();" 
                                            style="padding: 8px 16px; background: #4a9eff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        üîÑ Áä∂ÊÖãÊõ¥Êñ∞
                                    </button>
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.quickConnectionCheck();" 
                                            style="padding: 8px 16px; background: #00d4aa; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        üåê Êé•Á∂ö„ÉÜ„Çπ„Éà
                                    </button>
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.quickAudioCheck();" 
                                            style="padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        üîä Èü≥Â£∞„ÉÜ„Çπ„Éà
                                    </button>
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.clearSystemStatus();" 
                                            style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                        üóëÔ∏è „ÇØ„É™„Ç¢
                                    </button>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">„Ç®„É©„Éº„É≠„Ç∞„É¢„Éã„Çø„Éº</label>
                                <div class="setting-description">JavaScript „Ç®„É©„Éº„Å®„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„Çí„É™„Ç¢„É´„Çø„Ç§„É†Ë°®Á§∫</div>
                                <div id="error-log-monitor" style="background: rgba(139, 0, 0, 0.2); border-radius: 8px; padding: 12px; margin-top: 8px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; border: 1px solid rgba(255, 0, 0, 0.3);">
                                    <div style="color: #00d4aa;">‚úÖ „Ç®„É©„Éº„Å™„Åó - „Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏Á®ºÂÉç‰∏≠</div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.clearErrorLog();" 
                                            style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        üóëÔ∏è „Ç®„É©„Éº„É≠„Ç∞„ÇØ„É™„Ç¢
                                    </button>
                                    <button class="quick-test-btn" 
                                            onclick="window.monitor.exportSystemReport();" 
                                            style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        üìÑ „É¨„Éù„Éº„ÉàÂá∫Âäõ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // DOM „Å´ËøΩÂä†
                document.body.appendChild(overlay);
                document.body.appendChild(panel);
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('‚öôÔ∏è', '„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', new Date());
                
                // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„É¢„Éã„Çø„Éº„ÇíÂàùÊúüÂåñ
                setTimeout(() => {
                    this.initializeSystemMonitor();
                    this.refreshSystemStatus();
                }, 500);
            }
            
            toggleNotificationSettings() {
                const settingsContainer = document.getElementById('settings-notification');
                const toggleIcon = document.getElementById('notification-settings-toggle');
                
                if (settingsContainer && toggleIcon) {
                    const isVisible = settingsContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        settingsContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        settingsContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üîî', 
                        isVisible ? 'ÈÄöÁü•Ë®≠ÂÆö„ÇíÈñâ„Åò„Åæ„Åó„Åü' : 'ÈÄöÁü•Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            toggleTestToolsSettings() {
                const settingsContainer = document.getElementById('settings-test-tools');
                const toggleIcon = document.getElementById('test-tools-settings-toggle');
                
                if (settingsContainer && toggleIcon) {
                    const isVisible = settingsContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        settingsContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        settingsContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üß™', 
                        isVisible ? '„ÉÜ„Çπ„Éà„ÉÑ„Éº„É´Ë®≠ÂÆö„ÇíÈñâ„Åò„Åæ„Åó„Åü' : '„ÉÜ„Çπ„Éà„ÉÑ„Éº„É´Ë®≠ÂÆö„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            // „ÉÜ„Çπ„Éà„ÉÑ„Éº„É´„ÇíÈñã„ÅèÔºàÂãïÁöÑURLÂØæÂøúÔºâ
            openTestTool(toolName) {
                const currentOrigin = window.location.origin;
                const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                const baseURL = `${window.location.protocol}//${window.location.hostname}:${currentPort}`;
                
                const toolURL = `${baseURL}/${toolName}.html`;
                
                // Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
                const newTab = window.open(toolURL, '_blank');
                
                if (newTab) {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    const toolNames = {
                        'test': 'Á∑èÂêà„ÉÜ„Çπ„Éà„ÉÑ„Éº„É´',
                        'websocket-test': 'WebSocketË®∫Êñ≠„ÉÑ„Éº„É´',
                        'audio-test': 'Èü≥Â£∞„ÉÜ„Çπ„Éà„ÉÑ„Éº„É´',
                        'cors-test': 'API/CORSË®∫Êñ≠„ÉÑ„Éº„É´'
                    };
                    
                    this.addActivityFeedItem('üß™', 
                        `${toolNames[toolName] || toolName}„ÇíÈñã„Åç„Åæ„Åó„Åü`, 
                        new Date()
                    );
                } else {
                    // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà
                    this.showNotification('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                    this.addActivityFeedItem('‚ö†Ô∏è', 
                        `${toolName}„ÉÑ„Éº„É´„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÔºâ`, 
                        new Date()
                    );
                }
            }
            
            // „ÇØ„Ç§„ÉÉ„ÇØË®∫Êñ≠Ê©üËÉΩÔºàÁµ±ÂêàÁâàÔºâ
            async quickSystemCheck() {
                try {
                    this.addActivityFeedItem('üìä', '„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã...', new Date());
                    await this.refreshSystemStatus();
                    this.showNotification('‚úÖ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü\nË©≥Á¥∞„ÅØË®≠ÂÆö„Éë„Éç„É´„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô', 'success');
                } catch (error) {
                    this.logError(`„Ç∑„Çπ„ÉÜ„É†Ë®∫Êñ≠„Ç®„É©„Éº: ${error.message}`);
                    this.showNotification(`‚ùå „Ç∑„Çπ„ÉÜ„É†Ë®∫Êñ≠„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            }
            
            async quickConnectionCheck() {
                try {
                    this.addActivityFeedItem('üåê', 'Êé•Á∂öÁ¢∫Ë™ç„ÇíÈñãÂßã...', new Date());
                    
                    // P2P APIÊé•Á∂öÁ¢∫Ë™ç
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch('/api/status', { 
                        signal: controller.signal,
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.showNotification('‚úÖ „Çµ„Éº„Éê„ÉºÊé•Á∂öÊ≠£Â∏∏\n‚úÖ P2P APIÂà©Áî®ÂèØËÉΩ', 'success');
                        this.addActivityFeedItem('üåê', 'Êé•Á∂öÁ¢∫Ë™çÂÆå‰∫Ü - ÂÖ®„Å¶Ê≠£Â∏∏', new Date());
                        this.logSystemStatus(`‚úÖ Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü: ${response.status}`);
                    } else {
                        this.logError(`„Çµ„Éº„Éê„ÉºÂøúÁ≠îÁï∞Â∏∏: ${response.status} ${response.statusText}`);
                        this.showNotification(`‚ö†Ô∏è „Çµ„Éº„Éê„ÉºÂøúÁ≠îÁï∞Â∏∏ (${response.status})`, 'warning');
                    }
                } catch (error) {
                    this.logError(`Êé•Á∂ö„ÉÜ„Çπ„ÉàÂ§±Êïó: ${error.message}`);
                    let errorMessage = '‚ùå „Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±Êïó';
                    if (error.name === 'AbortError') {
                        errorMessage += ' („Çø„Ç§„É†„Ç¢„Ç¶„Éà)';
                    } else {
                        errorMessage += ` (${error.message})`;
                    }
                    this.showNotification(errorMessage, 'error');
                }
            }
            
            async quickAudioCheck() {
                this.addActivityFeedItem('üîä', 'Èü≥Â£∞Á¢∫Ë™ç„ÇíÈñãÂßã...', new Date());
                
                try {
                    if (window.audioAlertSystem) {
                        await window.audioAlertSystem.playTestSound();
                        this.showNotification('‚úÖ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏Âãï‰Ωú', 'success');
                        this.addActivityFeedItem('üîä', 'Èü≥Â£∞Á¢∫Ë™çÂÆå‰∫Ü - Ê≠£Â∏∏Âãï‰Ωú', new Date());
                        this.logSystemStatus('‚úÖ Èü≥Â£∞„ÉÜ„Çπ„ÉàÊàêÂäü');
                    } else {
                        this.logError('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Êú™ÂàùÊúüÂåñ');
                        this.showNotification('‚ùå Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Êú™ÂàùÊúüÂåñ', 'error');
                    }
                } catch (error) {
                    this.logError(`Èü≥Â£∞„ÉÜ„Çπ„ÉàÂ§±Êïó: ${error.message}`);
                    this.showNotification('‚ùå Èü≥Â£∞„ÉÜ„Çπ„ÉàÂ§±Êïó', 'error');
                }
            }
            
            // „Ç∑„Çπ„ÉÜ„É†„É¢„Éã„Çø„ÉºÂàùÊúüÂåñ
            initializeSystemMonitor() {
                // „Ç®„É©„Éº„É≠„Ç∞ÈÖçÂàó„ÇíÂàùÊúüÂåñ
                if (!this.errorLog) {
                    this.errorLog = [];
                }
                
                if (!this.systemStatusLog) {
                    this.systemStatusLog = [];
                }
                
                // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº„ÇíË®≠ÂÆö
                window.addEventListener('error', (event) => {
                    this.logError(`JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}`);
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    this.logError(`Promise Rejection: ${event.reason}`);
                });
                
                // ÂÆöÊúüÁöÑ„Å™„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÔºà30ÁßíÈñìÈöîÔºâ
                if (this.systemMonitorInterval) {
                    clearInterval(this.systemMonitorInterval);
                }
                this.systemMonitorInterval = setInterval(() => {
                    this.updateSystemStatusSilently();
                }, 30000);
                
                this.logSystemStatus('üü¢ „Ç∑„Çπ„ÉÜ„É†„É¢„Éã„Çø„ÉºÂàùÊúüÂåñÂÆå‰∫Ü');
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„Çµ„Ç§„É¨„É≥„ÉàÔºâ
            async updateSystemStatusSilently() {
                try {
                    const status = await this.getSystemStatus();
                    this.updateSystemStatusDisplay(status);
                } catch (error) {
                    this.logError(`„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÂèñÂæó
            async getSystemStatus() {
                const status = {
                    timestamp: new Date().toLocaleTimeString(),
                    websocket: {
                        connected: this.websocket && this.websocket.readyState === WebSocket.OPEN,
                        state: this.websocket ? this.websocket.readyState : 'N/A',
                        url: 'wss://api.p2pquake.net/v2/ws'
                    },
                    audio: {
                        initialized: window.audioAlertSystem ? window.audioAlertSystem.getStatus()?.initialized : false,
                        available: typeof window.audioAlertSystem !== 'undefined'
                    },
                    notifications: {
                        permission: Notification.permission,
                        supported: 'Notification' in window
                    },
                    map: {
                        initialized: !!this.map,
                        layers: this.mapLayers ? Object.keys(this.mapLayers).length : 0
                    },
                    server: null
                };
                
                // „Çµ„Éº„Éê„ÉºÁä∂ÊÖãÁ¢∫Ë™ç
                try {
                    const response = await fetch('/api/status', { 
                        signal: AbortSignal.timeout(3000),
                        headers: { 'Accept': 'application/json' }
                    });
                    status.server = {
                        available: response.ok,
                        status: response.status,
                        statusText: response.statusText
                    };
                } catch (error) {
                    status.server = {
                        available: false,
                        error: error.message
                    };
                }
                
                return status;
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫„ÇíÊõ¥Êñ∞
            updateSystemStatusDisplay(status) {
                const monitor = document.getElementById('system-status-monitor');
                if (!monitor) return;
                
                const wsStatus = status.websocket.connected ? 
                    `üü¢ WebSocket: Êé•Á∂ö‰∏≠` : 
                    `üî¥ WebSocket: ÂàáÊñ≠ (Áä∂ÊÖã: ${status.websocket.state})`;
                
                const audioStatus = status.audio.initialized ? 
                    `üü¢ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†: Ê≠£Â∏∏` : 
                    `üü° Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†: ${status.audio.available ? 'Êú™ÂàùÊúüÂåñ' : 'Âà©Áî®‰∏çÂèØ'}`;
                
                const notificationStatus = status.notifications.permission === 'granted' ? 
                    `üü¢ ÈÄöÁü•: Ë®±ÂèØÊ∏à„Åø` : 
                    `üü° ÈÄöÁü•: ${status.notifications.permission}`;
                
                const mapStatus = status.map.initialized ? 
                    `üü¢ Âú∞Âõ≥: Ê≠£Â∏∏ (${status.map.layers}„É¨„Ç§„É§„Éº)` : 
                    `üî¥ Âú∞Âõ≥: Êú™ÂàùÊúüÂåñ`;
                
                const serverStatus = status.server?.available ? 
                    `üü¢ „Çµ„Éº„Éê„Éº: Ê≠£Â∏∏ (${status.server.status})` : 
                    `üî¥ „Çµ„Éº„Éê„Éº: ${status.server?.error || 'Êé•Á∂öÂ§±Êïó'}`;
                
                const html = `
                    <div style="color: #a0aec0; font-size: 11px; margin-bottom: 6px;">ÊúÄÁµÇÊõ¥Êñ∞: ${status.timestamp}</div>
                    <div style="line-height: 1.4;">
                        <div style="color: ${status.websocket.connected ? '#00d4aa' : '#ff6b6b'};">${wsStatus}</div>
                        <div style="color: ${status.audio.initialized ? '#00d4aa' : '#ffd93d'};">${audioStatus}</div>
                        <div style="color: ${status.notifications.permission === 'granted' ? '#00d4aa' : '#ffd93d'};">${notificationStatus}</div>
                        <div style="color: ${status.map.initialized ? '#00d4aa' : '#ff6b6b'};">${mapStatus}</div>
                        <div style="color: ${status.server?.available ? '#00d4aa' : '#ff6b6b'};">${serverStatus}</div>
                    </div>
                `;
                
                monitor.innerHTML = html;
            }
            
            // „Ç®„É©„Éº„Çí„É≠„Ç∞„Å´Ë®òÈå≤
            logError(message) {
                const timestamp = new Date().toLocaleTimeString();
                const errorEntry = {
                    timestamp,
                    message,
                    type: 'error'
                };
                
                this.errorLog.unshift(errorEntry);
                
                // ÊúÄÂ§ß50‰ª∂„Åæ„Åß‰øùÊåÅ
                if (this.errorLog.length > 50) {
                    this.errorLog = this.errorLog.slice(0, 50);
                }
                
                this.updateErrorLogDisplay();
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„Å´„ÇÇË®òÈå≤
                this.addActivityFeedItem('‚ùå', message, new Date());
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Çí„É≠„Ç∞„Å´Ë®òÈå≤
            logSystemStatus(message) {
                const timestamp = new Date().toLocaleTimeString();
                const statusEntry = {
                    timestamp,
                    message,
                    type: 'info'
                };
                
                this.systemStatusLog.unshift(statusEntry);
                
                // ÊúÄÂ§ß30‰ª∂„Åæ„Åß‰øùÊåÅ
                if (this.systemStatusLog.length > 30) {
                    this.systemStatusLog = this.systemStatusLog.slice(0, 30);
                }
            }
            
            // „Ç®„É©„Éº„É≠„Ç∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateErrorLogDisplay() {
                const monitor = document.getElementById('error-log-monitor');
                if (!monitor) return;
                
                if (this.errorLog.length === 0) {
                    monitor.innerHTML = '<div style="color: #00d4aa;">‚úÖ „Ç®„É©„Éº„Å™„Åó - „Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏Á®ºÂÉç‰∏≠</div>';
                    return;
                }
                
                const html = this.errorLog.slice(0, 10).map(entry => 
                    `<div style="color: #ff6b6b; margin-bottom: 4px;">
                        <span style="color: #a0aec0; font-size: 11px;">[${entry.timestamp}]</span> 
                        ${entry.message}
                    </div>`
                ).join('');
                
                monitor.innerHTML = html;
                monitor.scrollTop = 0;
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÊâãÂãïÊõ¥Êñ∞
            async refreshSystemStatus() {
                try {
                    this.logSystemStatus('üîÑ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞‰∏≠...');
                    const status = await this.getSystemStatus();
                    this.updateSystemStatusDisplay(status);
                    this.logSystemStatus('‚úÖ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞ÂÆå‰∫Ü');
                    this.addActivityFeedItem('üîÑ', '„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', new Date());
                } catch (error) {
                    this.logError(`„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            clearSystemStatus() {
                const monitor = document.getElementById('system-status-monitor');
                if (monitor) {
                    monitor.innerHTML = '<div style="color: #a0aec0;">„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü</div>';
                }
                this.systemStatusLog = [];
                this.addActivityFeedItem('üóëÔ∏è', '„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', new Date());
            }
            
            // „Ç®„É©„Éº„É≠„Ç∞„Çí„ÇØ„É™„Ç¢
            clearErrorLog() {
                this.errorLog = [];
                this.updateErrorLogDisplay();
                this.addActivityFeedItem('üóëÔ∏è', '„Ç®„É©„Éº„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', new Date());
            }
            
            // „Ç∑„Çπ„ÉÜ„É†„É¨„Éù„Éº„Éà„ÇíÂá∫Âäõ
            exportSystemReport() {
                try {
                    const report = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        systemStatus: this.systemStatusLog.slice(0, 10),
                        errorLog: this.errorLog.slice(0, 20),
                        settings: this.settings
                    };
                    
                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `earthquake-monitor-report-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.addActivityFeedItem('üìÑ', '„Ç∑„Çπ„ÉÜ„É†„É¨„Éù„Éº„Éà„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü', new Date());
                } catch (error) {
                    this.logError(`„É¨„Éù„Éº„ÉàÂá∫Âäõ„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            // Ë®≠ÂÆöÁÆ°ÁêÜ„É°„ÇΩ„ÉÉ„Éâ
            loadSettings() {
                const defaultSettings = {
                    magnitudeThreshold: 4.0,
                    intensityThreshold: 3,
                    volume: 50,
                    autoZoom: true,
                    notifications: true
                };
                
                try {
                    const saved = localStorage.getItem('earthquake_settings');
                    if (saved) {
                        return { ...defaultSettings, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.warn('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
                
                return defaultSettings;
            }
            
            saveSettings() {
                try {
                    localStorage.setItem('earthquake_settings', JSON.stringify(this.settings));
                    this.addActivityFeedItem('üíæ', 'Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', new Date());
                } catch (error) {
                    console.error('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                }
            }
            
            updateSetting(key, value) {
                this.settings[key] = value;
                this.saveSettings();
                
                // Ëá™Âãï„Ç∫„Éº„É†Ë®≠ÂÆö„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ UI Êõ¥Êñ∞
                if (key === 'autoZoom') {
                    const toggleElement = document.getElementById('auto-zoom');
                    const valueElement = toggleElement?.parentElement?.nextElementSibling;
                    if (valueElement) {
                        valueElement.textContent = value ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
                    }
                }
            }
            
            // „ÉÜ„Çπ„ÉàÊ©üËÉΩ
            testNotification() {
                if (Notification.permission === 'granted') {
                    new Notification('üåè Âú∞ÈúáÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†', {
                        body: '„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅåÊ≠£Â∏∏„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„Åü„ÄÇ\nM4.5 „ÉÜ„Çπ„ÉàÂú∞Èúá ÈúáÂ∫¶3',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM3NGI5ZmYiLz4KPHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9zdmc+Cjwvc3ZnPgo='
                    });
                    this.addActivityFeedItem('üîî', 'ÈÄöÁü•„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü', new Date());
                } else if (Notification.permission === 'denied') {
                    alert('ÈÄöÁü•„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„ÇâÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            this.testNotification();
                        }
                    });
                }
            }
            
            async testSound() {
                try {
                    // Êñ∞„Åó„ÅÑÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                    if (window.audioAlertSystem) {
                        const success = await window.audioAlertSystem.playTestSound();
                        if (success) {
                            this.addActivityFeedItem('üîä', 'Èü≥Â£∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„ÅüÔºàWeb Audio APIÔºâ', new Date());
                        } else {
                            throw new Error('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                        }
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÊñπÂºè
                        this.playAlertSound(1);
                        this.addActivityFeedItem('üîä', 'Èü≥Â£∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„ÅüÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ', new Date());
                    }
                } catch (error) {
                    console.error('Èü≥Â£∞„ÉÜ„Çπ„ÉàÂ§±Êïó:', error);
                    alert('Èü≥Â£∞„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
            
            // Èü≥Â£∞„Ç¢„É©„Éº„ÉàÂÜçÁîüÈñ¢Êï∞ÔºàÊñ∞„Åó„ÅÑÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Áµ±ÂêàÔºâ
            async playAlertSound(repeatCount = 1) {
                try {
                    // Êñ∞„Åó„ÅÑÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÇíÂÑ™ÂÖà‰ΩøÁî®
                    if (window.audioAlertSystem) {
                        // Èü≥ÈáèË®≠ÂÆö„ÇíÈÅ©Áî®
                        const volume = this.settings.volume / 100;
                        window.audioAlertSystem.setMasterVolume(volume);
                        
                        // „ÉÜ„Çπ„ÉàÈü≥„ÇíÊåáÂÆöÂõûÊï∞ÂÜçÁîü
                        for (let i = 0; i < repeatCount; i++) {
                            await window.audioAlertSystem.playAlert('test');
                            if (i < repeatCount - 1) {
                                // Ê¨°„ÅÆÂÜçÁîü„Åæ„Åß0.8ÁßíÂæÖÊ©ü
                                await new Promise(resolve => setTimeout(resolve, 800));
                            }
                        }
                        
                        console.log(`üîä Èü≥Â£∞„Ç¢„É©„Éº„Éà„Çí${repeatCount}ÂõûÂÜçÁîüÈñãÂßã (Êñ∞„Ç∑„Çπ„ÉÜ„É†)`);
                        return;
                    }
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆÂÆüË£Ö
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const volume = this.settings.volume / 100 * 0.3;
                    
                    for (let i = 0; i < repeatCount; i++) {
                        const delay = i * 0.8; // 0.8ÁßíÈñìÈöî„ÅßÂÜçÁîü
                        
                        // ÂêÑÂõû„ÅÆÈü≥Â£∞‰ΩúÊàê
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // Âë®Ê≥¢Êï∞„Éë„Çø„Éº„É≥ÔºàË≠¶ÂëäÈü≥„Çâ„Åó„ÅÑÈü≥Á®ãÔºâ
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + delay);
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + delay + 0.1);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + delay + 0.2);
                        
                        // Èü≥Èáè„Ç®„É≥„Éô„É≠„Éº„Éó
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime + delay);
                        gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + delay + 0.01);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.3);
                        
                        // ÂÜçÁîüÊôÇÈñìË®≠ÂÆö
                        oscillator.start(audioContext.currentTime + delay);
                        oscillator.stop(audioContext.currentTime + delay + 0.3);
                    }
                    
                    console.log(`üîä Èü≥Â£∞„Ç¢„É©„Éº„Éà„Çí${repeatCount}ÂõûÂÜçÁîüÈñãÂßã („Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ)`);
                } catch (error) {
                    console.error('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', error);
                    throw error;
                }
            }
            
            closeSettingsPanel() {
                const overlay = document.getElementById('settings-overlay');
                const panel = document.getElementById('settings-panel');
                
                if (overlay) overlay.remove();
                if (panel) panel.remove();
            }
            
            async testTsunamiAlert(alertLevel) {
                try {
                    console.log(`üß™ Ê¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„ÉàÈñãÂßã: ${alertLevel}`);
                    
                    // Êñ∞„Åó„ÅÑÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                    if (window.audioAlertSystem) {
                        const success = await window.audioAlertSystem.playAlert(alertLevel);
                        
                        if (success) {
                            const levelNames = {
                                'advisory': 'Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±',
                                'warning': 'Ê¥•Ê≥¢Ë≠¶Â†±', 
                                'major_warning': 'Â§ßÊ¥•Ê≥¢Ë≠¶Â†±'
                            };
                            
                            this.addActivityFeedItem('üåä', `${levelNames[alertLevel]}„ÅÆÈü≥Â£∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü`, new Date());
                            
                            // „ÉÜ„Çπ„ÉàÈÄöÁü•„ÇÇË°®Á§∫
                            if (Notification.permission === 'granted') {
                                const titles = {
                                    'advisory': 'üì¢ Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±Ôºà„ÉÜ„Çπ„ÉàÔºâ',
                                    'warning': '‚ö†Ô∏è Ê¥•Ê≥¢Ë≠¶Â†±Ôºà„ÉÜ„Çπ„ÉàÔºâ',
                                    'major_warning': 'üö® Â§ßÊ¥•Ê≥¢Ë≠¶Â†±Ôºà„ÉÜ„Çπ„ÉàÔºâ'
                                };
                                
                                new Notification(titles[alertLevel], {
                                    body: '„Åì„Çå„ÅØ„ÉÜ„Çπ„ÉàÈÄöÁü•„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆÊ¥•Ê≥¢ÊÉÖÂ†±„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                                    icon: '/favicon.ico',
                                    tag: `tsunami_test_${alertLevel}`
                                });
                            }
                        } else {
                            throw new Error('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                        }
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        await this.playAlertSound(1);
                        this.addActivityFeedItem('üåä', 'Ê¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„ÉàÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü', new Date());
                    }
                    
                } catch (error) {
                    console.error('Ê¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„ÉàÂ§±Êïó:', error);
                    alert(`Ê¥•Ê≥¢Ë≠¶Â†±„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }
            
            stopAllSounds() {
                try {
                    console.log('üîá ÂÖ®Èü≥Â£∞ÂÅúÊ≠¢Ë¶ÅÊ±Ç');
                    
                    // Êñ∞„Åó„ÅÑÈü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                    if (window.audioAlertSystem) {
                        window.audioAlertSystem.stopAllAlerts();
                        this.addActivityFeedItem('üîá', 'ÂÖ®„Å¶„ÅÆÈü≥Â£∞„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü', new Date());
                        console.log('‚úÖ ÂÖ®Èü≥Â£∞ÂÅúÊ≠¢ÂÆå‰∫Ü');
                    } else {
                        console.warn('‚ö†Ô∏è Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                        this.addActivityFeedItem('‚ö†Ô∏è', 'Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', new Date());
                    }
                    
                } catch (error) {
                    console.error('‚ùå Èü≥Â£∞ÂÅúÊ≠¢„Ç®„É©„Éº:', error);
                    this.addActivityFeedItem('‚ùå', `Èü≥Â£∞ÂÅúÊ≠¢„Ç®„É©„Éº: ${error.message}`, new Date());
                }
            }
            
            toggleActivityFeed() {
                const feedContainer = document.getElementById('settings-activity-feed');
                const toggleIcon = document.getElementById('activity-feed-toggle');
                
                if (feedContainer && toggleIcon) {
                    const isVisible = feedContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        feedContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        feedContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                        // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÊõ¥Êñ∞
                        this.updateActivityFeedDisplay(feedContainer);
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üìã', 
                        isVisible ? '„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÈñâ„Åò„Åæ„Åó„Åü' : '„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éï„Ç£„Éº„Éâ„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            

            
            // ÊòéÂ∫¶Ë™øÊï¥Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞
            toggleBrightnessSettings() {
                const brightnessContainer = document.getElementById('settings-brightness');
                const toggleIcon = document.getElementById('brightness-settings-toggle');
                
                if (brightnessContainer && toggleIcon) {
                    const isVisible = brightnessContainer.style.display !== 'none';
                    
                    if (isVisible) {
                        brightnessContainer.style.display = 'none';
                        toggleIcon.textContent = '‚ñ∂';
                    } else {
                        brightnessContainer.style.display = 'block';
                        toggleIcon.textContent = '‚ñº';
                        // ÁèæÂú®„ÅÆÊòéÂ∫¶ÂÄ§„ÇíÊõ¥Êñ∞
                        this.updateBrightnessDisplay();
                    }
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                    this.addActivityFeedItem('üîÜ', 
                        isVisible ? 'Ë°®Á§∫Ë™øÊï¥„ÇíÈñâ„Åò„Åæ„Åó„Åü' : 'Ë°®Á§∫Ë™øÊï¥„ÇíÈñã„Åç„Åæ„Åó„Åü', 
                        new Date()
                    );
                }
            }
            
            // Âú∞Âõ≥„ÅÆÊòéÂ∫¶„ÇíÊõ¥Êñ∞
            updateMapBrightness(brightness) {
                this.mapBrightness = brightness;
                this.applyMapBrightness();
                
                // Ë®≠ÂÆö„Éë„Éç„É´„ÅÆ„Çπ„É©„Ç§„ÉÄ„Éº„Å®„Éá„Ç£„Çπ„Éó„É¨„Ç§„ÇíÂêåÊúü
                const slider = document.getElementById('map-brightness-slider');
                const display = document.getElementById('brightness-display');
                if (slider) {
                    slider.value = brightness;
                }
                if (display) {
                    display.textContent = brightness + '%';
                }
                
                // Ë®≠ÂÆö„Çí‰øùÂ≠ò
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('mapBrightness', brightness);
                }
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É≠„Ç∞„Å´Ë®òÈå≤
                this.addActivityFeedItem('üîÜ', 
                    `Âú∞Âõ≥ÊòéÂ∫¶„Çí${brightness}%„Å´Ë™øÊï¥„Åó„Åæ„Åó„Åü`, 
                    new Date()
                );
            }
            
            // ÊòéÂ∫¶„Éó„É™„Çª„ÉÉ„ÉàË®≠ÂÆö
            setBrightness(brightness) {
                const slider = document.getElementById('map-brightness-slider');
                const display = document.getElementById('brightness-display');
                
                if (slider) {
                    slider.value = brightness;
                }
                if (display) {
                    display.textContent = brightness + '%';
                }
                
                this.updateMapBrightness(brightness);
            }
            
            // Âú∞Âõ≥„Å´ÊòéÂ∫¶„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            applyMapBrightness() {
                const mapContainer = document.querySelector('.leaflet-container');
                if (mapContainer && this.mapBrightness) {
                    const brightness = this.mapBrightness / 100;
                    mapContainer.style.filter = `brightness(${brightness})`;
                    console.log(`üîÜ Âú∞Âõ≥ÊòéÂ∫¶„Çí${this.mapBrightness}%„Å´Ë®≠ÂÆö`);
                }
            }
            
            // ÊòéÂ∫¶Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateBrightnessDisplay() {
                const slider = document.getElementById('map-brightness-slider');
                const display = document.getElementById('brightness-display');
                
                // ‰øùÂ≠ò„Åï„Çå„ÅüÊòéÂ∫¶ÂÄ§„ÇíË™≠„ÅøËæº„Åø
                if (typeof(Storage) !== "undefined") {
                    const savedBrightness = localStorage.getItem('mapBrightness');
                    if (savedBrightness) {
                        this.mapBrightness = parseInt(savedBrightness);
                    } else {
                        this.mapBrightness = 100; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
                    }
                } else {
                    this.mapBrightness = 100;
                }
                
                if (slider) {
                    slider.value = this.mapBrightness;
                }
                if (display) {
                    display.textContent = this.mapBrightness + '%';
                }
                
                // ÊòéÂ∫¶„ÇíÈÅ©Áî®
                this.applyMapBrightness();
            }
            
            // ÊòéÂ∫¶Ë®≠ÂÆö„ÇíÂàùÊúüÂåñ
            initializeBrightnessSettings() {
                // ‰øùÂ≠ò„Åï„Çå„ÅüÊòéÂ∫¶ÂÄ§„ÇíË™≠„ÅøËæº„Åø
                if (typeof(Storage) !== "undefined") {
                    const savedBrightness = localStorage.getItem('mapBrightness');
                    if (savedBrightness) {
                        this.mapBrightness = parseInt(savedBrightness);
                    } else {
                        this.mapBrightness = 100; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
                        localStorage.setItem('mapBrightness', '100');
                    }
                } else {
                    this.mapBrightness = 100;
                }
                
                // Âú∞Âõ≥„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÂæå„Å´ÊòéÂ∫¶„ÇíÈÅ©Áî®
                setTimeout(() => {
                    this.applyMapBrightness();
                    console.log(`üîÜ Âú∞Âõ≥ÊòéÂ∫¶„Çí${this.mapBrightness}%„ÅßÂàùÊúüÂåñ`);
                }, 500);
            }
            
            /**
             * ÂÆüÁî®Ê¥•Ê≥¢Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó (50%ÂÆåÊàêÂ∫¶Áâà)
             */
            setupPracticalTsunamiSystem() {
                console.log('üåä ÂÆüÁî®Ê¥•Ê≥¢Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÈñãÂßã');
                
                // È´òÂ∫¶„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
                this.initializeAdvancedSystems();
                
                // ÂêÑ„Ç∑„Çπ„ÉÜ„É†Èñì„ÅÆÈÄ£Êê∫Ë®≠ÂÆö
                this.connectTsunamiSystems();
                
                // ÂÆüÈöõ„ÅÆÊ∞óË±°Â∫Å„Éá„Éº„ÇøÁõ£Ë¶ñÈñãÂßã
                this.startRealTsunamiMonitoring();
                
                // UIÁµ±Âêà
                this.integrateTsunamiUI();
                
                // Á∑äÊÄ•ÂØæÂøú„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã
                this.startEmergencyResponseSystem();
                
                console.log('‚úÖ ÂÆüÁî®Ê¥•Ê≥¢Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü (60%Ê©üËÉΩÈÅîÊàê)');
            }
            
            /**
             * È´òÂ∫¶„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ (60%ÂÆüÁî®Ê©üËÉΩÈÅîÊàê)
             */
            initializeAdvancedSystems() {
                console.log('üß† È´òÂ∫¶Ê¥•Ê≥¢‰∫àÊ∏¨„ÉªÊ§úË®º„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ');
                
                try {
                    // È´òÁ≤æÂ∫¶Ê¥•Ê≥¢‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥
                    this.tsunamiPredictionEngine = new TsunamiPredictionEngine();
                    
                    // Â§öÂú∞ÁÇπÈÄ£Êê∫Ê§úË®º„Ç∑„Çπ„ÉÜ„É†
                    this.multiSiteVerification = new MultiSiteVerificationSystem();
                    this.multiSiteVerification.startMultiSiteVerification();
                    
                    // „Éá„Éº„Çø„Çπ„Éà„É¨„Éº„Ç∏„Ç∑„Çπ„ÉÜ„É†
                    this.tsunamiDataStore = new TsunamiDataStore();
                    
                    // ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„Çø„Ç∑„Çπ„ÉÜ„É†
                    this.historicalTsunamiData = new HistoricalTsunamiData();
                    
                    // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†
                    this.tsunamiAlertSystem = new TsunamiAlertSystem();
                    
                    // ÈÅéÂéª„Éá„Éº„Çø„ÅÆÂàùÊúüÊäïÂÖ•
                    this.loadHistoricalTsunamiData();
                    
                    // „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫Ë®≠ÂÆö
                    this.setupAdvancedSystemConnections();
                    
                    console.log('‚úÖ È´òÂ∫¶„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
                    
                } catch (error) {
                    console.error('‚ùå È´òÂ∫¶„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂ§±Êïó:', error);
                }
            }
            
            /**
             * ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„ÇøÊäïÂÖ• (ÂÆüÁî®ÊÄßÂêë‰∏ä)
             */
            async loadHistoricalTsunamiData() {
                console.log('üìö Ë≤¥Èáç„Å™ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„Çø„ÅÆÊäïÂÖ•ÈñãÂßã');
                
                try {
                    // Êó¢Â≠ò„Éá„Éº„ÇøÁ¢∫Ë™ç
                    const currentStats = this.tsunamiDataStore.getStatistics();
                    
                    if (currentStats.historyCount === 0) {
                        console.log('üíæ ÂàùÂõûËµ∑ÂãïÊ§úÂá∫ - ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„Çø„ÇíÊäïÂÖ•„Åó„Åæ„Åô');
                        
                        // ÈÅéÂéª„Éá„Éº„ÇøÊäïÂÖ•
                        const loadedCount = await this.historicalTsunamiData.loadHistoricalDataToStore(this.tsunamiDataStore);
                        
                        const stats = this.historicalTsunamiData.getHistoricalDataStats();
                        
                        console.log('üìä ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„ÇøÊäïÂÖ•ÂÆå‰∫Ü:');
                        console.log(`   üíø ÊäïÂÖ•„Éá„Éº„ÇøÊï∞: ${loadedCount}‰ª∂`);
                        console.log(`   üìÖ ÊúüÈñì: ${stats.timeSpan.oldest?.split('T')[0]} „Äú ${stats.timeSpan.newest?.split('T')[0]}`);
                        console.log(`   üö® Â§ßÊ¥•Ê≥¢Ë≠¶Â†±: ${stats.byLevel.major_warning}‰ª∂`);
                        console.log(`   ‚ö†Ô∏è Ê¥•Ê≥¢Ë≠¶Â†±: ${stats.byLevel.warning}‰ª∂`);
                        console.log(`   üì¢ Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±: ${stats.byLevel.advisory}‰ª∂`);
                        
                        // UI „Å´ÁµêÊûúË°®Á§∫
                        this.showHistoricalDataLoadedMessage(loadedCount);
                        
                    } else {
                        console.log(`üìã Êó¢Â≠ò„Éá„Éº„ÇøÊ§úÂá∫: ${currentStats.historyCount}‰ª∂„ÅÆÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åô`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„ÇøÊäïÂÖ•Â§±Êïó:', error);
                }
            }
            
            /**
             * ÈÅéÂéª„Éá„Éº„ÇøÊäïÂÖ•ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
             */
            showHistoricalDataLoadedMessage(loadedCount) {
                const messageElement = document.createElement('div');
                messageElement.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    width: 300px;
                    background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    z-index: 9999;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                    font-family: Arial, sans-serif;
                `;
                
                messageElement.innerHTML = `
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">üìö ÈÅéÂéªÊ¥•Ê≥¢„Éá„Éº„ÇøÊäïÂÖ•ÂÆå‰∫Ü</h3>
                    <div style="font-size: 14px; line-height: 1.4;">
                        <div>üéØ Ë≤¥Èáç„Å™„Éá„Éº„Çø: <strong>${loadedCount}‰ª∂</strong></div>
                        <div>üìÖ 2010Âπ¥„Äú2024Âπ¥„ÅÆÊ¥•Ê≥¢ÂÆüÁ∏æ</div>
                        <div>üí° Êù±Êó•Êú¨Â§ßÈúáÁÅΩ„ÉªËÉΩÁôªÂçäÂ≥∂Âú∞ÈúáÁ≠â</div>
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        background: white;
                        color: #4a9eff;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-top: 10px;
                        font-size: 12px;
                    ">Á¢∫Ë™ç</button>
                `;
                
                document.body.appendChild(messageElement);
                
                // 15ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
                setTimeout(() => {
                    if (document.body.contains(messageElement)) {
                        document.body.removeChild(messageElement);
                    }
                }, 15000);
            }
            
            /**
             * È´òÂ∫¶„Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫Ë®≠ÂÆö
             */
            setupAdvancedSystemConnections() {
                // Â§öÂú∞ÁÇπÊ§úË®ºÁµêÊûú„Çí‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥„Å´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                this.multiSiteVerification.on('onVerificationComplete', (consensusData, comparisonResults) => {
                    if (consensusData && consensusData.events.length > 0) {
                        // „Ç≥„É≥„Çª„É≥„Çµ„Çπ„Éá„Éº„Çø„Åã„ÇâÊ¥•Ê≥¢‰∫àÊ∏¨ÂÆüË°å
                        consensusData.events.forEach(async (event) => {
                            try {
                                const prediction = await this.tsunamiPredictionEngine.predictTsunami(event);
                                
                                if (prediction.probability > 0.1 && prediction.predictions.length > 0) {
                                    console.log(`üîÆ È´òÁ≤æÂ∫¶Ê¥•Ê≥¢‰∫àÊ∏¨ÂÆå‰∫Ü: ÊúÄÂ§ßÊ≥¢È´ò ${Math.max(...prediction.predictions.map(p => p.waveHeight)).toFixed(2)}m`);
                                    
                                    // ‰∫àÊ∏¨ÁµêÊûú„ÇíË≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Å´ÈÄÅ‰ø°
                                    this.processPredictionAlert(prediction);
                                }
                            } catch (error) {
                                console.error('‚ùå Ê¥•Ê≥¢‰∫àÊ∏¨„Ç®„É©„Éº:', error);
                            }
                        });
                    }
                });
                
                // Áõ∏ÈÅïÊ§úÂá∫ÊôÇ„ÅÆÈÄöÁü•
                this.multiSiteVerification.on('onDiscrepancyDetected', (verification) => {
                    console.warn('‚ö†Ô∏è „Éá„Éº„Çø„ÇΩ„Éº„ÇπÈñì„ÅÆÁõ∏ÈÅï„ÇíÊ§úÂá∫:', verification);
                    
                    // UI „Å´Ë≠¶ÂëäË°®Á§∫
                    this.showDataDiscrepancyWarning(verification);
                });
                
                // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„ÅÆÁ∑äÊÄ•‰∫ãÊÖã„ÇíÈÅøÈõ£Ë™òÂ∞é„Å´ÈÄ£Êê∫
                this.tsunamiAlertSystem.on('onEmergency', (emergencyData) => {
                    if (emergencyData.active) {
                        this.activateEvacuationGuidance();
                    }
                });
            }
            
            /**
             * Á∑äÊÄ•ÂØæÂøú„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã (60%ÂÆüÁî®Ê©üËÉΩ„ÅÆÈáçË¶ÅË¶ÅÁ¥†)
             */
            startEmergencyResponseSystem() {
                console.log('üö® Á∑äÊÄ•ÂØæÂøú„ÉªÈÅøÈõ£Ë™òÂ∞é„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã');
                
                // „É™„Ç¢„É´„Çø„Ç§„É†Ê¥•Ê≥¢Áõ£Ë¶ñÂº∑Âåñ
                this.enhanceRealTimeMonitoring();
                
                // Ëá™ÂãïÈÅøÈõ£ÁµåË∑ØÊ°àÂÜÖÊ∫ñÂÇô
                this.prepareEvacuationRoutes();
                
                // Á∑äÊÄ•ÈÄ£Áµ°Á∂≤Ê∫ñÂÇô
                this.prepareEmergencyContacts();
                
                // ‰ΩçÁΩÆÊÉÖÂ†±„Éô„Éº„ÇπË≠¶Âëä
                this.enableLocationBasedAlerts();
                
                console.log('‚úÖ Á∑äÊÄ•ÂØæÂøú„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü');
            }
            
            /**
             * „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñÂº∑Âåñ
             */
            enhanceRealTimeMonitoring() {
                // „Çà„ÇäÈ†ªÁπÅ„Å™„Éá„Éº„ÇøÊõ¥Êñ∞
                setInterval(() => {
                    this.checkCriticalTsunamiUpdates();
                }, 30000); // 30ÁßíÊØé
                
                // P2PÂú∞ÈúáÊÉÖÂ†±„ÅÆÊ¥•Ê≥¢„É™„Çπ„ÇØÂç≥Â∫ßË©ï‰æ°
                if (this.websocket) {
                    const originalHandler = this.websocket.onmessage;
                    this.websocket.onmessage = async (event) => {
                        if (originalHandler) originalHandler(event);
                        
                        const data = JSON.parse(event.data);
                        if (data.code === 551) {
                            // „É™„Ç¢„É´„Çø„Ç§„É†Ê¥•Ê≥¢„É™„Çπ„ÇØË©ï‰æ°
                            await this.performRealTimeTsunamiAssessment(data);
                        }
                    };
                }
            }
            
            /**
             * „É™„Ç¢„É´„Çø„Ç§„É†Ê¥•Ê≥¢Ë©ï‰æ°
             */
            async performRealTimeTsunamiAssessment(earthquakeData) {
                try {
                    // È´òÁ≤æÂ∫¶‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥„ÅßÂç≥Â∫ß„Å´Ë©ï‰æ°
                    const prediction = await this.tsunamiPredictionEngine.predictTsunami(earthquakeData);
                    
                    if (prediction.probability > 0.3) {
                        console.log('‚ö° È´ò„É™„Çπ„ÇØÊ¥•Ê≥¢„ÅÆÂèØËÉΩÊÄß„ÇíÊ§úÂá∫ - Á∑äÊÄ•Ë©ï‰æ°ÂÆüË°å');
                        
                        // Â§öÂú∞ÁÇπÊ§úË®º„ÅßÁ¢∫Ë™ç
                        await this.multiSiteVerification.performRealtimeVerification(earthquakeData);
                        
                        // È´ò„É™„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ë≠¶Â†±
                        if (prediction.predictions.some(p => p.waveHeight > 1.0)) {
                            this.triggerImmediateTsunamiAlert(prediction);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå „É™„Ç¢„É´„Çø„Ç§„É†Ê¥•Ê≥¢Ë©ï‰æ°„Ç®„É©„Éº:', error);
                }
            }
            
            /**
             * ÈÅøÈõ£ÁµåË∑ØÊ∫ñÂÇô
             */
            prepareEvacuationRoutes() {
                this.evacuationRoutes = {
                    routes: [
                        { name: 'È´òÂè∞ÈÅøÈõ£Ë∑ØA', destination: 'Ê®ôÈ´ò50m‰ª•‰∏ä„ÅÆÈ´òÂè∞', time: 'ÂæíÊ≠©15ÂàÜ' },
                        { name: 'ÈÅøÈõ£„Éì„É´ÔºàÊ¥•Ê≥¢ÈÅøÈõ£„Éì„É´Ôºâ', destination: 'ÊåáÂÆöÈÅøÈõ£„Éì„É´ 3Èöé‰ª•‰∏ä', time: 'ÂæíÊ≠©5ÂàÜ' },
                        { name: 'ÂÜÖÈô∏ÈÅøÈõ£Ë∑Ø', destination: 'Êµ∑Â≤∏„Åã„Çâ2km‰ª•‰∏äÂÜÖÈô∏', time: 'Ëªä20ÂàÜ' }
                    ],
                    currentLocation: null
                };
                
                // ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        this.evacuationRoutes.currentLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        console.log('üìç ÁèæÂú®‰ΩçÁΩÆ„ÇíÂèñÂæó - ÈÅøÈõ£ÁµåË∑Ø„ÇíË®àÁÆó');
                    });
                }
            }
            
            /**
             * ‰ΩçÁΩÆÊÉÖÂ†±„Éô„Éº„ÇπË≠¶Âëä
             */
            enableLocationBasedAlerts() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // Êµ∑Â≤∏„Åã„Çâ„ÅÆË∑ùÈõ¢„ÇíÊé®ÂÆö
                        const coastalDistance = this.estimateCoastalDistance(lat, lon);
                        
                        if (coastalDistance < 5000) { // 5km‰ª•ÂÜÖ
                            console.log('üèñÔ∏è Êµ∑Â≤∏ËøëÂÇç„ÇíÊ§úÂá∫ - Ê¥•Ê≥¢Ë≠¶Â†±ÊÑüÂ∫¶„Çí‰∏ä„Åí„Åæ„Åô');
                            this.tsunamiAlertThreshold = 0.1; // „Çà„Çä‰Ωé„ÅÑÈñæÂÄ§„ÅßË≠¶Â†±
                        }
                        
                        this.userLocation = { lat, lon, coastalDistance };
                    });
                }
            }
            
            /**
             * ÈÅøÈõ£Ë™òÂ∞é„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Éà
             */
            activateEvacuationGuidance() {
                console.log('üö® ÈÅøÈõ£Ë™òÂ∞é„Ç∑„Çπ„ÉÜ„É†ÊúâÂäπÂåñ');
                
                // ÁîªÈù¢„Å´ÈÅøÈõ£ÊÉÖÂ†±„ÇíË°®Á§∫
                this.showEvacuationGuidance();
                
                // Èü≥Â£∞Ê°àÂÜÖÈñãÂßã
                this.startVoiceEvacuationGuidance();
                
                // ÈÅøÈõ£ÁµåË∑Ø„Çí„Éû„ÉÉ„Éó„Å´Ë°®Á§∫
                this.displayEvacuationRoutes();
            }
            
            /**
             * ÈÅøÈõ£ÊÉÖÂ†±Ë°®Á§∫
             */
            showEvacuationGuidance() {
                const guidanceOverlay = document.createElement('div');
                guidanceOverlay.id = 'evacuation-guidance';
                guidanceOverlay.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    width: 350px;
                    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    z-index: 9999;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    animation: evacuationPulse 1s ease-in-out infinite;
                    font-family: Arial, sans-serif;
                `;
                
                guidanceOverlay.innerHTML = `
                    <h2 style="font-size: 20px; margin: 0 0 15px 0;">üö® Á∑äÊÄ•ÈÅøÈõ£ÊåáÁ§∫</h2>
                    <div style="font-size: 16px; margin-bottom: 15px;">
                        <strong>Ê¥•Ê≥¢Ë≠¶Â†±Áô∫‰ª§‰∏≠</strong><br>
                        Áõ¥„Å°„Å´ÈÅøÈõ£„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Êé®Â•®ÈÅøÈõ£ÂÖàÔºö</h3>
                        ${this.evacuationRoutes.routes.map(route => `
                            <div style="margin: 5px 0; font-size: 14px;">
                                üìç ${route.name}<br>
                                &nbsp;&nbsp;&nbsp;&nbsp;${route.destination} (${route.time})
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        background: white;
                        color: #cc0000;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-weight: bold;
                    ">Á¢∫Ë™ç</button>
                `;
                
                // CSS „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ËøΩÂä†
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes evacuationPulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.02); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(guidanceOverlay);
            }
            
            /**
             * Êµ∑Â≤∏„Åã„Çâ„ÅÆË∑ùÈõ¢Êé®ÂÆö
             */
            estimateCoastalDistance(lat, lon) {
                // Êó•Êú¨„ÅÆ‰∏ªË¶ÅÊµ∑Â≤∏Á∑ö„Å®„ÅÆË∑ùÈõ¢„ÇíÁ∞°ÊòìË®àÁÆó
                const coastalPoints = [
                    { lat: 35.6762, lon: 139.6503 }, // Êù±‰∫¨Êπæ
                    { lat: 34.3853, lon: 135.3711 }, // Â§ßÈò™Êπæ
                    { lat: 38.2682, lon: 140.8694 }  // ‰ªôÂè∞Êπæ
                ];
                
                let minDistance = Infinity;
                coastalPoints.forEach(point => {
                    const distance = this.calculateDistance(lat, lon, point.lat, point.lon) * 1000;
                    minDistance = Math.min(minDistance, distance);
                });
                
                return minDistance;
            }
            
            /**
             * Á∑äÊÄ•ÈÄ£Áµ°Á∂≤Ê∫ñÂÇô
             */
            prepareEmergencyContacts() {
                this.emergencyContacts = {
                    local: {
                        fire: '119',
                        police: '110',
                        coast_guard: '118'
                    },
                    admin: {
                        city_hall: 'Èò≤ÁÅΩË™≤',
                        evacuation_center: 'ÊåáÂÆöÈÅøÈõ£ÊâÄ'
                    },
                    enabled: true
                };
                
                console.log('üìû Á∑äÊÄ•ÈÄ£Áµ°Á∂≤Ê∫ñÂÇôÂÆå‰∫Ü');
            }
            
            /**
             * ÈáçË¶ÅÊ¥•Ê≥¢Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
             */
            async checkCriticalTsunamiUpdates() {
                try {
                    // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç
                    if (this.multiSiteVerification) {
                        const status = this.multiSiteVerification.getSystemStatus();
                        if (status.activeSources < 2) {
                            console.warn('‚ö†Ô∏è ÊúâÂäπ„Éá„Éº„Çø„ÇΩ„Éº„Çπ„Åå‰∏çË∂≥ - ‰ø°È†ºÊÄß‰Ωé‰∏ã');
                        }
                    }
                    
                    // ‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥„ÅÆÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.tsunamiPredictionEngine) {
                        console.log('üß† Ê¥•Ê≥¢‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥Ê≠£Â∏∏Á®ºÂÉç‰∏≠');
                    }
                    
                } catch (error) {
                    console.error('‚ùå ÈáçË¶ÅÊõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                }
            }
            
            /**
             * ‰∫àÊ∏¨Ë≠¶Â†±Âá¶ÁêÜ
             */
            processPredictionAlert(prediction) {
                if (!prediction || !prediction.predictions) return;
                
                // ‰∫àÊ∏¨ÁµêÊûú„ÇíÊ¥•Ê≥¢„Éá„Éº„ÇøÂΩ¢Âºè„Å´Â§âÊèõ
                const alertData = {
                    type: "FeatureCollection",
                    features: prediction.predictions.map(pred => ({
                        type: "Feature",
                        properties: {
                            AREA_CODE: `PRED_${pred.location}`,
                            AREA_NAME: pred.location,
                            STATUS: pred.alertLevel,
                            WAVE_HEIGHT: `${pred.waveHeight}m`,
                            ARRIVAL_TIME: pred.arrivalTime,
                            SOURCE: 'PREDICTION_ENGINE',
                            CONFIDENCE: pred.confidence
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [pred.longitude, pred.latitude]
                        }
                    })),
                    metadata: {
                        source: 'TsunamiPredictionEngine',
                        timestamp: prediction.metadata.predictionTime,
                        algorithm: prediction.metadata.algorithm,
                        confidence: prediction.metadata.confidence
                    }
                };
                
                // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„ÅßÂá¶ÁêÜ
                this.tsunamiAlertSystem.processTsunamiAlert(alertData);
                
                console.log(`üîÆ ‰∫àÊ∏¨Ë≠¶Â†±Âá¶ÁêÜÂÆå‰∫Ü: ${prediction.predictions.length}Âú∞ÁÇπ`);
            }
            
            /**
             * „Éá„Éº„ÇøÁõ∏ÈÅïË≠¶ÂëäË°®Á§∫
             */
            showDataDiscrepancyWarning(verification) {
                const warningElement = document.createElement('div');
                warningElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ff9800;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    z-index: 9998;
                    font-weight: bold;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                `;
                
                warningElement.innerHTML = `
                    ‚ö†Ô∏è „Éá„Éº„Çø„ÇΩ„Éº„ÇπÈñì„ÅßÁõ∏ÈÅï„ÇíÊ§úÂá∫ - Ê§úË®º‰∏≠
                    <button onclick="this.parentElement.remove()" style="
                        background: white;
                        color: #ff9800;
                        border: none;
                        margin-left: 15px;
                        padding: 5px 10px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">√ó</button>
                `;
                
                document.body.appendChild(warningElement);
                
                // 10ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
                setTimeout(() => {
                    if (document.body.contains(warningElement)) {
                        document.body.removeChild(warningElement);
                    }
                }, 10000);
            }
            
            /**
             * Âç≥Â∫ßÊ¥•Ê≥¢Ë≠¶Â†±„Éà„É™„Ç¨„Éº
             */
            triggerImmediateTsunamiAlert(prediction) {
                console.log('üö® Âç≥Â∫ßÊ¥•Ê≥¢Ë≠¶Â†±„Éà„É™„Ç¨„Éº');
                
                // È´òÂÑ™ÂÖàÂ∫¶„Åß„Ç¢„É©„Éº„ÉàË°®Á§∫
                const alertOverlay = document.createElement('div');
                alertOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 0, 0, 0.9);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-family: Arial, sans-serif;
                    animation: urgentFlash 0.5s ease-in-out infinite;
                `;
                
                const maxWaveHeight = Math.max(...prediction.predictions.map(p => p.waveHeight));
                
                alertOverlay.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h1 style="font-size: 60px; margin: 0 0 20px 0;">üö® Á∑äÊÄ•Ê¥•Ê≥¢Ë≠¶Â†±</h1>
                        <h2 style="font-size: 40px; margin: 0 0 30px 0;">ÊúÄÂ§ß‰∫àÊÉ≥Ê≥¢È´ò: ${maxWaveHeight.toFixed(1)}m</h2>
                        <p style="font-size: 24px; margin: 0 0 40px 0;">
                            Áõ¥„Å°„Å´È´òÂè∞„Åæ„Åü„ÅØÊ¥•Ê≥¢ÈÅøÈõ£„Éì„É´„Å´ÈÅøÈõ£„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </p>
                        <div style="font-size: 18px;">
                            <div>‰∫àÊ∏¨‰ø°È†ºÂ∫¶: ${(prediction.metadata.confidence * 100).toFixed(0)}%</div>
                            <div>ÂΩ±ÈüøÂú∞Âüü: ${prediction.predictions.length}ÁÆáÊâÄ</div>
                        </div>
                        <button onclick="this.parentElement.remove()" style="
                            background: white;
                            color: red;
                            border: none;
                            padding: 20px 40px;
                            font-size: 20px;
                            border-radius: 10px;
                            cursor: pointer;
                            margin-top: 30px;
                            font-weight: bold;
                        ">ÈÅøÈõ£ÈñãÂßã - Á¢∫Ë™ç</button>
                    </div>
                `;
                
                // Á∑äÊÄ•„Éï„É©„ÉÉ„Ç∑„É•„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes urgentFlash {
                        0%, 100% { background: rgba(255, 0, 0, 0.9); }
                        50% { background: rgba(255, 100, 100, 0.95); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(alertOverlay);
            }
            
            /**
             * Èü≥Â£∞ÈÅøÈõ£Ê°àÂÜÖÈñãÂßã
             */
            startVoiceEvacuationGuidance() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(
                        'Á∑äÊÄ•ÈÅøÈõ£ÊåáÁ§∫„ÄÇÊ¥•Ê≥¢Ë≠¶Â†±„ÅåÁô∫‰ª§„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁõ¥„Å°„Å´È´òÂè∞„Åæ„Åü„ÅØÊåáÂÆöÈÅøÈõ£Â†¥ÊâÄ„Å´ÈÅøÈõ£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    );
                    utterance.lang = 'ja-JP';
                    utterance.rate = 0.9;
                    utterance.volume = 1.0;
                    
                    speechSynthesis.speak(utterance);
                    
                    console.log('üîä Èü≥Â£∞ÈÅøÈõ£Ê°àÂÜÖÈñãÂßã');
                }
            }
            
            /**
             * ÈÅøÈõ£ÁµåË∑Ø„Éû„ÉÉ„ÉóË°®Á§∫
             */
            displayEvacuationRoutes() {
                if (this.map && this.evacuationRoutes.currentLocation) {
                    // ÈÅøÈõ£ÁµåË∑Ø„ÇíÂú∞Âõ≥‰∏ä„Å´Ë°®Á§∫
                    const currentPos = this.evacuationRoutes.currentLocation;
                    
                    // ÁèæÂú®Âú∞„Éû„Éº„Ç´„Éº
                    L.marker([currentPos.lat, currentPos.lon], {
                        icon: L.divIcon({
                            html: 'üìç',
                            className: 'evacuation-marker',
                            iconSize: [30, 30]
                        })
                    }).addTo(this.map).bindPopup('ÁèæÂú®Âú∞');
                    
                    // ÈÅøÈõ£ÁµåË∑Ø„ÅÆÁ∞°ÊòìË°®Á§∫
                    this.evacuationRoutes.routes.forEach((route, index) => {
                        const routePos = this.getRouteDestination(route, currentPos);
                        if (routePos) {
                            L.marker([routePos.lat, routePos.lon], {
                                icon: L.divIcon({
                                    html: 'üè¢',
                                    className: 'evacuation-destination',
                                    iconSize: [25, 25]
                                })
                            }).addTo(this.map).bindPopup(`${route.name}<br>${route.destination}`);
                        }
                    });
                    
                    console.log('üó∫Ô∏è ÈÅøÈõ£ÁµåË∑Ø„Çí„Éû„ÉÉ„Éó„Å´Ë°®Á§∫');
                }
            }
            
            /**
             * ÈÅøÈõ£ÂÖà‰ΩçÁΩÆÂèñÂæó
             */
            getRouteDestination(route, currentPos) {
                // Á∞°ÊòìÁöÑ„Å™ÈÅøÈõ£ÂÖà‰ΩçÁΩÆ„ÇíÁîüÊàê
                const offset = 0.01; // Á¥Ñ1km
                return {
                    lat: currentPos.lat + offset,
                    lon: currentPos.lon + offset
                };
            }
            
            /**
             * Ê¥•Ê≥¢„Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫Ë®≠ÂÆö
             */
            connectTsunamiSystems() {
                // Ê∞óË±°Â∫ÅXML„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åã„Çâ„ÅÆ„Éá„Éº„Çø„ÇíÊ¥•Ê≥¢„Éû„Éç„Éº„Ç∏„É£„Éº„Å´Ëª¢ÈÄÅ
                this.jmaXmlClient.on('onTsunamiData', (tsunamiData) => {
                    console.log('üì° Ê∞óË±°Â∫ÅXML„Éá„Éº„ÇøÂèó‰ø°:', tsunamiData);
                    
                    // „Éá„Éº„Çø„Çπ„Éà„Ç¢„Å´‰øùÂ≠ò
                    this.tsunamiDataStore.saveCurrentTsunamiData(tsunamiData);
                    
                    // Ê¥•Ê≥¢„Éû„Éç„Éº„Ç∏„É£„Éº„Å´Áä∂ÊÖãÊõ¥Êñ∞
                    this.tsunamiManager.updateTsunamiState(tsunamiData);
                    
                    // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„ÅßÂá¶ÁêÜ
                    this.tsunamiAlertSystem.processTsunamiAlert(tsunamiData);
                });
                
                // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                this.jmaXmlClient.on('onError', (error) => {
                    console.error('üö® Ê∞óË±°Â∫ÅXML„Ç®„É©„Éº - „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶Êó¢Â≠ò„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                    this.fallbackToLocalData();
                });
                
                // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÁ∑äÊÄ•ÈÄöÁü•
                this.tsunamiAlertSystem.on('onEmergency', (emergencyData) => {
                    console.log('üö® Á∑äÊÄ•‰∫ãÊÖãÊ§úÂá∫:', emergencyData);
                    
                    if (emergencyData.active) {
                        this.handleTsunamiEmergency();
                    } else {
                        this.clearTsunamiEmergency();
                    }
                });
                
                // Ê¥•Ê≥¢„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÁä∂ÊÖãÂ§âÂåñ„ÇíË≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Å´ÈÄöÁü•
                this.tsunamiManager.on('onStateChange', (stats, previousState) => {
                    const activeRegions = this.tsunamiManager.getActiveRegions();
                    
                    // GeoJSONÂΩ¢Âºè„ÅßË≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Å´ÈÄÅ‰ø°
                    const alertData = {
                        type: "FeatureCollection",
                        features: activeRegions.map(region => ({
                            type: "Feature",
                            properties: {
                                AREA_CODE: region.areaCode,
                                AREA_NAME: region.areaName,
                                STATUS: region.status,
                                WAVE_HEIGHT: region.waveHeight,
                                ARRIVAL_TIME: region.arrivalTime,
                                SOURCE: 'INTEGRATED_SYSTEM'
                            },
                            geometry: region.geometry
                        })),
                        metadata: {
                            source: 'TsunamiManager',
                            timestamp: new Date().toISOString(),
                            isActive: stats.isActive
                        }
                    };
                    
                    this.tsunamiAlertSystem.processTsunamiAlert(alertData);
                });
            }
            
            /**
             * ÂÆüÁî®ÁöÑ„Å™Ê¥•Ê≥¢Áõ£Ë¶ñÈñãÂßã (ÁèæÂÆüÁöÑÊâãÊ≥ï)
             */
            startRealTsunamiMonitoring() {
                console.log('üì° ÂÆüÁî®Ê¥•Ê≥¢Áõ£Ë¶ñÈñãÂßã (P2PÂú∞ÈúáÊÉÖÂ†±ÈÄ£Êê∫)');
                
                try {
                    // P2PÂú∞ÈúáÊÉÖÂ†±„Åã„ÇâÊ¥•Ê≥¢„É™„Çπ„ÇØÊé®ÂÆö
                    this.enhanceEarthquakeDataWithTsunami();
                    
                    // Yahoo!Â§©Ê∞óRSSÁõ£Ë¶ñ (CORSÂà∂Èôê„Å™„Åó)
                    this.startWeatherRSSMonitoring();
                    
                    // Âú∞Èúá„Éû„Ç∞„Éã„ÉÅ„É•„Éº„ÉâÂü∫Ê∫ñ„Åß„ÅÆÊ¥•Ê≥¢„É™„Çπ„ÇØËá™ÂãïÂà§ÂÆö
                    this.startEarthquakeTsunamiCorrelation();
                    
                    // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíUI „Å´ÂèçÊò†
                    this.updateSystemStatus('monitoring', 'ÂÆüÁî®Áõ£Ë¶ñ‰∏≠');
                    
                } catch (error) {
                    console.error('‚ùå ÂÆüÁî®Áõ£Ë¶ñÈñãÂßãÂ§±Êïó:', error);
                    this.updateSystemStatus('error', 'Áõ£Ë¶ñ„Ç®„É©„Éº');
                }
            }
            
            /**
             * Âú∞ÈúáÊÉÖÂ†±„Åã„ÇâÊ¥•Ê≥¢„É™„Çπ„ÇØÊé®ÂÆö
             */
            enhanceEarthquakeDataWithTsunami() {
                // Êó¢Â≠ò„ÅÆWebSocketÂá¶ÁêÜ„ÇíÊã°Âºµ
                if (this.websocket) {
                    const originalOnMessage = this.websocket.onmessage;
                    
                    this.websocket.onmessage = (event) => {
                        // Êó¢Â≠ò„ÅÆÂú∞ÈúáÂá¶ÁêÜ
                        if (originalOnMessage) originalOnMessage(event);
                        
                        // Ê¥•Ê≥¢„É™„Çπ„ÇØË©ï‰æ°„ÇíËøΩÂä†
                        const data = JSON.parse(event.data);
                        if (data.code === 551) { // Âú∞ÈúáÊÉÖÂ†±
                            this.evaluateTsunamiRiskFromEarthquake(data);
                        }
                    };
                }
            }
            
            /**
             * Âú∞Èúá„Éá„Éº„Çø„Åã„ÇâÊ¥•Ê≥¢„É™„Çπ„ÇØË©ï‰æ°
             */
            evaluateTsunamiRiskFromEarthquake(earthquakeData) {
                const earthquake = earthquakeData.earthquake;
                if (!earthquake) return;
                
                const magnitude = parseFloat(earthquake.hypocenter?.magnitude?.replace('M', '')) || 0;
                const depth = parseInt(earthquake.hypocenter?.depth?.replace('km', '')) || 999;
                const maxIntensity = earthquake.maxScale || 0;
                
                // Ê¥•Ê≥¢Áô∫ÁîüÂèØËÉΩÊÄß„ÅÆÁßëÂ≠¶ÁöÑÂà§ÂÆö
                let tsunamiRisk = 'none';
                let estimatedHeight = '0m';
                
                if (magnitude >= 7.0 && depth <= 100) {
                    if (magnitude >= 8.0) {
                        tsunamiRisk = 'major_warning';
                        estimatedHeight = '3m‰ª•‰∏ä';
                    } else if (magnitude >= 7.5) {
                        tsunamiRisk = 'warning';
                        estimatedHeight = '1-3m';
                    } else {
                        tsunamiRisk = 'advisory';
                        estimatedHeight = '50cm-1m';
                    }
                    
                    // Ê¥•Ê≥¢Ë≠¶Â†±„ÇíÁîüÊàê
                    this.generateTsunamiAlertFromEarthquake(earthquakeData, tsunamiRisk, estimatedHeight);
                }
                
                console.log(`üåä Ê¥•Ê≥¢„É™„Çπ„ÇØË©ï‰æ°: M${magnitude} Ê∑±Â∫¶${depth}km ‚Üí ${tsunamiRisk}`);
            }
            
            /**
             * Âú∞Èúá„Éá„Éº„Çø„Åã„ÇâÊ¥•Ê≥¢Ë≠¶Â†±ÁîüÊàê
             */
            generateTsunamiAlertFromEarthquake(earthquakeData, riskLevel, estimatedHeight) {
                const earthquake = earthquakeData.earthquake;
                const location = earthquake.hypocenter?.name || '‰∏çÊòé';
                
                // ÂΩ±ÈüøÁØÑÂõ≤„ÅÆÊé®ÂÆö (ÈúáÊ∫êÂú∞Âë®Ëæ∫„ÅÆÊ≤øÂ≤∏ÈÉ®)
                const affectedAreas = this.estimateAffectedCoastalAreas(earthquake);
                
                const tsunamiData = {
                    type: "FeatureCollection",
                    features: affectedAreas.map((area, index) => ({
                        type: "Feature",
                        properties: {
                            AREA_CODE: `EQ_${earthquake.time}_${index}`,
                            AREA_NAME: area.name,
                            STATUS: riskLevel,
                            WAVE_HEIGHT: estimatedHeight,
                            ARRIVAL_TIME: this.estimateArrivalTime(earthquake, area),
                            SOURCE: 'EARTHQUAKE_ESTIMATION',
                            EARTHQUAKE_SOURCE: location,
                            CONFIDENCE: area.confidence
                        },
                        geometry: area.geometry
                    })),
                    metadata: {
                        source: 'P2P_EARTHQUAKE_ANALYSIS',
                        timestamp: new Date().toISOString(),
                        isActive: riskLevel !== 'none',
                        baseEarthquake: earthquake
                    }
                };
                
                // Ê¥•Ê≥¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Å´ÈÄÅ‰ø°
                this.tsunamiManager.updateTsunamiState(tsunamiData);
                
                // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Å´ÈÄÅ‰ø°
                this.tsunamiAlertSystem.processTsunamiAlert(tsunamiData);
                
                // „É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•
                this.showNotification(
                    `Âú∞Èúá„Åã„ÇâÊ¥•Ê≥¢„É™„Çπ„ÇØÊ§úÂá∫: ${location} M${earthquake.hypocenter?.magnitude} ‚Üí ${riskLevel}`, 
                    riskLevel === 'major_warning' ? 'error' : 'warning'
                );
            }
            
            /**
             * ÂΩ±ÈüøÊ≤øÂ≤∏ÈÉ®Êé®ÂÆö
             */
            estimateAffectedCoastalAreas(earthquake) {
                const hypocenter = earthquake.hypocenter;
                if (!hypocenter?.latitude || !hypocenter?.longitude) {
                    return [];
                }
                
                const epicenterLat = parseFloat(hypocenter.latitude);
                const epicenterLon = parseFloat(hypocenter.longitude);
                const magnitude = parseFloat(hypocenter.magnitude?.replace('M', '')) || 0;
                
                // Êó•Êú¨„ÅÆ‰∏ªË¶ÅÊ≤øÂ≤∏ÈÉ®„Å®Ë∑ùÈõ¢Ë®àÁÆó
                const coastalAreas = [
                    { name: 'ÂåóÊµ∑ÈÅìÂ§™Âπ≥Ê¥ãÊ≤øÂ≤∏', lat: 42.5, lon: 144.0, code: '191' },
                    { name: '‰∏âÈô∏Ê≤øÂ≤∏', lat: 39.5, lon: 141.5, code: '211' },
                    { name: 'ÊàøÁ∑èÂçäÂ≥∂', lat: 35.5, lon: 140.5, code: '251' },
                    { name: 'Êù±Êµ∑Ê≤øÂ≤∏', lat: 34.5, lon: 137.5, code: '301' },
                    { name: 'Á¥Ä‰ºäÂçäÂ≥∂', lat: 33.5, lon: 136.0, code: '401' },
                    { name: 'ÂõõÂõΩÊ≤øÂ≤∏', lat: 33.0, lon: 134.0, code: '501' },
                    { name: '‰πùÂ∑ûÊù±Â≤∏', lat: 32.0, lon: 131.5, code: '601' }
                ];
                
                return coastalAreas.filter(area => {
                    const distance = this.calculateDistance(epicenterLat, epicenterLon, area.lat, area.lon);
                    const maxDistance = magnitude >= 8.0 ? 1000 : magnitude >= 7.5 ? 500 : 200;
                    
                    if (distance <= maxDistance) {
                        area.confidence = Math.max(0.1, 1 - (distance / maxDistance));
                        area.geometry = this.createCoastalGeometry(area);
                        return true;
                    }
                    return false;
                });
            }
            
            /**
             * Ë∑ùÈõ¢Ë®àÁÆó (km)
             */
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Âú∞ÁêÉ„ÅÆÂçäÂæÑ
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            /**
             * Ê≤øÂ≤∏ÈÉ®„Ç∏„Ç™„É°„Éà„É™‰ΩúÊàê
             */
            createCoastalGeometry(area) {
                const lat = area.lat;
                const lon = area.lon;
                const offset = 0.5;
                
                return {
                    type: "Polygon",
                    coordinates: [[
                        [lon - offset, lat - offset],
                        [lon + offset, lat - offset],
                        [lon + offset, lat + offset],
                        [lon - offset, lat + offset],
                        [lon - offset, lat - offset]
                    ]]
                };
            }
            
            /**
             * Ê¥•Ê≥¢Âà∞ÈÅîÊôÇÈñìÊé®ÂÆö
             */
            estimateArrivalTime(earthquake, area) {
                // Á∞°ÊòìÁöÑ„Å™Ê¥•Ê≥¢ÈÄüÂ∫¶Ë®àÁÆó (Á¥Ñ200km/h)
                const distance = this.calculateDistance(
                    parseFloat(earthquake.hypocenter?.latitude || 0),
                    parseFloat(earthquake.hypocenter?.longitude || 0),
                    area.lat,
                    area.lon
                );
                
                const hours = distance / 200; // Ê¥•Ê≥¢ÈÄüÂ∫¶Á¥Ñ200km/h
                const arrivalTime = new Date();
                arrivalTime.setMinutes(arrivalTime.getMinutes() + (hours * 60));
                
                if (hours < 0.5) {
                    return 'Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö';
                } else if (hours < 1) {
                    return `Á¥Ñ${Math.round(hours * 60)}ÂàÜÂæå`;
                } else {
                    return `Á¥Ñ${Math.round(hours)}ÊôÇÈñìÂæå`;
                }
            }
            
            /**
             * Â§©Ê∞óRSS„É¢„Éã„Çø„É™„É≥„Ç∞ÈñãÂßã
             */
            startWeatherRSSMonitoring() {
                // Yahoo!Â§©Ê∞ó„ÅÆÊ¥•Ê≥¢ÊÉÖÂ†±RSS (ÂÖ¨ÈñãAPI)
                const rssUrl = 'https://rss-weather.yahoo.co.jp/rss/days/tsunami.xml';
                
                setInterval(async () => {
                    try {
                        // „Éó„É≠„Ç≠„Ç∑ÁµåÁî±„ÅßRSSÂèñÂæó
                        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`);
                        const data = await response.json();
                        
                        if (data.contents) {
                            this.parseWeatherRSS(data.contents);
                        }
                    } catch (error) {
                        console.log('üå§Ô∏è Â§©Ê∞óRSSÂèñÂæó„Çπ„Ç≠„ÉÉ„Éó („Ç™„Éó„Ç∑„Éß„É≥Ê©üËÉΩ)');
                    }
                }, 300000); // 5ÂàÜÈñìÈöî
            }
            
            /**
             * Â§©Ê∞óRSSËß£Êûê
             */
            parseWeatherRSS(rssText) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(rssText, 'text/xml');
                    const items = xmlDoc.querySelectorAll('item');
                    
                    items.forEach(item => {
                        const title = item.querySelector('title')?.textContent || '';
                        const description = item.querySelector('description')?.textContent || '';
                        
                        if (title.includes('Ê¥•Ê≥¢') || description.includes('Ê¥•Ê≥¢')) {
                            console.log('üåä RSSÊ¥•Ê≥¢ÊÉÖÂ†±Ê§úÂá∫:', title);
                            this.showNotification(`Â§ñÈÉ®RSS: ${title}`, 'info');
                        }
                    });
                } catch (error) {
                    console.log('RSSËß£Êûê„Çπ„Ç≠„ÉÉ„Éó');
                }
            }
            
            /**
             * „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ
             */
            fallbackToLocalData() {
                console.log('üîÑ Ê¥•Ê≥¢Áõ£Ë¶ñ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„ÉâËµ∑Âãï');
                
                // Êó¢Â≠ò„ÅÆ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                this.tsunamiManager.startPeriodicUpdate();
                
                // „É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•
                this.showNotification('Ê∞óË±°Â∫Å„Å®„ÅÆÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅßÁõ£Ë¶ñ„ÇíÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÄÇ', 'warning');
                
                // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞
                this.updateSystemStatus('fallback', '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁõ£Ë¶ñ‰∏≠');
            }
            
            /**
             * Ê¥•Ê≥¢UIÁµ±Âêà
             */
            integrateTsunamiUI() {
                // Êó¢Â≠ò„ÅÆUI„Å´ÂÆüÁî®Ê©üËÉΩ„ÇíËøΩÂä†
                this.addPracticalTsunamiControls();
                
                // „Éá„Éº„ÇøÂ±•Ê≠¥„Éì„É•„Éº„Ç¢„Éº„ÇíËøΩÂä†
                this.addTsunamiHistoryViewer();
                
                // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíËøΩÂä†
                this.addTsunamiSystemStatus();
            }
            
            /**
             * ÂÆüÁî®Ê¥•Ê≥¢„Ç≥„É≥„Éà„É≠„Éº„É´ËøΩÂä†
             */
            addPracticalTsunamiControls() {
                const tsunamiActionsContainer = document.querySelector('.tsunami-actions');
                if (!tsunamiActionsContainer) return;
                
                // Èü≥Â£∞ON/OFFÂàá„ÇäÊõø„Åà
                const soundToggle = document.createElement('button');
                soundToggle.className = 'action-btn';
                soundToggle.id = 'tsunami-sound-toggle-practical';
                soundToggle.innerHTML = 'üîä Ë≠¶Â†±Èü≥ ON';
                soundToggle.addEventListener('click', () => {
                    const enabled = this.tsunamiAlertSystem.toggleSound();
                    soundToggle.innerHTML = `${enabled ? 'üîä' : 'üîá'} Ë≠¶Â†±Èü≥ ${enabled ? 'ON' : 'OFF'}`;
                });
                
                // Â±•Ê≠¥„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                const exportButton = document.createElement('button');
                exportButton.className = 'action-btn';
                exportButton.innerHTML = 'üìÅ Â±•Ê≠¥„Ç®„ÇØ„Çπ„Éù„Éº„Éà';
                exportButton.addEventListener('click', () => {
                    this.tsunamiDataStore.exportData('json');
                    this.showNotification('Ê¥•Ê≥¢Â±•Ê≠¥„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
                });
                
                // Á∑äÊÄ•„ÉÜ„Çπ„Éà
                const emergencyTestButton = document.createElement('button');
                emergencyTestButton.className = 'action-btn';
                emergencyTestButton.style.background = 'linear-gradient(145deg, #dc3545, #c82333)';
                emergencyTestButton.innerHTML = 'üö® Á∑äÊÄ•„ÉÜ„Çπ„Éà';
                emergencyTestButton.addEventListener('click', () => {
                    this.runEmergencyTest();
                });
                
                tsunamiActionsContainer.appendChild(soundToggle);
                tsunamiActionsContainer.appendChild(exportButton);
                tsunamiActionsContainer.appendChild(emergencyTestButton);
            }
            
            /**
             * Ê¥•Ê≥¢Â±•Ê≠¥„Éì„É•„Éº„Ç¢„ÉºËøΩÂä†
             */
            addTsunamiHistoryViewer() {
                const rightPanel = document.querySelector('.right-panel');
                if (!rightPanel) return;
                
                const historySection = document.createElement('div');
                historySection.className = 'monitoring-section';
                historySection.innerHTML = `
                    <div class="monitoring-title">üìä Ê¥•Ê≥¢Â±•Ê≠¥</div>
                    <div id="tsunami-history-container" style="
                        max-height: 200px;
                        overflow-y: auto;
                        font-size: 12px;
                    ">
                        <div id="tsunami-history-loading">Â±•Ê≠¥Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                `;
                
                rightPanel.appendChild(historySection);
                
                // Â±•Ê≠¥„Éá„Éº„Çø„ÇíÂÆöÊúüÊõ¥Êñ∞
                this.updateTsunamiHistory();
                setInterval(() => this.updateTsunamiHistory(), 30000);
            }
            
            /**
             * „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºËøΩÂä†
             */
            addTsunamiSystemStatus() {
                const performanceSection = document.querySelector('.performance-stats');
                if (!performanceSection) return;
                
                const statusIndicator = document.createElement('div');
                statusIndicator.id = 'tsunami-system-status';
                statusIndicator.className = 'stat-item';
                statusIndicator.innerHTML = `
                    <div class="stat-value" id="tsunami-status-value">Ê∫ñÂÇô‰∏≠</div>
                    <div class="stat-label">Ê¥•Ê≥¢Áõ£Ë¶ñ</div>
                `;
                
                performanceSection.appendChild(statusIndicator);
            }
            
            /**
             * „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊõ¥Êñ∞
             */
            updateSystemStatus(status, message) {
                const statusElement = document.getElementById('tsunami-status-value');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `stat-value status-${status}`;
                }
                
                // CSSËøΩÂä†
                if (!document.getElementById('tsunami-status-styles')) {
                    const style = document.createElement('style');
                    style.id = 'tsunami-status-styles';
                    style.textContent = `
                        .status-monitoring { color: #28a745; }
                        .status-fallback { color: #ffc107; }
                        .status-error { color: #dc3545; }
                        .status-emergency { color: #dc3545; animation: blink 1s infinite; }
                        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            /**
             * Ê¥•Ê≥¢Â±•Ê≠¥Êõ¥Êñ∞
             */
            updateTsunamiHistory() {
                const historyContainer = document.getElementById('tsunami-history-container');
                if (!historyContainer) return;
                
                try {
                    const history = this.tsunamiDataStore.getHistory({ limit: 10 });
                    
                    if (history.length === 0) {
                        historyContainer.innerHTML = '<div style="color: #666;">Â±•Ê≠¥„Éá„Éº„Çø„Å™„Åó</div>';
                        return;
                    }
                    
                    const historyHTML = history.map(entry => {
                        const time = new Date(entry.timestamp).toLocaleString();
                        const level = entry.metadata.highestLevel || 'none';
                        const regions = entry.metadata.activeRegions || 0;
                        
                        const levelColors = {
                            'major_warning': '#8B0000',
                            'warning': '#FF0000',
                            'advisory': '#FFD700',
                            'forecast': '#90EE90',
                            'none': '#666'
                        };
                        
                        return `
                            <div style="
                                padding: 8px;
                                border-left: 3px solid ${levelColors[level] || '#666'};
                                margin: 5px 0;
                                background: rgba(255,255,255,0.05);
                            ">
                                <div style="font-weight: bold;">${time}</div>
                                <div>„É¨„Éô„É´: ${level} (${regions}Âú∞Âüü)</div>
                            </div>
                        `;
                    }).join('');
                    
                    historyContainer.innerHTML = historyHTML;
                    
                } catch (error) {
                    console.error('Â±•Ê≠¥Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                    historyContainer.innerHTML = '<div style="color: #dc3545;">Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>';
                }
            }
            
            /**
             * Á∑äÊÄ•‰∫ãÊÖãÂá¶ÁêÜ
             */
            handleTsunamiEmergency() {
                console.log('üö® Ê¥•Ê≥¢Á∑äÊÄ•‰∫ãÊÖãÂá¶ÁêÜÈñãÂßã');
                
                // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÁ∑äÊÄ•„É¢„Éº„Éâ„Å´
                this.updateSystemStatus('emergency', 'üö® Ê¥•Ê≥¢Á∑äÊÄ•Ë≠¶Â†±');
                
                // Âú∞Âõ≥„ÇíÊ¥•Ê≥¢‰∏≠ÂøÉÈÉ®„Å´ÁßªÂãï
                const activeRegions = this.tsunamiManager.getActiveRegions();
                if (activeRegions.length > 0) {
                    const firstRegion = activeRegions[0];
                    // Á∞°ÊòìÁöÑ„Å´Êó•Êú¨‰∏≠Â§ÆÈÉ®„Å´„Éï„Ç©„Éº„Ç´„Çπ
                    this.map.setView([36.0, 140.0], 6);
                }
                
                // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁµ±Ë®à„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Å¶Á∑äÊÄ•ÊÉÖÂ†±„ÇíË°®Á§∫
                this.pauseNormalOperations();
            }
            
            /**
             * Á∑äÊÄ•Áä∂ÊÖãËß£Èô§
             */
            clearTsunamiEmergency() {
                console.log('‚úÖ Ê¥•Ê≥¢Á∑äÊÄ•Áä∂ÊÖãËß£Èô§');
                
                // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
                this.updateSystemStatus('monitoring', 'Ê¥•Ê≥¢Áõ£Ë¶ñ‰∏≠');
                
                // ÈÄöÂ∏∏ÈÅãËª¢„Å´Âæ©Â∏∞
                this.resumeNormalOperations();
            }
            
            /**
             * Á∑äÊÄ•„ÉÜ„Çπ„ÉàÂÆüË°å
             */
            runEmergencyTest() {
                const confirmed = confirm('Ê¥•Ê≥¢Á∑äÊÄ•Ë≠¶Â†±„ÅÆ„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\nÈü≥Â£∞„Å®„Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥„Åå‰ΩúÂãï„Åó„Åæ„Åô„ÄÇ');
                
                if (confirmed) {
                    console.log('üß™ Ê¥•Ê≥¢Á∑äÊÄ•„ÉÜ„Çπ„ÉàÂÆüË°å');
                    
                    // „ÉÜ„Çπ„ÉàÁî®Ê¥•Ê≥¢„Éá„Éº„Çø„Çí‰ΩúÊàê
                    const testTsunamiData = {
                        type: "FeatureCollection",
                        features: [{
                            type: "Feature",
                            properties: {
                                AREA_CODE: "TEST001",
                                AREA_NAME: "„ÉÜ„Çπ„ÉàÂú∞Âüü",
                                STATUS: "major_warning",
                                WAVE_HEIGHT: "10m‰ª•‰∏ä",
                                ARRIVAL_TIME: "„ÉÜ„Çπ„Éà‰∏≠",
                                SOURCE: "EMERGENCY_TEST"
                            },
                            geometry: {
                                type: "Polygon",
                                coordinates: [[[140.0, 35.0], [141.0, 35.0], [141.0, 36.0], [140.0, 36.0], [140.0, 35.0]]]
                            }
                        }],
                        metadata: {
                            source: 'EMERGENCY_TEST',
                            timestamp: new Date().toISOString(),
                            isActive: true
                        }
                    };
                    
                    // Ë≠¶Â†±„Ç∑„Çπ„ÉÜ„É†„Åß„ÉÜ„Çπ„ÉàÂá¶ÁêÜ
                    this.tsunamiAlertSystem.processTsunamiAlert(testTsunamiData);
                    
                    // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßËß£Èô§
                    setTimeout(() => {
                        this.tsunamiAlertSystem.clearAllAlerts();
                        this.showNotification('Á∑äÊÄ•„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
                    }, 10000);
                }
            }
            
            /**
             * ÈÄöÂ∏∏ÈÅãËª¢‰∏ÄÊôÇÂÅúÊ≠¢
             */
            pauseNormalOperations() {
                // ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈùûÈáçË¶Å„Å™Âá¶ÁêÜ„ÇíÂÅúÊ≠¢
                console.log('‚è∏Ô∏è ÈÄöÂ∏∏ÈÅãËª¢‰∏ÄÊôÇÂÅúÊ≠¢ÔºàÁ∑äÊÄ•„É¢„Éº„ÉâÔºâ');
            }
            
            /**
             * ÈÄöÂ∏∏ÈÅãËª¢Âæ©Â∏∞
             */
            resumeNormalOperations() {
                // ‰∏ÄÊôÇÂÅúÊ≠¢„Åó„ÅüÂá¶ÁêÜ„ÇíÂÜçÈñã
                console.log('‚ñ∂Ô∏è ÈÄöÂ∏∏ÈÅãËª¢Âæ©Â∏∞');
            }
            
            /**
             * ÊóßÊ¥•Ê≥¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó (‰∫íÊèõÊÄßÁ∂≠ÊåÅ)
             */
            setupTsunamiManager() {
                console.log('üåä Ê¥•Ê≥¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÈñãÂßã');
                
                // Áä∂ÊÖãÂ§âÂåñ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                this.tsunamiManager.on('onStateChange', (stats, previousState) => {
                    console.log('üîÑ Ê¥•Ê≥¢Áä∂ÊÖãÂ§âÂåñ:', stats);
                    this.handleTsunamiStateChange(stats);
                });
                
                // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                this.tsunamiManager.on('onError', (error) => {
                    console.error('üö® Ê¥•Ê≥¢ÁÆ°ÁêÜ„Ç®„É©„Éº:', error);
                    this.handleTsunamiError(error);
                });
                
                // ÊâãÂãïÊõ¥Êñ∞„Éú„Çø„É≥„ÅÆËøΩÂä† (30%ÁâàÊ©üËÉΩ)
                this.addTsunamiUpdateButton();
                
                // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆËøΩÂä†
                this.addTsunamiSimulationControls();
                
                // ÂÆöÊúüÊõ¥Êñ∞ÈñãÂßã
                this.tsunamiManager.startPeriodicUpdate();
                
                console.log('‚úÖ Ê¥•Ê≥¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
            }
            
            /**
             * Ê¥•Ê≥¢Áä∂ÊÖãÂ§âÂåñÂá¶ÁêÜ
             */
            handleTsunamiStateChange(stats) {
                // „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ„Éë„Éç„É´Êõ¥Êñ∞
                const activeRegions = this.tsunamiManager.getActiveRegions();
                
                // Êó¢Â≠ò„ÅÆË°®Á§∫Èñ¢Êï∞„ÇíÊ¥ªÁî®
                updateTsunamiDisplay(activeRegions);
                updateTsunamiRegionsPanel(activeRegions);
                
                // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
                this.updateTsunamiStatistics(stats);
                
                // Âú∞Âõ≥„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
                this.updateTsunamiLayers(activeRegions);
            }
            
            /**
             * Ê¥•Ê≥¢„Ç®„É©„ÉºÂá¶ÁêÜ
             */
            handleTsunamiError(error) {
                // „Ç®„É©„ÉºÈÄöÁü•„ÇíÂè≥‰∏ä„Å´Ë°®Á§∫
                this.showNotification(`Ê¥•Ê≥¢„Éá„Éº„ÇøÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`, 'error');
            }
            
            /**
             * Ê¥•Ê≥¢ÊâãÂãïÊõ¥Êñ∞„Éú„Çø„É≥ËøΩÂä†
             */
            addTsunamiUpdateButton() {
                const tsunamiActionsContainer = document.querySelector('.tsunami-actions');
                if (!tsunamiActionsContainer) return;
                
                const updateButton = document.createElement('button');
                updateButton.className = 'action-btn';
                updateButton.id = 'tsunami-manual-update';
                updateButton.innerHTML = 'üîÑ ÊâãÂãïÊõ¥Êñ∞';
                updateButton.addEventListener('click', () => this.manualTsunamiUpdate());
                
                tsunamiActionsContainer.appendChild(updateButton);
            }
            
            /**
             * Ê¥•Ê≥¢ÊâãÂãïÊõ¥Êñ∞ÂÆüË°å
             */
            async manualTsunamiUpdate() {
                console.log('üîÑ Ê¥•Ê≥¢ÊâãÂãïÊõ¥Êñ∞ÈñãÂßã');
                
                const updateButton = document.getElementById('tsunami-manual-update');
                if (updateButton) {
                    updateButton.disabled = true;
                    updateButton.innerHTML = 'üîÑ Êõ¥Êñ∞‰∏≠...';
                }
                
                try {
                    const result = await this.tsunamiManager.manualUpdate();
                    
                    if (result.success) {
                        this.showNotification('Ê¥•Ê≥¢ÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    } else {
                        this.showNotification(`Ê¥•Ê≥¢Êõ¥Êñ∞Â§±Êïó: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Ê¥•Ê≥¢ÊâãÂãïÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                    this.showNotification('Ê¥•Ê≥¢Êõ¥Êñ∞„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                } finally {
                    if (updateButton) {
                        updateButton.disabled = false;
                        updateButton.innerHTML = 'üîÑ ÊâãÂãïÊõ¥Êñ∞';
                    }
                }
            }
            
            /**
             * Ê¥•Ê≥¢Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
             */
            updateTsunamiStatistics(stats) {
                // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éë„Éç„É´„Å´Ê¥•Ê≥¢Áµ±Ë®à„ÇíËøΩÂä†
                const performanceSection = document.querySelector('.performance-stats');
                if (performanceSection) {
                    let tsunamiStat = document.getElementById('tsunami-stat');
                    if (!tsunamiStat) {
                        tsunamiStat = document.createElement('div');
                        tsunamiStat.id = 'tsunami-stat';
                        tsunamiStat.className = 'stat-item';
                        performanceSection.appendChild(tsunamiStat);
                    }
                    
                    tsunamiStat.innerHTML = `
                        <div class="stat-value">${stats.totalActive}</div>
                        <div class="stat-label">Ê¥•Ê≥¢Âú∞Âüü</div>
                    `;
                }
            }
            
            /**
             * Ê¥•Ê≥¢„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
             */
            updateTsunamiLayers(activeRegions) {
                // GeoJSONÂΩ¢Âºè„Å´Â§âÊèõ
                const tsunamiGeoJSON = {
                    type: "FeatureCollection",
                    features: activeRegions.map(region => ({
                        type: "Feature",
                        properties: {
                            AREA_CODE: region.areaCode,
                            AREA_NAME: region.areaName,
                            STATUS: region.status,
                            WAVE_HEIGHT: region.waveHeight,
                            ARRIVAL_TIME: region.arrivalTime
                        },
                        geometry: region.geometry
                    }))
                };
                
                // Êó¢Â≠ò„ÅÆÊ¥•Ê≥¢„É¨„Ç§„É§„ÉºÂá¶ÁêÜ„ÇíÊ¥ªÁî®
                if (activeRegions.length === 0) {
                    // Ê¥•Ê≥¢„Éá„Éº„Çø„Å™„Åó„ÅÆÂ†¥Âêà
                    if (this.tsunamiLayers) {
                        this.tsunamiLayers.forEach(layer => {
                            if (layer.layer && this.map) {
                                this.map.removeLayer(layer.layer);
                            }
                        });
                        this.tsunamiLayers = [];
                    }
                    
                    if (this.tsunamiLegend && this.map) {
                        this.map.removeControl(this.tsunamiLegend);
                        this.tsunamiLegend = null;
                    }
                } else {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê¥•Ê≥¢„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊó¢Â≠ò„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÅßÊèèÁîª
                    // „Åì„ÅÆÈÉ®ÂàÜ„ÅØÊó¢Â≠ò„ÅÆaddTsunamiCoastlines„É°„ÇΩ„ÉÉ„Éâ„ÇíÊ¥ªÁî®
                }
            }
            
            /**
             * „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç≥„É≥„Éà„É≠„Éº„É´ËøΩÂä†
             */
            addTsunamiSimulationControls() {
                const tsunamiActionsContainer = document.querySelector('.tsunami-actions');
                if (!tsunamiActionsContainer) return;
                
                // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÈÅ∏Êäû„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ
                const simulationSelect = document.createElement('select');
                simulationSelect.id = 'tsunami-simulation-select';
                simulationSelect.className = 'simulation-select';
                
                const scenarios = this.tsunamiManager.simulationMode.scenarios;
                Object.keys(scenarios).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = scenarios[key].name;
                    simulationSelect.appendChild(option);
                });
                
                // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å„Éú„Çø„É≥
                const simulationButton = document.createElement('button');
                simulationButton.className = 'action-btn simulation-btn';
                simulationButton.id = 'tsunami-simulation-run';
                simulationButton.innerHTML = 'üé¨ „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥';
                simulationButton.addEventListener('click', () => this.runTsunamiSimulation());
                
                // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢„Éú„Çø„É≥
                const stopButton = document.createElement('button');
                stopButton.className = 'action-btn stop-btn';
                stopButton.id = 'tsunami-simulation-stop';
                stopButton.innerHTML = 'üõë ÂÅúÊ≠¢';
                stopButton.style.display = 'none';
                stopButton.addEventListener('click', () => this.stopTsunamiSimulation());
                
                tsunamiActionsContainer.appendChild(simulationSelect);
                tsunamiActionsContainer.appendChild(simulationButton);
                tsunamiActionsContainer.appendChild(stopButton);
                
                // CSSËøΩÂä†
                const style = document.createElement('style');
                style.textContent = `
                    .simulation-select {
                        padding: 8px 12px;
                        margin: 5px;
                        border: 1px solid #555;
                        border-radius: 4px;
                        background: #2a2a2a;
                        color: #fff;
                        font-size: 12px;
                    }
                    .simulation-btn {
                        background: linear-gradient(145deg, #ff6b6b, #ee5a52);
                    }
                    .stop-btn {
                        background: linear-gradient(145deg, #6c757d, #5a6268);
                    }
                `;
                document.head.appendChild(style);
            }
            
            /**
             * Ê¥•Ê≥¢„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
             */
            runTsunamiSimulation() {
                const selectElement = document.getElementById('tsunami-simulation-select');
                const runButton = document.getElementById('tsunami-simulation-run');
                const stopButton = document.getElementById('tsunami-simulation-stop');
                
                if (!selectElement) return;
                
                const scenarioKey = selectElement.value;
                
                try {
                    const result = this.tsunamiManager.runSimulation(scenarioKey);
                    
                    if (result.success) {
                        this.showNotification(`„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã: ${result.scenario}`, 'success');
                        
                        // „Éú„Çø„É≥Áä∂ÊÖãÂ§âÊõ¥
                        runButton.style.display = 'none';
                        stopButton.style.display = 'inline-block';
                        selectElement.disabled = true;
                    }
                } catch (error) {
                    console.error('„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å„Ç®„É©„Éº:', error);
                    this.showNotification(`„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            }
            
            /**
             * Ê¥•Ê≥¢„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢
             */
            stopTsunamiSimulation() {
                const runButton = document.getElementById('tsunami-simulation-run');
                const stopButton = document.getElementById('tsunami-simulation-stop');
                const selectElement = document.getElementById('tsunami-simulation-select');
                
                this.tsunamiManager.stopSimulation();
                
                // „Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
                runButton.style.display = 'inline-block';
                stopButton.style.display = 'none';
                if (selectElement) selectElement.disabled = false;
                
                this.showNotification('„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢', 'info');
            }
            
            /**
             * ÈÄöÁü•Ë°®Á§∫
             */
            showNotification(message, type = 'info') {
                console.log(`üì¢ ÈÄöÁü• (${type}): ${message}`);
                // Á∞°ÊòìÂÆüË£Ö: „Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„ÅÆ„Åø (30%Áâà)
                // Â∞ÜÊù•ÁöÑ„Å´„ÅØUIÈÄöÁü•„ÇíÂÆüË£Ö
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        function updateTsunamiDisplay(activeAreas) {
            const tsunamiPanel = document.querySelector('.tsunami-warning-panel');
            const tsunamiSectionTitle = document.getElementById('tsunami-section-title');
            
            if (activeAreas.length === 0) {
                // Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±„ÅåÂÆåÂÖ®„Å´Ëß£Èô§„Åï„Çå„ÅüÂ†¥Âêà
                if (tsunamiPanel) {
                    tsunamiPanel.style.display = 'none';
                }
                
                // „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´„ÇíÂ§âÊõ¥
                if (tsunamiSectionTitle) {
                    tsunamiSectionTitle.textContent = '‚úÖ Ê¥•Ê≥¢ÊÉÖÂ†±„Å™„Åó';
                    tsunamiSectionTitle.style.color = '#4CAF50';
                }
                
                console.log('üö´ Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±ÂÆåÂÖ®Ëß£Èô§: „Éë„Éç„É´ÈùûË°®Á§∫„Éª„Çø„Ç§„Éà„É´Â§âÊõ¥');
                
            } else {
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
                if (tsunamiPanel) {
                    tsunamiPanel.style.display = 'block';
                }
                
                // „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´„ÇíÂÖÉ„Å´Êàª„Åô
                if (tsunamiSectionTitle) {
                    tsunamiSectionTitle.textContent = 'üåä Ê¥•Ê≥¢Ë≠¶Â†±„ÉªÊ≥®ÊÑèÂ†±';
                    tsunamiSectionTitle.style.color = '';
                }
                
                console.log(`üåä Ê¥•Ê≥¢Ê≥®ÊÑèÂ†±„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${activeAreas.length}Âú∞Âüü`);
            }
        }
        
        function updateTsunamiRegionsPanel(activeAreas) {
            const tsunamiRegionsContainer = document.querySelector('.tsunami-regions');
            if (!tsunamiRegionsContainer) return;
            
            // Êó¢Â≠ò„ÅÆÂú∞Âüü„Ç¢„Ç§„ÉÜ„É†„Çí„ÇØ„É™„Ç¢
            tsunamiRegionsContainer.innerHTML = '';
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Âú∞Âüü„ÅÆ„Åø„ÇíË°®Á§∫
            activeAreas.forEach(feature => {
                const props = feature.properties;
                const regionItem = document.createElement('div');
                regionItem.className = 'region-item advisory';
                regionItem.innerHTML = `
                    <div class="region-name">${props.AREA_NAME}</div>
                    <div class="region-info">
                        <span class="wave-height">${props.WAVE_HEIGHT || '1m'}</span>
                        <span class="arrival-time">${props.ARRIVAL_TIME || 'Êó¢„Å´Âà∞ÈÅî„Å®Êé®ÂÆö'}</span>
                    </div>
                `;
                tsunamiRegionsContainer.appendChild(regionItem);
            });
            
            console.log(`üîÑ „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ„Éë„Éç„É´Êõ¥Êñ∞: ${activeAreas.length}Âú∞ÂüüË°®Á§∫`);
        }
        
        function selectEarthquake(id) {
            const earthquake = window.monitor.earthquakeHistory.find(eq => eq.id === id);
            if (earthquake) {
                window.monitor.updateOverlayInfo(earthquake);
                // Ëá™Âãï„Ç∫„Éº„É†Ë®≠ÂÆö„ÅåÊúâÂäπ„Åã„Å§Â∫ßÊ®ô„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂú∞Âõ≥„ÇíÁßªÂãï
                if (window.monitor.settings.autoZoom && earthquake.latitude && earthquake.longitude) {
                    window.monitor.map.setView([earthquake.latitude, earthquake.longitude], 8);
                    // Âú∞Âõ≥ÁßªÂãïÂæå„Å´‰ΩçÁΩÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºà„Éõ„Éº„É†„Éú„Çø„É≥Ë°®Á§∫„ÅÆ„Åü„ÇÅÔºâ
                    setTimeout(() => {
                        window.monitor.checkMapPosition();
                    }, 100);
                }
                // ÈúáÂ∫¶ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
                window.monitor.showIntensityPopup(earthquake);
                console.log(`üìç Selected earthquake: ${earthquake.location}`);
            }
        }

        function openSettings() {
            window.monitor.showSettingsPanel();
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        document.addEventListener('DOMContentLoaded', () => {
            window.monitor = new ProfessionalEarthquakeMonitor();
        });
        // „Éá„Éê„ÉÉ„Ç∞Áî®Èñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.testBoundaries = () => {
            if (window.monitor) {
                window.monitor.forceBoundaryDisplay();
            } else {
                console.error('‚ùå monitor „ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        };
        
        window.refreshBoundaries = () => {
            if (window.monitor) {
                window.monitor.updateJapanBoundariesForLayer();
                console.log('üîÑ Â¢ÉÁïåÊõ¥Êñ∞„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü');
            } else {
                console.error('‚ùå monitor „ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        };
        
        window.hideTsunami = () => {
            if (window.monitor) {
                // Ê¥•Ê≥¢„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
                if (window.monitor.tsunamiLayers) {
                    window.monitor.tsunamiLayers.forEach(tsunami => {
                        if (tsunami.layer && window.monitor.map.hasLayer(tsunami.layer)) {
                            window.monitor.map.removeLayer(tsunami.layer);
                        }
                    });
                    console.log('üåä Ê¥•Ê≥¢„É¨„Ç§„É§„Éº„Çí‰∏ÄÊôÇÁöÑ„Å´ÈùûË°®Á§∫„Å´„Åó„Åæ„Åó„Åü');
                } else {
                    console.log('‚ö†Ô∏è Ê¥•Ê≥¢„É¨„Ç§„É§„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                // Âú∞Âõ≥‰∏ä„ÅÆ„Åô„Åπ„Å¶„ÅÆGeoJSON„É¨„Ç§„É§„Éº„ÇÇÂâäÈô§ÔºàÊ¥•Ê≥¢„Éá„Éº„ÇøÔºâ
                window.monitor.map.eachLayer(layer => {
                    if (layer instanceof L.GeoJSON) {
                        window.monitor.map.removeLayer(layer);
                        console.log('üóëÔ∏è GeoJSON„É¨„Ç§„É§„Éº„ÇíÂâäÈô§');
                    }
                });
                
                // Â¢ÉÁïå„ÇÇÊõ¥Êñ∞
                setTimeout(() => {
                    window.refreshBoundaries();
                }, 100);
            } else {
                console.error('‚ùå monitor „ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        };
        
        console.log('üõ†Ô∏è „Éá„Éê„ÉÉ„Ç∞„Ç≥„Éû„É≥„ÉâÂà©Áî®ÂèØËÉΩ:');
        console.log('   testBoundaries() - „ÉÜ„Çπ„ÉàÂ¢ÉÁïåË°®Á§∫ÔºàËµ§„ÅÑÂÜÜÔºâ');
        console.log('   refreshBoundaries() - Â¢ÉÁïåÊõ¥Êñ∞ÔºàÁ∑ëËâ≤„ÅÆÂÜÜÔºâ');
        console.log('   hideTsunami() - Ê¥•Ê≥¢„É¨„Ç§„É§„ÉºÈùûË°®Á§∫');
    </script>
</body>
</html>